<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë¦¬ë‹¤ì´ë ‰íŠ¸ ì¶”ì ê¸°</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .test-case { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { background: #d4edda; }
        .failure { background: #f8d7da; }
        .warning { background: #fff3cd; }
        button { padding: 10px; margin: 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ” ë¦¬ë‹¤ì´ë ‰íŠ¸ ë¬¸ì œ ì¶”ì ê¸°</h1>
    
    <div class="test-case">
        <h2>í…ŒìŠ¤íŠ¸ 1: í˜„ì¬ ìœ„ì¹˜ì—ì„œ index.html ì ‘ê·¼ ê°€ëŠ¥ì„±</h2>
        <button onclick="testFileAccessibility()">íŒŒì¼ ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸</button>
        <div id="test1Result"></div>
    </div>

    <div class="test-case">
        <h2>í…ŒìŠ¤íŠ¸ 2: ë‹¤ì–‘í•œ ê²½ë¡œ í‘œí˜„ ë°©ì‹</h2>
        <button onclick="testPathVariations()">ê²½ë¡œ ë³€í˜• í…ŒìŠ¤íŠ¸</button>
        <div id="test2Result"></div>
    </div>

    <div class="test-case">
        <h2>í…ŒìŠ¤íŠ¸ 3: ì‹¤ì œ ë¡œê·¸ì•„ì›ƒ ì‹œë®¬ë ˆì´ì…˜</h2>
        <button onclick="simulateActualLogout()">ë¡œê·¸ì•„ì›ƒ í”Œë¡œìš° ì¬í˜„</button>
        <div id="test3Result"></div>
    </div>

    <div class="test-case">
        <h2>í…ŒìŠ¤íŠ¸ 4: ë¸Œë¼ìš°ì € ì œì•½ì‚¬í•­ í™•ì¸</h2>
        <button onclick="checkBrowserConstraints()">ë¸Œë¼ìš°ì € ì œì•½ ê²€ì‚¬</button>
        <div id="test4Result"></div>
    </div>

    <script>
        // 1. íŒŒì¼ ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸
        async function testFileAccessibility() {
            const result = document.getElementById('test1Result');
            const tests = [];
            
            // í˜„ì¬ ìœ„ì¹˜ ì •ë³´
            const currentLocation = {
                href: window.location.href,
                pathname: window.location.pathname,
                directory: window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'))
            };
            tests.push({ test: 'Current Location', data: currentLocation });
            
            // ë‹¤ì–‘í•œ ë°©ë²•ìœ¼ë¡œ index.html ê²½ë¡œ ìƒì„±
            const pathTests = [
                { method: 'relative', path: 'index.html' },
                { method: 'relative with dot', path: './index.html' },
                { method: 'absolute from root', path: '/src/partners/index.html' },
                { method: 'full URL', path: window.location.origin + '/src/partners/index.html' },
                { method: 'URL constructor', path: new URL('index.html', window.location.href).href }
            ];
            
            for (const test of pathTests) {
                try {
                    const response = await fetch(test.path, { method: 'HEAD' });
                    test.result = {
                        status: response.status,
                        ok: response.ok,
                        statusText: response.statusText,
                        type: response.type,
                        url: response.url
                    };
                } catch (error) {
                    test.result = {
                        error: error.message,
                        stack: error.stack
                    };
                }
                tests.push(test);
            }
            
            result.innerHTML = `<pre>${JSON.stringify(tests, null, 2)}</pre>`;
            
            // ê²°ê³¼ ë¶„ì„
            const accessible = tests.filter(t => t.result && t.result.ok);
            if (accessible.length > 0) {
                result.className = 'success';
                console.log('âœ… index.html ì ‘ê·¼ ê°€ëŠ¥:', accessible);
            } else {
                result.className = 'failure';
                console.error('âŒ index.html ì ‘ê·¼ ë¶ˆê°€');
            }
        }

        // 2. ê²½ë¡œ ë³€í˜• í…ŒìŠ¤íŠ¸
        function testPathVariations() {
            const result = document.getElementById('test2Result');
            const tests = [];
            
            // window.location ê°ì²´ ì¡°ì‘ í…ŒìŠ¤íŠ¸
            const locationTests = [
                {
                    method: 'href setter',
                    code: 'window.location.href = "index.html"',
                    test: () => {
                        try {
                            const newUrl = new URL('index.html', window.location.href);
                            return { wouldNavigateTo: newUrl.href, error: null };
                        } catch (e) {
                            return { wouldNavigateTo: null, error: e.message };
                        }
                    }
                },
                {
                    method: 'replace method',
                    code: 'window.location.replace("index.html")',
                    test: () => {
                        try {
                            const newUrl = new URL('index.html', window.location.href);
                            return { wouldNavigateTo: newUrl.href, error: null };
                        } catch (e) {
                            return { wouldNavigateTo: null, error: e.message };
                        }
                    }
                },
                {
                    method: 'assign method',
                    code: 'window.location.assign("index.html")',
                    test: () => {
                        try {
                            const newUrl = new URL('index.html', window.location.href);
                            return { wouldNavigateTo: newUrl.href, error: null };
                        } catch (e) {
                            return { wouldNavigateTo: null, error: e.message };
                        }
                    }
                },
                {
                    method: 'pathname setter',
                    code: 'window.location.pathname = "/src/partners/index.html"',
                    test: () => {
                        try {
                            const newUrl = new URL(window.location.href);
                            newUrl.pathname = '/src/partners/index.html';
                            return { wouldNavigateTo: newUrl.href, error: null };
                        } catch (e) {
                            return { wouldNavigateTo: null, error: e.message };
                        }
                    }
                }
            ];
            
            locationTests.forEach(test => {
                const result = test.test();
                tests.push({
                    method: test.method,
                    code: test.code,
                    result: result
                });
            });
            
            result.innerHTML = `<pre>${JSON.stringify(tests, null, 2)}</pre>`;
            result.className = 'warning';
        }

        // 3. ì‹¤ì œ ë¡œê·¸ì•„ì›ƒ ì‹œë®¬ë ˆì´ì…˜
        async function simulateActualLogout() {
            const result = document.getElementById('test3Result');
            const steps = [];
            
            // Step 1: ê°€ìƒì˜ authManager.logout() ì‹¤í–‰
            steps.push({
                step: 1,
                action: 'authManager.logout() í˜¸ì¶œ',
                timestamp: new Date().toISOString()
            });
            
            // Supabase auth signOut ì‹œë®¬ë ˆì´ì…˜
            await new Promise(resolve => setTimeout(resolve, 100));
            steps.push({
                step: 2,
                action: 'Supabase signOut ì™„ë£Œ',
                timestamp: new Date().toISOString()
            });
            
            // localStorage ì •ë¦¬ ì‹œë®¬ë ˆì´ì…˜
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.includes('supabase') || key.includes('auth'))) {
                    keysToRemove.push(key);
                }
            }
            steps.push({
                step: 3,
                action: 'localStorage ì •ë¦¬',
                data: { keysFound: keysToRemove.length, keys: keysToRemove },
                timestamp: new Date().toISOString()
            });
            
            // ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹œë„
            steps.push({
                step: 4,
                action: 'ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹œë„',
                timestamp: new Date().toISOString()
            });
            
            // ê° ë°©ë²•ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ í…ŒìŠ¤íŠ¸
            const redirectTests = [
                {
                    method: 'window.location.href = "./index.html"',
                    test: () => window.location.href = './index.html'
                },
                {
                    method: 'window.location.replace("./index.html")',
                    test: () => window.location.replace('./index.html')
                },
                {
                    method: 'window.location = "./index.html"',
                    test: () => window.location = './index.html'
                }
            ];
            
            // ì‹¤ì œë¡œ ì‹¤í–‰í•˜ì§€ ì•Šê³  ì‹œë®¬ë ˆì´ì…˜ë§Œ
            redirectTests.forEach(test => {
                try {
                    // ì‹¤ì œ ë¦¬ë‹¤ì´ë ‰íŠ¸ëŠ” í•˜ì§€ ì•Šê³  URLë§Œ ê³„ì‚°
                    const targetUrl = new URL('./index.html', window.location.href);
                    steps.push({
                        step: 5,
                        method: test.method,
                        wouldRedirectTo: targetUrl.href,
                        success: true
                    });
                } catch (error) {
                    steps.push({
                        step: 5,
                        method: test.method,
                        error: error.message,
                        success: false
                    });
                }
            });
            
            result.innerHTML = `<pre>${JSON.stringify(steps, null, 2)}</pre>`;
            result.className = 'warning';
        }

        // 4. ë¸Œë¼ìš°ì € ì œì•½ì‚¬í•­ í™•ì¸
        function checkBrowserConstraints() {
            const result = document.getElementById('test4Result');
            const constraints = {
                protocol: window.location.protocol,
                isFile: window.location.protocol === 'file:',
                isHTTP: window.location.protocol.startsWith('http'),
                cors: {
                    mode: document.currentScript ? document.currentScript.crossOrigin : 'unknown',
                    credentials: navigator.credentials ? 'available' : 'not available'
                },
                csp: {
                    hasCSP: !!document.querySelector('meta[http-equiv="Content-Security-Policy"]'),
                    directives: null
                },
                sandbox: {
                    isSandboxed: window.self !== window.top,
                    isIframe: window.self !== window.parent
                },
                permissions: {
                    canNavigate: true,
                    canOpenWindows: true,
                    canAccessLocalStorage: true,
                    canAccessSessionStorage: true
                },
                userAgent: {
                    browser: navigator.userAgent,
                    platform: navigator.platform
                }
            };
            
            // CSP ì²´í¬
            const cspMeta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
            if (cspMeta) {
                constraints.csp.directives = cspMeta.getAttribute('content');
            }
            
            // ê¶Œí•œ ì²´í¬
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
            } catch (e) {
                constraints.permissions.canAccessLocalStorage = false;
            }
            
            try {
                sessionStorage.setItem('test', 'test');
                sessionStorage.removeItem('test');
            } catch (e) {
                constraints.permissions.canAccessSessionStorage = false;
            }
            
            // Navigation ê°€ëŠ¥ ì—¬ë¶€
            try {
                const testUrl = new URL('./index.html', window.location.href);
                constraints.permissions.testUrl = testUrl.href;
            } catch (e) {
                constraints.permissions.canNavigate = false;
                constraints.permissions.navigationError = e.message;
            }
            
            result.innerHTML = `<pre>${JSON.stringify(constraints, null, 2)}</pre>`;
            
            // ë¬¸ì œ ì§„ë‹¨
            if (constraints.isFile) {
                result.className = 'failure';
                result.innerHTML += '<p><strong>âš ï¸ ê²½ê³ : file:// í”„ë¡œí† ì½œì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ì¼ë¶€ ë¦¬ë‹¤ì´ë ‰íŠ¸ê°€ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</strong></p>';
            } else {
                result.className = 'success';
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ” ë¦¬ë‹¤ì´ë ‰íŠ¸ ì¶”ì ê¸° ì¤€ë¹„ ì™„ë£Œ');
            console.log('í˜„ì¬ ìœ„ì¹˜:', window.location.href);
        });
    </script>
</body>
</html>