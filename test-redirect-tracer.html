<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>리다이렉트 추적기</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .test-case { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { background: #d4edda; }
        .failure { background: #f8d7da; }
        .warning { background: #fff3cd; }
        button { padding: 10px; margin: 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>🔍 리다이렉트 문제 추적기</h1>
    
    <div class="test-case">
        <h2>테스트 1: 현재 위치에서 index.html 접근 가능성</h2>
        <button onclick="testFileAccessibility()">파일 접근성 테스트</button>
        <div id="test1Result"></div>
    </div>

    <div class="test-case">
        <h2>테스트 2: 다양한 경로 표현 방식</h2>
        <button onclick="testPathVariations()">경로 변형 테스트</button>
        <div id="test2Result"></div>
    </div>

    <div class="test-case">
        <h2>테스트 3: 실제 로그아웃 시뮬레이션</h2>
        <button onclick="simulateActualLogout()">로그아웃 플로우 재현</button>
        <div id="test3Result"></div>
    </div>

    <div class="test-case">
        <h2>테스트 4: 브라우저 제약사항 확인</h2>
        <button onclick="checkBrowserConstraints()">브라우저 제약 검사</button>
        <div id="test4Result"></div>
    </div>

    <script>
        // 1. 파일 접근성 테스트
        async function testFileAccessibility() {
            const result = document.getElementById('test1Result');
            const tests = [];
            
            // 현재 위치 정보
            const currentLocation = {
                href: window.location.href,
                pathname: window.location.pathname,
                directory: window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'))
            };
            tests.push({ test: 'Current Location', data: currentLocation });
            
            // 다양한 방법으로 index.html 경로 생성
            const pathTests = [
                { method: 'relative', path: 'index.html' },
                { method: 'relative with dot', path: './index.html' },
                { method: 'absolute from root', path: '/src/partners/index.html' },
                { method: 'full URL', path: window.location.origin + '/src/partners/index.html' },
                { method: 'URL constructor', path: new URL('index.html', window.location.href).href }
            ];
            
            for (const test of pathTests) {
                try {
                    const response = await fetch(test.path, { method: 'HEAD' });
                    test.result = {
                        status: response.status,
                        ok: response.ok,
                        statusText: response.statusText,
                        type: response.type,
                        url: response.url
                    };
                } catch (error) {
                    test.result = {
                        error: error.message,
                        stack: error.stack
                    };
                }
                tests.push(test);
            }
            
            result.innerHTML = `<pre>${JSON.stringify(tests, null, 2)}</pre>`;
            
            // 결과 분석
            const accessible = tests.filter(t => t.result && t.result.ok);
            if (accessible.length > 0) {
                result.className = 'success';
                console.log('✅ index.html 접근 가능:', accessible);
            } else {
                result.className = 'failure';
                console.error('❌ index.html 접근 불가');
            }
        }

        // 2. 경로 변형 테스트
        function testPathVariations() {
            const result = document.getElementById('test2Result');
            const tests = [];
            
            // window.location 객체 조작 테스트
            const locationTests = [
                {
                    method: 'href setter',
                    code: 'window.location.href = "index.html"',
                    test: () => {
                        try {
                            const newUrl = new URL('index.html', window.location.href);
                            return { wouldNavigateTo: newUrl.href, error: null };
                        } catch (e) {
                            return { wouldNavigateTo: null, error: e.message };
                        }
                    }
                },
                {
                    method: 'replace method',
                    code: 'window.location.replace("index.html")',
                    test: () => {
                        try {
                            const newUrl = new URL('index.html', window.location.href);
                            return { wouldNavigateTo: newUrl.href, error: null };
                        } catch (e) {
                            return { wouldNavigateTo: null, error: e.message };
                        }
                    }
                },
                {
                    method: 'assign method',
                    code: 'window.location.assign("index.html")',
                    test: () => {
                        try {
                            const newUrl = new URL('index.html', window.location.href);
                            return { wouldNavigateTo: newUrl.href, error: null };
                        } catch (e) {
                            return { wouldNavigateTo: null, error: e.message };
                        }
                    }
                },
                {
                    method: 'pathname setter',
                    code: 'window.location.pathname = "/src/partners/index.html"',
                    test: () => {
                        try {
                            const newUrl = new URL(window.location.href);
                            newUrl.pathname = '/src/partners/index.html';
                            return { wouldNavigateTo: newUrl.href, error: null };
                        } catch (e) {
                            return { wouldNavigateTo: null, error: e.message };
                        }
                    }
                }
            ];
            
            locationTests.forEach(test => {
                const result = test.test();
                tests.push({
                    method: test.method,
                    code: test.code,
                    result: result
                });
            });
            
            result.innerHTML = `<pre>${JSON.stringify(tests, null, 2)}</pre>`;
            result.className = 'warning';
        }

        // 3. 실제 로그아웃 시뮬레이션
        async function simulateActualLogout() {
            const result = document.getElementById('test3Result');
            const steps = [];
            
            // Step 1: 가상의 authManager.logout() 실행
            steps.push({
                step: 1,
                action: 'authManager.logout() 호출',
                timestamp: new Date().toISOString()
            });
            
            // Supabase auth signOut 시뮬레이션
            await new Promise(resolve => setTimeout(resolve, 100));
            steps.push({
                step: 2,
                action: 'Supabase signOut 완료',
                timestamp: new Date().toISOString()
            });
            
            // localStorage 정리 시뮬레이션
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.includes('supabase') || key.includes('auth'))) {
                    keysToRemove.push(key);
                }
            }
            steps.push({
                step: 3,
                action: 'localStorage 정리',
                data: { keysFound: keysToRemove.length, keys: keysToRemove },
                timestamp: new Date().toISOString()
            });
            
            // 리다이렉트 시도
            steps.push({
                step: 4,
                action: '리다이렉트 시도',
                timestamp: new Date().toISOString()
            });
            
            // 각 방법으로 리다이렉트 테스트
            const redirectTests = [
                {
                    method: 'window.location.href = "./index.html"',
                    test: () => window.location.href = './index.html'
                },
                {
                    method: 'window.location.replace("./index.html")',
                    test: () => window.location.replace('./index.html')
                },
                {
                    method: 'window.location = "./index.html"',
                    test: () => window.location = './index.html'
                }
            ];
            
            // 실제로 실행하지 않고 시뮬레이션만
            redirectTests.forEach(test => {
                try {
                    // 실제 리다이렉트는 하지 않고 URL만 계산
                    const targetUrl = new URL('./index.html', window.location.href);
                    steps.push({
                        step: 5,
                        method: test.method,
                        wouldRedirectTo: targetUrl.href,
                        success: true
                    });
                } catch (error) {
                    steps.push({
                        step: 5,
                        method: test.method,
                        error: error.message,
                        success: false
                    });
                }
            });
            
            result.innerHTML = `<pre>${JSON.stringify(steps, null, 2)}</pre>`;
            result.className = 'warning';
        }

        // 4. 브라우저 제약사항 확인
        function checkBrowserConstraints() {
            const result = document.getElementById('test4Result');
            const constraints = {
                protocol: window.location.protocol,
                isFile: window.location.protocol === 'file:',
                isHTTP: window.location.protocol.startsWith('http'),
                cors: {
                    mode: document.currentScript ? document.currentScript.crossOrigin : 'unknown',
                    credentials: navigator.credentials ? 'available' : 'not available'
                },
                csp: {
                    hasCSP: !!document.querySelector('meta[http-equiv="Content-Security-Policy"]'),
                    directives: null
                },
                sandbox: {
                    isSandboxed: window.self !== window.top,
                    isIframe: window.self !== window.parent
                },
                permissions: {
                    canNavigate: true,
                    canOpenWindows: true,
                    canAccessLocalStorage: true,
                    canAccessSessionStorage: true
                },
                userAgent: {
                    browser: navigator.userAgent,
                    platform: navigator.platform
                }
            };
            
            // CSP 체크
            const cspMeta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
            if (cspMeta) {
                constraints.csp.directives = cspMeta.getAttribute('content');
            }
            
            // 권한 체크
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
            } catch (e) {
                constraints.permissions.canAccessLocalStorage = false;
            }
            
            try {
                sessionStorage.setItem('test', 'test');
                sessionStorage.removeItem('test');
            } catch (e) {
                constraints.permissions.canAccessSessionStorage = false;
            }
            
            // Navigation 가능 여부
            try {
                const testUrl = new URL('./index.html', window.location.href);
                constraints.permissions.testUrl = testUrl.href;
            } catch (e) {
                constraints.permissions.canNavigate = false;
                constraints.permissions.navigationError = e.message;
            }
            
            result.innerHTML = `<pre>${JSON.stringify(constraints, null, 2)}</pre>`;
            
            // 문제 진단
            if (constraints.isFile) {
                result.className = 'failure';
                result.innerHTML += '<p><strong>⚠️ 경고: file:// 프로토콜에서 실행 중입니다. 일부 리다이렉트가 작동하지 않을 수 있습니다.</strong></p>';
            } else {
                result.className = 'success';
            }
        }
        
        // 페이지 로드 시 자동 실행
        window.addEventListener('DOMContentLoaded', () => {
            console.log('🔍 리다이렉트 추적기 준비 완료');
            console.log('현재 위치:', window.location.href);
        });
    </script>
</body>
</html>