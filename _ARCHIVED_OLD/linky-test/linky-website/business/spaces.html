<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Í≥µÍ∞Ñ Í¥ÄÎ¶¨ - Linky Business</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Supabase ÏÑ§Ï†ï -->
    <script src="../supabase-config.js"></script>
    
    <!-- Ïù∏Ï¶ù Î∞è API -->
    <script src="../js/auth/auth-manager.js"></script>
    <script src="../js/auth/business-auth.js"></script>
    <script src="../js/api/business-api.js"></script>
    <script src="../js/auth-utils.js"></script>
    
    <!-- Í≥µÌÜµ Ïä§ÌÉÄÏùº -->
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/components.css">
    
    <style>
        .spaces-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            background: #f8fafc;
            min-height: calc(100vh - 200px);
        }
        
        .page-header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .page-title {
            font-size: 32px;
            font-weight: bold;
            color: #1f2937;
        }
        
        .add-space-btn {
            padding: 12px 24px;
            background: #22c55e;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .add-space-btn:hover {
            background: #16a34a;
            transform: translateY(-2px);
        }
        
        /* Í≥µÍ∞Ñ Í∑∏Î¶¨Îìú */
        .spaces-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }
        
        .space-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .space-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }
        
        .space-image {
            width: 100%;
            height: 200px;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            color: #9ca3af;
        }
        
        .space-info {
            padding: 20px;
        }
        
        .space-name {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .space-address {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 16px;
        }
        
        .space-stats {
            display: flex;
            gap: 20px;
            padding-top: 16px;
            border-top: 1px solid #f3f4f6;
        }
        
        .stat-item {
            flex: 1;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #22c55e;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        /* Î™®Îã¨ Ïä§ÌÉÄÏùº */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-header {
            padding: 30px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #22c55e;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #22c55e;
            color: white;
        }
        
        .btn-primary:hover {
            background: #16a34a;
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        /* Îπà ÏÉÅÌÉú */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .empty-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }
        
        .empty-title {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 12px;
        }
        
        .empty-description {
            color: #6b7280;
            font-size: 16px;
            margin-bottom: 30px;
        }
        
        /* Î°úÎî© ÏÉÅÌÉú */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f4f6;
            border-top: 5px solid #22c55e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Ìó§Îçî -->
    <header id="header"></header>
    
    <!-- Í≥µÍ∞Ñ Í¥ÄÎ¶¨ Ïª®ÌÖåÏù¥ÎÑà -->
    <div class="spaces-container">
        <!-- ÌéòÏù¥ÏßÄ Ìó§Îçî -->
        <div class="page-header">
            <h1 class="page-title">Í≥µÍ∞Ñ Í¥ÄÎ¶¨</h1>
            <button class="add-space-btn" onclick="openAddModal()">
                + ÏÉà Í≥µÍ∞Ñ Ï∂îÍ∞Ä
            </button>
        </div>
        
        <!-- Î°úÎî© ÏÉÅÌÉú -->
        <div id="loadingState" class="loading-container" style="display: none;">
            <div class="loading-spinner"></div>
        </div>
        
        <!-- Í≥µÍ∞Ñ Î™©Î°ù -->
        <div id="spacesContent" style="display: none;">
            <div id="spacesGrid" class="spaces-grid"></div>
            
            <!-- Îπà ÏÉÅÌÉú -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-icon">üè¢</div>
                <h2 class="empty-title">Îì±Î°ùÎêú Í≥µÍ∞ÑÏù¥ ÏóÜÏäµÎãàÎã§</h2>
                <p class="empty-description">
                    Ï≤´ Î≤àÏß∏ Í≥µÍ∞ÑÏùÑ Îì±Î°ùÌïòÍ≥† Íπ®ÎÅóÌïú Í¥ÄÎ¶¨Î•º ÏãúÏûëÌï¥Î≥¥ÏÑ∏Ïöî!
                </p>
                <button class="add-space-btn" onclick="openAddModal()">
                    Ï≤´ Í≥µÍ∞Ñ Îì±Î°ùÌïòÍ∏∞
                </button>
            </div>
        </div>
    </div>
    
    <!-- Ìë∏ÌÑ∞ -->
    <footer id="footer"></footer>
    
    <!-- Í≥µÍ∞Ñ Ï∂îÍ∞Ä/ÏàòÏ†ï Î™®Îã¨ -->
    <div id="spaceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">ÏÉà Í≥µÍ∞Ñ Ï∂îÍ∞Ä</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="spaceForm" onsubmit="handleSubmit(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label" for="spaceName">Í≥µÍ∞Ñ Ïù¥Î¶Ñ *</label>
                        <input type="text" id="spaceName" class="form-input" required 
                               placeholder="Ïòà: Î≥∏ÏÇ¨ ÏÇ¨Î¨¥Ïã§, Í∞ïÎÇ®Ï†ê">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="spaceType">Í≥µÍ∞Ñ Ïú†Ìòï *</label>
                        <select id="spaceType" class="form-select" required>
                            <option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                            <option value="office">ÏÇ¨Î¨¥Ïã§</option>
                            <option value="store">Îß§Ïû•</option>
                            <option value="warehouse">Ï∞ΩÍ≥†</option>
                            <option value="factory">Í≥µÏû•</option>
                            <option value="other">Í∏∞ÌÉÄ</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="spaceArea">Î©¥Ï†Å („é°)</label>
                        <input type="number" id="spaceArea" class="form-input" 
                               placeholder="Ïòà: 150" min="1">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="spaceAddress">Ï£ºÏÜå *</label>
                        <input type="text" id="spaceAddress" class="form-input" required 
                               placeholder="Ïòà: ÏÑúÏö∏Ïãú Í∞ïÎÇ®Íµ¨ ÌÖåÌó§ÎûÄÎ°ú 123">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="spaceDetailAddress">ÏÉÅÏÑ∏ Ï£ºÏÜå</label>
                        <input type="text" id="spaceDetailAddress" class="form-input" 
                               placeholder="Ïòà: 5Ï∏µ 501Ìò∏">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="cleaningFrequency">Ï≤≠ÏÜå Ï£ºÍ∏∞</label>
                        <select id="cleaningFrequency" class="form-select">
                            <option value="daily">Îß§Ïùº</option>
                            <option value="weekly" selected>Ï£º 1Ìöå</option>
                            <option value="biweekly">Í≤©Ï£º</option>
                            <option value="monthly">Ïõî 1Ìöå</option>
                            <option value="custom">Í∏∞ÌÉÄ</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="spaceNotes">ÌäπÏù¥ÏÇ¨Ìï≠</label>
                        <textarea id="spaceNotes" class="form-textarea" 
                                  placeholder="ÌäπÎ≥ÑÌûà Ïã†Í≤ΩÏç®Ïïº Ìï† Î∂ÄÎ∂ÑÏù¥ÎÇò Ï£ºÏùòÏÇ¨Ìï≠ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"></textarea>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        Ï∑®ÏÜå
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <span id="submitBtnText">Îì±Î°ùÌïòÍ∏∞</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let currentUser = null;
        let businessProfile = null;
        let editingSpaceId = null;
        
        // ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
        async function initializePage() {
            try {
                showLoading(true);
                
                // ÏÑ∏ÏÖò ÌôïÏù∏
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (!session) {
                    window.location.href = './index.html';
                    return;
                }
                
                currentUser = session.user;
                
                // ÎπÑÏ¶àÎãàÏä§ ÌîÑÎ°úÌïÑ ÌôïÏù∏
                const { data: profile, error } = await window.supabaseClient
                    .from('business_users')
                    .select('*')
                    .eq('auth_uid', currentUser.id)
                    .single();
                
                if (error || !profile) {
                    alert('ÌîÑÎ°úÌïÑÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
                    window.location.href = 'dashboard.html';
                    return;
                }
                
                businessProfile = profile;
                
                // Í≥µÍ∞Ñ Î™©Î°ù Î°úÎìú
                await loadSpaces();
                
            } catch (error) {
                console.error('Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);
                alert('ÌéòÏù¥ÏßÄ Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            } finally {
                showLoading(false);
            }
        }
        
        // Í≥µÍ∞Ñ Î™©Î°ù Î°úÎìú
        async function loadSpaces() {
            try {
                const { data: spaces, error } = await window.supabaseClient
                    .from('spaces')
                    .select('*')
                    .eq('owner_id', currentUser.id)  // owner_idÎäî auth_uidÎ•º Ï∞∏Ï°∞
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                displaySpaces(spaces || []);
                
            } catch (error) {
                console.error('Í≥µÍ∞Ñ Î°úÎìú Ïò§Î•ò:', error);
                alert('Í≥µÍ∞Ñ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
            }
        }
        
        // Í≥µÍ∞Ñ Î™©Î°ù ÌëúÏãú
        function displaySpaces(spaces) {
            const grid = document.getElementById('spacesGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (spaces.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            grid.style.display = 'grid';
            emptyState.style.display = 'none';
            
            grid.innerHTML = spaces.map(space => `
                <div class="space-card" onclick="viewSpace('${space.id}')">
                    <div class="space-image">${getSpaceIcon(space.type)}</div>
                    <div class="space-info">
                        <h3 class="space-name">${space.name}</h3>
                        <p class="space-address">${space.address}</p>
                        <div class="space-stats">
                            <div class="stat-item">
                                <div class="stat-value">${space.area || '-'}</div>
                                <div class="stat-label">Î©¥Ï†Å(„é°)</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${getFrequencyText(space.cleaning_frequency)}</div>
                                <div class="stat-label">Ï≤≠ÏÜå Ï£ºÍ∏∞</div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Í≥µÍ∞Ñ ÏïÑÏù¥ÏΩò Î∞òÌôò
        function getSpaceIcon(type) {
            const icons = {
                office: 'üè¢',
                store: 'üè™',
                warehouse: 'üì¶',
                factory: 'üè≠',
                other: 'üè†'
            };
            return icons[type] || 'üè¢';
        }
        
        // Ï≤≠ÏÜå Ï£ºÍ∏∞ ÌÖçÏä§Ìä∏ Î∞òÌôò
        function getFrequencyText(frequency) {
            const texts = {
                daily: 'Îß§Ïùº',
                weekly: 'Ï£º 1Ìöå',
                biweekly: 'Í≤©Ï£º',
                monthly: 'Ïõî 1Ìöå',
                custom: 'Í∏∞ÌÉÄ'
            };
            return texts[frequency] || frequency;
        }
        
        // Î™®Îã¨ Ïó¥Í∏∞
        function openAddModal() {
            editingSpaceId = null;
            document.getElementById('modalTitle').textContent = 'ÏÉà Í≥µÍ∞Ñ Ï∂îÍ∞Ä';
            document.getElementById('submitBtnText').textContent = 'Îì±Î°ùÌïòÍ∏∞';
            document.getElementById('spaceForm').reset();
            document.getElementById('spaceModal').classList.add('active');
        }
        
        // Î™®Îã¨ Îã´Í∏∞
        function closeModal() {
            document.getElementById('spaceModal').classList.remove('active');
            editingSpaceId = null;
        }
        
        // Ìèº Ï†úÏ∂ú Ï≤òÎ¶¨
        async function handleSubmit(event) {
            event.preventDefault();
            
            const formData = {
                name: document.getElementById('spaceName').value,
                type: document.getElementById('spaceType').value,
                area: parseInt(document.getElementById('spaceArea').value) || null,
                address: document.getElementById('spaceAddress').value,
                detail_address: document.getElementById('spaceDetailAddress').value,
                cleaning_frequency: document.getElementById('cleaningFrequency').value,
                notes: document.getElementById('spaceNotes').value,
                owner_id: currentUser.id  // auth_uid ÏÇ¨Ïö©
            };
            
            try {
                if (editingSpaceId) {
                    // ÏàòÏ†ï
                    const { error } = await window.supabaseClient
                        .from('spaces')
                        .update(formData)
                        .eq('id', editingSpaceId);
                    
                    if (error) throw error;
                    alert('Í≥µÍ∞ÑÏù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.');
                } else {
                    // Îì±Î°ù
                    const { error } = await window.supabaseClient
                        .from('spaces')
                        .insert([formData]);
                    
                    if (error) throw error;
                    alert('Í≥µÍ∞ÑÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.');
                }
                
                closeModal();
                await loadSpaces();
                
            } catch (error) {
                console.error('Í≥µÍ∞Ñ Ï†ÄÏû• Ïò§Î•ò:', error);
                alert('Í≥µÍ∞Ñ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
        
        // Í≥µÍ∞Ñ ÏÉÅÏÑ∏ Î≥¥Í∏∞
        function viewSpace(spaceId) {
            // ÎÇòÏ§ëÏóê ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌïòÎèÑÎ°ù Íµ¨ÌòÑ
            console.log('View space:', spaceId);
        }
        
        // Î°úÎî© ÌëúÏãú
        function showLoading(show) {
            document.getElementById('loadingState').style.display = show ? 'flex' : 'none';
            document.getElementById('spacesContent').style.display = show ? 'none' : 'block';
        }
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', () => {
            // Ìó§Îçî/Ìë∏ÌÑ∞ Î°úÎìú
            loadComponent('header', '../components/header.html');
            loadComponent('footer', '../components/footer.html');
            
            // ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
            initializePage();
        });
        
        // Ïª¥Ìè¨ÎÑåÌä∏ Î°úÎìú Ìï®Ïàò
        async function loadComponent(id, path) {
            try {
                const response = await fetch(path);
                const html = await response.text();
                document.getElementById(id).innerHTML = html;
            } catch (error) {
                console.error(`${id} Î°úÎìú Ïò§Î•ò:`, error);
            }
        }
    </script>
</body>
</html>