<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linky - ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Supabase ì„¤ì • -->
    <script src="../supabase-config.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: #2d3748;
            background: #f7fafc;
        }

        /* í—¤ë” */
        .header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #4f46e5;
            text-decoration: none;
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #6b7280;
        }

        /* ì‚¬ì´ë“œë°” */
        .admin-layout {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            min-height: calc(100vh - 80px);
        }

        .sidebar {
            width: 250px;
            background: white;
            padding: 30px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 5px;
        }

        .sidebar-menu a {
            display: block;
            padding: 12px 25px;
            color: #6b7280;
            text-decoration: none;
            transition: all 0.3s;
            border-right: 3px solid transparent;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: #f3f4f6;
            color: #4f46e5;
            border-right-color: #4f46e5;
        }

        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content {
            flex: 1;
            padding: 30px;
        }

        .page-title {
            font-size: 28px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 30px;
        }

        /* í†µê³„ ì¹´ë“œ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 4px solid #4f46e5;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-title {
            color: #6b7280;
            font-size: 14px;
            font-weight: 600;
        }

        .stat-icon {
            font-size: 24px;
            color: #4f46e5;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .stat-change {
            font-size: 12px;
            font-weight: 600;
        }

        .stat-increase {
            color: #10b981;
        }

        .stat-decrease {
            color: #ef4444;
        }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .table-header {
            background: #f8fafc;
            padding: 20px 25px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 15px 25px;
            text-align: left;
            border-bottom: 1px solid #f3f4f6;
        }

        .data-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .data-table td {
            color: #6b7280;
        }

        .data-table tr:hover {
            background: #f9fafb;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-primary:hover {
            background: #4338ca;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* ìƒíƒœ ë°°ì§€ */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-active {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }

        /* í•„í„° */
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        /* ë¹ˆ ìƒíƒœ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* íƒ­ */
        .tab-container {
            margin-bottom: 30px;
        }

        .tab-list {
            display: flex;
            border-bottom: 2px solid #f3f4f6;
            margin-bottom: 20px;
        }

        .tab-item {
            padding: 12px 20px;
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab-item.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ë¡œë”© ìƒíƒœ */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .admin-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 20px 0;
            }
            
            .sidebar-menu {
                display: flex;
                overflow-x: auto;
                padding: 0 20px;
            }
            
            .sidebar-menu li {
                margin-bottom: 0;
                margin-right: 15px;
                white-space: nowrap;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-bar {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <header class="header">
        <div class="header-content">
            <a href="../" class="logo">ğŸ”— Linky Admin</a>
            <div class="admin-info">
                <span id="adminName">ê´€ë¦¬ì</span>
                <button class="btn btn-secondary btn-small" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ë ˆì´ì•„ì›ƒ -->
    <div class="admin-layout">
        <!-- ì‚¬ì´ë“œë°” -->
        <aside class="sidebar">
            <ul class="sidebar-menu">
                <li><a href="#dashboard" class="active" onclick="showTab('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a></li>
                <li><a href="#users" onclick="showTab('users')">ğŸ‘¥ íšŒì› ê´€ë¦¬</a></li>
                <li><a href="#jobs" onclick="showTab('jobs')">ğŸ’¼ ì‘ì—… ê´€ë¦¬</a></li>
                <li><a href="#spaces" onclick="showTab('spaces')">ğŸ¢ ê³µê°„ ê´€ë¦¬</a></li>
                <li><a href="#bookings" onclick="showTab('bookings')">ğŸ“ êµìœ¡ ì˜ˆì•½</a></li>
                <li><a href="#facilities" onclick="showTab('facilities')">ğŸ”§ ì‹œì„¤ ì‹ ì²­</a></li>
                <li><a href="#analytics" onclick="showTab('analytics')">ğŸ“ˆ í†µê³„ ë¶„ì„</a></li>
                <li><a href="#settings" onclick="showTab('settings')">âš™ï¸ ì„¤ì •</a></li>
            </ul>
        </aside>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="main-content">
            <!-- ëŒ€ì‹œë³´ë“œ íƒ­ -->
            <div id="dashboard" class="tab-content active">
                <h1 class="page-title">ëŒ€ì‹œë³´ë“œ</h1>
                
                <!-- í†µê³„ ì¹´ë“œ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">ì´ íšŒì› ìˆ˜</span>
                            <span class="stat-icon">ğŸ‘¥</span>
                        </div>
                        <div class="stat-number" id="totalUsers">0</div>
                        <div class="stat-change stat-increase">+12% ì´ë²ˆ ë‹¬</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">í™œì„± íŒŒíŠ¸ë„ˆ</span>
                            <span class="stat-icon">ğŸ¤</span>
                        </div>
                        <div class="stat-number" id="activePartners">0</div>
                        <div class="stat-change stat-increase">+8% ì´ë²ˆ ë‹¬</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">ì´ë²ˆ ë‹¬ ê±°ë˜</span>
                            <span class="stat-icon">ğŸ’°</span>
                        </div>
                        <div class="stat-number" id="monthlyJobs">0</div>
                        <div class="stat-change stat-increase">+25% ì „ì›” ëŒ€ë¹„</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">ìŠ¹ì¸ ëŒ€ê¸°</span>
                            <span class="stat-icon">â³</span>
                        </div>
                        <div class="stat-number" id="pendingApprovals">0</div>
                        <div class="stat-change">ì²˜ë¦¬ í•„ìš”</div>
                    </div>
                </div>

                <!-- ìµœê·¼ í™œë™ -->
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">ìµœê·¼ í™œë™</h3>
                        <button class="btn btn-primary btn-small" onclick="loadRecentActivity()">ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ì‹œê°„</th>
                                <th>í™œë™</th>
                                <th>ì‚¬ìš©ì</th>
                                <th>ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivityTable">
                            <tr>
                                <td colspan="4" class="empty-state">
                                    <div class="empty-icon">ğŸ“‹</div>
                                    <div>í™œë™ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- íšŒì› ê´€ë¦¬ íƒ­ -->
            <div id="users" class="tab-content">
                <h1 class="page-title">íšŒì› ê´€ë¦¬</h1>
                
                <!-- í•„í„° -->
                <div class="filter-bar">
                    <div class="filter-group">
                        <label class="filter-label">íšŒì› ìœ í˜•</label>
                        <select class="filter-select" id="userTypeFilter" onchange="filterUsers()">
                            <option value="">ì „ì²´</option>
                            <option value="business">ì‚¬ì—…ì</option>
                            <option value="partner">íŒŒíŠ¸ë„ˆ</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ìƒíƒœ</label>
                        <select class="filter-select" id="userStatusFilter" onchange="filterUsers()">
                            <option value="">ì „ì²´</option>
                            <option value="pending">ìŠ¹ì¸ ëŒ€ê¸°</option>
                            <option value="approved">ìŠ¹ì¸ ì™„ë£Œ</option>
                            <option value="rejected">ìŠ¹ì¸ ê±°ë¶€</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="loadUsers()">ìƒˆë¡œê³ ì¹¨</button>
                </div>

                <!-- íšŒì› ëª©ë¡ -->
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">íšŒì› ëª©ë¡</h3>
                        <div class="table-actions">
                            <button class="btn btn-success btn-small" onclick="approveSelected()">ì„ íƒ ìŠ¹ì¸</button>
                            <button class="btn btn-danger btn-small" onclick="rejectSelected()">ì„ íƒ ê±°ë¶€</button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                <th>ì´ë¦„</th>
                                <th>ì´ë©”ì¼</th>
                                <th>ìœ í˜•</th>
                                <th>ìƒíƒœ</th>
                                <th>ê°€ì…ì¼</th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr>
                                <td colspan="7" class="empty-state">
                                    <div class="empty-icon">ğŸ‘¥</div>
                                    <div>íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ì‘ì—… ê´€ë¦¬ íƒ­ -->
            <div id="jobs" class="tab-content">
                <h1 class="page-title">ì‘ì—… ê´€ë¦¬</h1>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">ì‘ì—… ëª©ë¡</h3>
                        <button class="btn btn-primary btn-small" onclick="loadJobs()">ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ì‘ì—… ID</th>
                                <th>ê³µê°„</th>
                                <th>ì‚¬ì—…ì</th>
                                <th>íŒŒíŠ¸ë„ˆ</th>
                                <th>ê¸ˆì•¡</th>
                                <th>ìƒíƒœ</th>
                                <th>ì¼ì •</th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="jobsTable">
                            <tr>
                                <td colspan="8" class="empty-state">
                                    <div class="empty-icon">ğŸ’¼</div>
                                    <div>ì‘ì—… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ê¸°íƒ€ íƒ­ë“¤... (ê°„ì†Œí™”) -->
            <div id="spaces" class="tab-content">
                <h1 class="page-title">ê³µê°„ ê´€ë¦¬</h1>
                <div class="empty-state">
                    <div class="empty-icon">ğŸ¢</div>
                    <div>ê³µê°„ ê´€ë¦¬ ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</div>
                </div>
            </div>

            <div id="bookings" class="tab-content">
                <h1 class="page-title">êµìœ¡ ì˜ˆì•½ ê´€ë¦¬</h1>
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“</div>
                    <div>êµìœ¡ ì˜ˆì•½ ê´€ë¦¬ ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</div>
                </div>
            </div>

            <div id="facilities" class="tab-content">
                <h1 class="page-title">ì‹œì„¤ ì‹ ì²­ ê´€ë¦¬</h1>
                <div class="empty-state">
                    <div class="empty-icon">ğŸ”§</div>
                    <div>ì‹œì„¤ ì‹ ì²­ ê´€ë¦¬ ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</div>
                </div>
            </div>

            <div id="analytics" class="tab-content">
                <h1 class="page-title">í†µê³„ ë¶„ì„</h1>
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“ˆ</div>
                    <div>í†µê³„ ë¶„ì„ ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</div>
                </div>
            </div>

            <div id="settings" class="tab-content">
                <h1 class="page-title">ì„¤ì •</h1>
                <div class="empty-state">
                    <div class="empty-icon">âš™ï¸</div>
                    <div>ì„¤ì • ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Supabase ì„¤ì • ë° ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="../supabase-config.js"></script>
    <script src="../js/auth-utils.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let allUsers = [];
        let allJobs = [];

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', async function() {
            // Supabaseê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
            await waitForSupabase();
            
            // í˜„ì¬ ì¸ì¦ ìƒíƒœ í™•ì¸
            const { isAuthenticated, user } = await checkAuthStatus();
            
            if (isAuthenticated && user) {
                if (user.type === 'admin') {
                    currentUser = user;
                    document.getElementById('adminName').textContent = user.name || 'ê´€ë¦¬ì';
                    loadDashboard();
                } else {
                    alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '../';
                }
            } else {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '../';
            }
        });

        // Supabase ë¡œë“œ ëŒ€ê¸°
        function waitForSupabase() {
            return new Promise((resolve) => {
                if (window.supabaseClient) {
                    resolve();
                } else {
                    const checkInterval = setInterval(() => {
                        if (window.supabaseClient) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                }
            });
        }

        // ëŒ€ì‹œë³´ë“œ ë¡œë“œ
        async function loadDashboard() {
            try {
                // í†µê³„ ë°ì´í„° ë¡œë“œ
                await Promise.all([
                    loadUserStats(),
                    loadJobStats(),
                    loadRecentActivity()
                ]);
            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ì‚¬ìš©ì í†µê³„ ë¡œë“œ
        async function loadUserStats() {
            try {
                // ë¹„ì¦ˆë‹ˆìŠ¤ ì‚¬ìš©ì ì¡°íšŒ
                const { data: businessUsers, error: businessError } = await window.supabaseClient
                    .from('business_users')
                    .select('id, status');
                
                // íŒŒíŠ¸ë„ˆ ì‚¬ìš©ì ì¡°íšŒ  
                const { data: partnerUsers, error: partnerError } = await window.supabaseClient
                    .from('partner_users')
                    .select('id, status');

                if (businessError) throw businessError;
                if (partnerError) throw partnerError;

                const totalUsers = (businessUsers?.length || 0) + (partnerUsers?.length || 0);
                const activePartners = partnerUsers?.filter(u => u.status === 'approved').length || 0;
                const pendingApprovals = (businessUsers?.filter(u => u.status === 'pending').length || 0) + 
                                       (partnerUsers?.filter(u => u.status === 'pending').length || 0);

                document.getElementById('totalUsers').textContent = totalUsers;
                document.getElementById('activePartners').textContent = activePartners;
                document.getElementById('pendingApprovals').textContent = pendingApprovals;
            } catch (error) {
                console.error('ì‚¬ìš©ì í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ì‘ì—… í†µê³„ ë¡œë“œ
        async function loadJobStats() {
            try {
                // ì´ë²ˆ ë‹¬ ì‹œì‘ì¼ ê³„ì‚°
                const startOfMonth = new Date();
                startOfMonth.setDate(1);
                startOfMonth.setHours(0, 0, 0, 0);

                const { data: jobs, error } = await window.supabaseClient
                    .from('jobs')
                    .select('created_at')
                    .gte('created_at', startOfMonth.toISOString());

                if (error) throw error;

                document.getElementById('monthlyJobs').textContent = jobs?.length || 0;
            } catch (error) {
                console.error('ì‘ì—… í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('monthlyJobs').textContent = 0;
            }
        }

        // ìµœê·¼ í™œë™ ë¡œë“œ
        async function loadRecentActivity() {
            try {
                // ì„ì‹œ ë°ì´í„° (ì‹¤ì œë¡œëŠ” Supabaseì—ì„œ ë¡œë“œ)
                const activities = [
                    { time: '10ë¶„ ì „', activity: 'ìƒˆë¡œìš´ íšŒì›ê°€ì…', user: 'í™ê¸¸ë™', status: 'pending' },
                    { time: '30ë¶„ ì „', activity: 'ì‘ì—… ì™„ë£Œ', user: 'ê¹€íŒŒíŠ¸ë„ˆ', status: 'completed' },
                    { time: '1ì‹œê°„ ì „', activity: 'ì‘ì—… ìš”ì²­', user: 'ì´ì‚¬ì—…ì', status: 'active' },
                    { time: '2ì‹œê°„ ì „', activity: 'íšŒì› ìŠ¹ì¸', user: 'ë°•íŒŒíŠ¸ë„ˆ', status: 'approved' }
                ];

                const tableBody = document.getElementById('recentActivityTable');
                tableBody.innerHTML = activities.map(activity => `
                    <tr>
                        <td>${activity.time}</td>
                        <td>${activity.activity}</td>
                        <td>${activity.user}</td>
                        <td><span class="status-badge status-${activity.status}">${getStatusLabel(activity.status)}</span></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('ìµœê·¼ í™œë™ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // íšŒì› ëª©ë¡ ë¡œë“œ
        async function loadUsers() {
            try {
                allUsers = [];
                
                // ë¹„ì¦ˆë‹ˆìŠ¤ ì‚¬ìš©ì ì¡°íšŒ
                const { data: businessUsers, error: businessError } = await window.supabaseClient
                    .from('business_users')
                    .select('id, auth_uid, business_name as name, email, status, created_at')
                    .order('created_at', { ascending: false });
                
                if (businessError) throw businessError;
                
                // íŒŒíŠ¸ë„ˆ ì‚¬ìš©ì ì¡°íšŒ  
                const { data: partnerUsers, error: partnerError } = await window.supabaseClient
                    .from('partner_users')
                    .select('id, auth_uid, name, email, status, created_at')
                    .order('created_at', { ascending: false });
                
                if (partnerError) throw partnerError;
                
                // ì‚¬ìš©ì íƒ€ì… ì¶”ê°€
                const businessUsersWithType = businessUsers?.map(user => ({ ...user, type: 'business' })) || [];
                const partnerUsersWithType = partnerUsers?.map(user => ({ ...user, type: 'partner' })) || [];
                
                // í•©ì¹˜ê¸° ë° ë‚ ì§œìˆœ ì •ë ¬
                allUsers = [...businessUsersWithType, ...partnerUsersWithType]
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                displayUsers(allUsers);
            } catch (error) {
                console.error('íšŒì› ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                const tableBody = document.getElementById('usersTable');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div>íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>
                        </td>
                    </tr>
                `;
            }
        }

        // íšŒì› ëª©ë¡ í‘œì‹œ
        function displayUsers(users) {
            const tableBody = document.getElementById('usersTable');
            
            if (users.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-icon">ğŸ‘¥</div>
                            <div>íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = users.map(user => `
                <tr>
                    <td><input type="checkbox" class="user-checkbox" value="${user.id}" data-type="${user.type}"></td>
                    <td>${user.name || 'N/A'}</td>
                    <td>${user.email}</td>
                    <td>${getTypeLabel(user.type)}</td>
                    <td><span class="status-badge status-${user.status}">${getStatusLabel(user.status)}</span></td>
                    <td>${formatDate(user.created_at)}</td>
                    <td>
                        ${user.status === 'pending' ? `
                            <button class="btn btn-success btn-small" onclick="approveUser('${user.id}', '${user.type}')">ìŠ¹ì¸</button>
                            <button class="btn btn-danger btn-small" onclick="rejectUser('${user.id}', '${user.type}')">ê±°ë¶€</button>
                        ` : `
                            <button class="btn btn-secondary btn-small" onclick="viewUser('${user.id}', '${user.type}')">ìƒì„¸</button>
                        `}
                    </td>
                </tr>
            `).join('');
        }

        // íšŒì› í•„í„°ë§
        function filterUsers() {
            const typeFilter = document.getElementById('userTypeFilter').value;
            const statusFilter = document.getElementById('userStatusFilter').value;
            
            let filteredUsers = allUsers;
            
            if (typeFilter) {
                filteredUsers = filteredUsers.filter(user => user.type === typeFilter);
            }
            
            if (statusFilter) {
                filteredUsers = filteredUsers.filter(user => user.status === statusFilter);
            }
            
            displayUsers(filteredUsers);
        }

        // íšŒì› ìŠ¹ì¸
        async function approveUser(userId, userType) {
            try {
                const tableName = userType === 'business' ? 'business_users' : 'partner_users';
                
                const { error } = await window.supabaseClient
                    .from(tableName)
                    .update({
                        status: 'approved',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', userId);

                if (error) throw error;
                
                alert('íšŒì›ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadUsers();
                loadDashboard();
            } catch (error) {
                console.error('íšŒì› ìŠ¹ì¸ ì˜¤ë¥˜:', error);
                alert('ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // íšŒì› ê±°ë¶€
        async function rejectUser(userId, userType) {
            if (confirm('ì •ë§ ì´ íšŒì›ì„ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    const tableName = userType === 'business' ? 'business_users' : 'partner_users';
                    
                    const { error } = await window.supabaseClient
                        .from(tableName)
                        .update({
                            status: 'rejected',
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', userId);

                    if (error) throw error;
                    
                    alert('íšŒì›ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadUsers();
                    loadDashboard();
                } catch (error) {
                    console.error('íšŒì› ê±°ë¶€ ì˜¤ë¥˜:', error);
                    alert('ê±°ë¶€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        // ì‘ì—… ëª©ë¡ ë¡œë“œ
        async function loadJobs() {
            const tableBody = document.getElementById('jobsTable');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="empty-state">
                        <div class="empty-icon">ğŸ’¼</div>
                        <div>ì‘ì—… ê´€ë¦¬ ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</div>
                    </td>
                </tr>
            `;
        }

        // íƒ­ ì „í™˜
        function showTab(tabName) {
            // ëª¨ë“  íƒ­ ì»¨í…ì¸  ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ëª¨ë“  ì‚¬ì´ë“œë°” ë©”ë‰´ ë¹„í™œì„±í™”
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.classList.remove('active');
            });
            
            // ì„ íƒëœ íƒ­ í‘œì‹œ
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`a[href="#${tabName}"]`).classList.add('active');
            
            // íƒ­ë³„ ë°ì´í„° ë¡œë“œ
            if (tabName === 'users' && allUsers.length === 0) {
                loadUsers();
            } else if (tabName === 'jobs') {
                loadJobs();
            }
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ (utils.js ì‚¬ìš©)
        function getTypeLabel(type) {
            return LinkyUtils.getTypeLabel(type);
        }

        function getStatusLabel(status) {
            return LinkyUtils.getStatusLabel(status);
        }

        function formatDate(timestamp) {
            return LinkyUtils.formatDate(timestamp);
        }

        // ì „ì²´ ì„ íƒ í† ê¸€
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        // ì„ íƒëœ íšŒì› ìŠ¹ì¸
        async function approveSelected() {
            const selected = document.querySelectorAll('.user-checkbox:checked');
            if (selected.length === 0) {
                alert('ìŠ¹ì¸í•  íšŒì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (confirm(`ì„ íƒëœ ${selected.length}ëª…ì˜ íšŒì›ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                try {
                    const promises = Array.from(selected).map(checkbox => {
                        const userId = checkbox.value;
                        const userType = checkbox.dataset.type;
                        const tableName = userType === 'business' ? 'business_users' : 'partner_users';
                        
                        return window.supabaseClient
                            .from(tableName)
                            .update({
                                status: 'approved',
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', userId);
                    });
                    
                    await Promise.all(promises);
                    alert('ì„ íƒëœ íšŒì›ë“¤ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadUsers();
                    loadDashboard();
                } catch (error) {
                    console.error('ì¼ê´„ ìŠ¹ì¸ ì˜¤ë¥˜:', error);
                    alert('ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        // ì„ íƒëœ íšŒì› ê±°ë¶€
        async function rejectSelected() {
            const selected = document.querySelectorAll('.user-checkbox:checked');
            if (selected.length === 0) {
                alert('ê±°ë¶€í•  íšŒì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (confirm(`ì„ íƒëœ ${selected.length}ëª…ì˜ íšŒì›ì„ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                try {
                    const promises = Array.from(selected).map(checkbox => {
                        const userId = checkbox.value;
                        const userType = checkbox.dataset.type;
                        const tableName = userType === 'business' ? 'business_users' : 'partner_users';
                        
                        return window.supabaseClient
                            .from(tableName)
                            .update({
                                status: 'rejected',
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', userId);
                    });
                    
                    await Promise.all(promises);
                    alert('ì„ íƒëœ íšŒì›ë“¤ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadUsers();
                    loadDashboard();
                } catch (error) {
                    console.error('ì¼ê´„ ê±°ë¶€ ì˜¤ë¥˜:', error);
                    alert('ê±°ë¶€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        // íšŒì› ìƒì„¸ ë³´ê¸°
        function viewUser(userId) {
            alert('íšŒì› ìƒì„¸ ë³´ê¸° ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
        }

        // ë¡œê·¸ì•„ì›ƒ
        async function handleLogout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    // Supabase ë¡œê·¸ì•„ì›ƒ
                    const { error } = await window.supabaseClient.auth.signOut();
                    
                    if (error) {
                        console.error('Supabase ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                    }
                    
                    // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™”
                    currentUser = null;
                    window.currentUser = null;
                    
                    // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ì •ë¦¬
                    sessionStorage.clear();
                    localStorage.removeItem('supabase.auth.token');
                    
                    // ê°•ì œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (replace ì‚¬ìš©ìœ¼ë¡œ ë’¤ë¡œê°€ê¸° ë°©ì§€)
                    window.location.replace('../index.html');
                    
                } catch (error) {
                    console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                    // ì˜¤ë¥˜ê°€ ìˆì–´ë„ ê°•ì œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                    window.location.replace('../index.html');
                }
            }
        }
    </script>
</body>
</html>