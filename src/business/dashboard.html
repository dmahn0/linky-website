<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ì‹œë³´ë“œ - Linky Business</title>
    
    <!-- Styles -->
    <link rel="stylesheet" href="../shared/css/base.css">
    <link rel="stylesheet" href="../shared/css/components.css">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Config & Scripts -->
    <script src="../shared/js/config.js"></script>
    <script src="../shared/js/auth.js"></script>
    <script src="../shared/js/api.js"></script>
    
    <style>
        .dashboard-header {
            background: white;
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-xl);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-lg);
        }
        
        .welcome-section h1 {
            margin: 0;
            color: var(--color-text);
        }
        
        .welcome-section p {
            margin: var(--spacing-xs) 0 0 0;
            color: var(--color-text-light);
        }
        
        .header-actions {
            display: flex;
            gap: var(--spacing-md);
        }
        
        .dashboard-content {
            padding: 0 var(--spacing-lg) var(--spacing-xl);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }
        
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }
        
        .action-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-xl);
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all var(--transition-base);
            text-decoration: none;
            color: var(--color-text);
        }
        
        .action-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        .action-icon {
            font-size: 48px;
            margin-bottom: var(--spacing-md);
            color: var(--color-primary);
        }
        
        .action-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }
        
        .action-description {
            font-size: var(--font-size-sm);
            color: var(--color-text-light);
            text-align: center;
        }
        
        .recent-section {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            padding: var(--spacing-lg);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }
        
        .section-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin: 0;
        }
        
        .job-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        .job-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            background: var(--color-surface);
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
        }
        
        .job-item:hover {
            background: var(--color-border);
        }
        
        .job-info {
            flex: 1;
        }
        
        .job-title {
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }
        
        .job-meta {
            display: flex;
            gap: var(--spacing-md);
            font-size: var(--font-size-sm);
            color: var(--color-text-light);
        }
        
        .job-status {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <div class="header-content">
                <div class="welcome-section">
                    <h1>í™˜ì˜í•©ë‹ˆë‹¤, <span id="businessName">-</span>ë‹˜</h1>
                    <p>ì˜¤ëŠ˜ë„ ê¹¨ë—í•œ í•˜ë£¨ ë˜ì„¸ìš”!</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="window.location.href='profile.html'">
                        í”„ë¡œí•„ ì„¤ì •
                    </button>
                    <button class="btn btn-secondary" id="logoutBtn">
                        ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container dashboard-content">
        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="spaceCount">0</div>
                <div class="stat-label">ë“±ë¡ëœ ê³µê°„</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeJobs">0</div>
                <div class="stat-label">ì§„í–‰ì¤‘ì¸ ì‘ì—…</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completedJobs">0</div>
                <div class="stat-label">ì™„ë£Œëœ ì‘ì—…</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">â‚©<span id="monthlySpent">0</span></div>
                <div class="stat-label">ì´ë²ˆë‹¬ ì§€ì¶œ</div>
            </div>
        </div>
        
        <!-- ì£¼ìš” ì•¡ì…˜ ë²„íŠ¼ -->
        <div class="action-grid">
            <a href="spaces.html" class="action-card">
                <div class="action-icon">ğŸ¢</div>
                <div class="action-title">ê³µê°„ ê´€ë¦¬</div>
                <div class="action-description">ì²­ì†Œí•  ê³µê°„ì„ ë“±ë¡í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</div>
            </a>
            <a href="jobs.html?action=create" class="action-card">
                <div class="action-icon">â•</div>
                <div class="action-title">ì‘ì—… ìš”ì²­</div>
                <div class="action-description">ìƒˆë¡œìš´ ì²­ì†Œ ì‘ì—…ì„ ìš”ì²­í•˜ì„¸ìš”</div>
            </a>
            <a href="jobs.html" class="action-card">
                <div class="action-icon">ğŸ“‹</div>
                <div class="action-title">ì‘ì—… ëª©ë¡</div>
                <div class="action-description">ëª¨ë“  ì‘ì—… ë‚´ì—­ì„ í™•ì¸í•˜ì„¸ìš”</div>
            </a>
            <a href="reports.html" class="action-card">
                <div class="action-icon">ğŸ“Š</div>
                <div class="action-title">ë¦¬í¬íŠ¸</div>
                <div class="action-description">ìƒì„¸ í†µê³„ì™€ ë¶„ì„ì„ í™•ì¸í•˜ì„¸ìš”</div>
            </a>
        </div>
        
        <!-- ìµœê·¼ ì‘ì—… -->
        <div class="recent-section">
            <div class="section-header">
                <h2 class="section-title">ìµœê·¼ ì‘ì—…</h2>
                <a href="jobs.html" class="btn btn-sm btn-secondary">ì „ì²´ ë³´ê¸°</a>
            </div>
            <div id="recentJobs" class="job-list">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“­</div>
                    <div class="empty-state-title">ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    <div class="empty-state-message">ìƒˆë¡œìš´ ì‘ì—…ì„ ìš”ì²­í•´ë³´ì„¸ìš”!</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentUser = null;
        let userProfile = null;
        
        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        async function initDashboard() {
            // ì¸ì¦ í™•ì¸
            const session = await authManager.checkSession();
            if (!session || session.userType !== 'business') {
                window.location.href = 'index.html';
                return;
            }
            
            currentUser = session.user;
            userProfile = session.profile;
            
            // ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ
            document.getElementById('businessName').textContent = 
                userProfile?.business_name || currentUser?.email || 'ì‚¬ìš©ì';
            
            // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
            await loadDashboardStats();
            await loadRecentJobs();
        }
        
        // ëŒ€ì‹œë³´ë“œ í†µê³„ ë¡œë“œ
        async function loadDashboardStats() {
            try {
                const stats = await businessAPI.getDashboardStats(currentUser.id);
                
                if (stats.success && stats.data) {
                    document.getElementById('spaceCount').textContent = stats.data.spaceCount || 0;
                    document.getElementById('activeJobs').textContent = stats.data.activeJobs || 0;
                    document.getElementById('completedJobs').textContent = stats.data.completedJobs || 0;
                    document.getElementById('monthlySpent').textContent = 
                        (stats.data.monthlySpent || 0).toLocaleString('ko-KR');
                }
            } catch (error) {
                console.error('Failed to load dashboard stats:', error);
            }
        }
        
        // ìµœê·¼ ì‘ì—… ë¡œë“œ
        async function loadRecentJobs() {
            try {
                const result = await businessAPI.getJobs(currentUser.id);
                
                if (result.success && result.data && result.data.length > 0) {
                    const recentJobs = result.data.slice(0, 5); // ìµœê·¼ 5ê°œë§Œ
                    const jobsHtml = recentJobs.map(job => createJobItem(job)).join('');
                    document.getElementById('recentJobs').innerHTML = jobsHtml;
                } else {
                    // ì‘ì—…ì´ ì—†ì„ ë•Œ ê¸°ë³¸ ë©”ì‹œì§€ ìœ ì§€
                    document.getElementById('recentJobs').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“­</div>
                            <div class="empty-state-title">ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤</div>
                            <div class="empty-state-message">ìƒˆë¡œìš´ ì‘ì—…ì„ ìš”ì²­í•´ë³´ì„¸ìš”!</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load recent jobs:', error);
            }
        }
        
        // ì‘ì—… ì•„ì´í…œ HTML ìƒì„±
        function createJobItem(job) {
            const statusBadge = getStatusBadge(job.status);
            const scheduledDate = new Date(job.scheduled_date).toLocaleDateString('ko-KR');
            
            return `
                <div class="job-item">
                    <div class="job-info">
                        <div class="job-title">${job.title}</div>
                        <div class="job-meta">
                            <span>ğŸ“ ${job.space?.name || 'ê³µê°„ ì •ë³´ ì—†ìŒ'}</span>
                            <span>ğŸ“… ${scheduledDate}</span>
                            <span>ğŸ’° â‚©${(job.base_price || 0).toLocaleString('ko-KR')}</span>
                        </div>
                    </div>
                    <div class="job-status">
                        ${statusBadge}
                    </div>
                </div>
            `;
        }
        
        // ìƒíƒœ ë°°ì§€ ìƒì„±
        function getStatusBadge(status) {
            const statusMap = {
                'pending': { text: 'ëŒ€ê¸°ì¤‘', class: 'badge-warning' },
                'assigned': { text: 'ë°°ì •ë¨', class: 'badge-primary' },
                'in_progress': { text: 'ì§„í–‰ì¤‘', class: 'badge-primary' },
                'completed': { text: 'ì™„ë£Œ', class: 'badge-success' },
                'cancelled': { text: 'ì·¨ì†Œ', class: 'badge-danger' }
            };
            
            const statusInfo = statusMap[status] || { text: status, class: 'badge-secondary' };
            return `<span class="badge ${statusInfo.class}">${statusInfo.text}</span>`;
        }
        
        // ë¡œê·¸ì•„ì›ƒ
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            console.log('ğŸšª Logout button clicked');
            
            // í™•ì¸ ë©”ì‹œì§€
            if (!confirm('ì •ë§ ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            // ë¡œë”© í‘œì‹œ
            const logoutBtn = document.getElementById('logoutBtn');
            const originalText = logoutBtn.textContent;
            logoutBtn.textContent = 'ë¡œê·¸ì•„ì›ƒ ì¤‘...';
            logoutBtn.disabled = true;
            
            try {
                const result = await authManager.logout();
                
                if (result.success) {
                    console.log('âœ… Logout successful, redirecting...');
                    // ìƒëŒ€ ê²½ë¡œë¡œ ëœë”© í˜ì´ì§€ë¡œ ì´ë™
                    console.log('ğŸ”„ Redirecting to landing page...');
                    window.location.replace('../landing/index.html');
                } else {
                    console.error('âŒ Logout failed:', result.error);
                    alert('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    // ì‹¤íŒ¨í•´ë„ ëœë”© í˜ì´ì§€ë¡œ ì´ë™
                    window.location.replace('../landing/index.html');
                }
            } catch (error) {
                console.error('âŒ Logout error:', error);
                alert('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ëœë”© í˜ì´ì§€ë¡œ ì´ë™
                window.location.replace('../landing/index.html');
            }
        });
        
        // ì´ˆê¸°í™” ì‹¤í–‰
        initDashboard();
    </script>
</body>
</html>