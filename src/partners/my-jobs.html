<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ ì‘ì—… - Linky Partners</title>
    
    <!-- Styles -->
    <link rel="stylesheet" href="../shared/css/base.css">
    <link rel="stylesheet" href="../shared/css/components.css">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Config & Scripts -->
    <script src="../shared/js/config.js"></script>
    <script src="../shared/js/auth.js"></script>
    <script src="../shared/js/api.js"></script>
    
    <style>
        .page-header {
            background: linear-gradient(135deg, var(--color-primary), #16a34a);
            color: white;
            padding: var(--spacing-2xl) 0;
            margin-bottom: var(--spacing-xl);
        }
        
        .page-title {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            margin: 0;
            color: white;
        }
        
        .page-subtitle {
            margin-top: var(--spacing-sm);
            opacity: 0.9;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }
        
        .stat-card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            padding: var(--spacing-lg);
            text-align: center;
        }
        
        .stat-value {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: var(--spacing-xs);
        }
        
        .stat-label {
            color: var(--color-text-light);
            font-size: var(--font-size-sm);
        }
        
        .tabs-container {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
        }
        
        .tabs {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .tab-button {
            flex: 1;
            padding: var(--spacing-md);
            border: none;
            background: transparent;
            color: var(--color-text-light);
            font-weight: 600;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .tab-button:hover {
            background: var(--color-surface);
        }
        
        .tab-button.active {
            background: var(--color-primary);
            color: white;
        }
        
        .jobs-container {
            display: grid;
            gap: var(--spacing-lg);
        }
        
        .job-card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            padding: var(--spacing-lg);
            transition: all var(--transition-base);
            position: relative;
        }
        
        .job-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .job-status-badge {
            position: absolute;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-assigned {
            background: #dbeafe;
            color: #2563eb;
        }
        
        .status-in_progress {
            background: #e0f2fe;
            color: #0891b2;
        }
        
        .status-completed {
            background: #dcfce7;
            color: #16a34a;
        }
        
        .status-pending_review {
            background: #fef3c7;
            color: #d97706;
        }
        
        .job-header {
            margin-bottom: var(--spacing-md);
        }
        
        .job-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: var(--spacing-xs);
        }
        
        .job-business {
            color: var(--color-text-light);
            font-size: var(--font-size-sm);
        }
        
        .job-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .detail-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }
        
        .job-price-info {
            background: var(--color-surface);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }
        
        .price-label {
            color: var(--color-text-light);
            font-size: var(--font-size-sm);
        }
        
        .price-value {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--color-primary);
        }
        
        .job-actions {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: flex-end;
        }
        
        .empty-state {
            text-align: center;
            padding: var(--spacing-3xl);
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }
        
        .empty-icon {
            font-size: 64px;
            margin-bottom: var(--spacing-lg);
            opacity: 0.5;
        }
        
        .empty-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: var(--spacing-sm);
        }
        
        .empty-message {
            color: var(--color-text-light);
            margin-bottom: var(--spacing-lg);
        }
        
        /* ì‘ì—… ì™„ë£Œ ëª¨ë‹¬ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-container {
            background: white;
            border-radius: var(--radius-lg);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-2xl);
        }
        
        .modal-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--color-border);
        }
        
        .modal-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin: 0;
        }
        
        .modal-body {
            padding: var(--spacing-lg);
        }
        
        .modal-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--color-border);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
        }
    </style>
</head>
<body>
    <div class="page-header">
        <div class="container">
            <h1 class="page-title">ğŸ“‹ ë‚´ ì‘ì—…</h1>
            <p class="page-subtitle">ì§„í–‰ì¤‘ì¸ ì‘ì—…ì„ ê´€ë¦¬í•˜ê³  ì™„ë£Œ ë³´ê³ ë¥¼ ì œì¶œí•˜ì„¸ìš”</p>
        </div>
    </div>
    
    <div class="container">
        <!-- í†µê³„ -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value" id="todayJobs">0</div>
                <div class="stat-label">ì˜¤ëŠ˜ ì‘ì—…</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="weekJobs">0</div>
                <div class="stat-label">ì´ë²ˆì£¼ ì‘ì—…</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="monthCompleted">0</div>
                <div class="stat-label">ì´ë²ˆë‹¬ ì™„ë£Œ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">â‚©<span id="monthEarnings">0</span></div>
                <div class="stat-label">ì´ë²ˆë‹¬ ìˆ˜ìµ</div>
            </div>
        </div>
        
        <!-- íƒ­ -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab-button active" data-tab="assigned" onclick="switchTab('assigned')">
                    ë°°ì •ë¨
                </button>
                <button class="tab-button" data-tab="in_progress" onclick="switchTab('in_progress')">
                    ì§„í–‰ì¤‘
                </button>
                <button class="tab-button" data-tab="completed" onclick="switchTab('completed')">
                    ì™„ë£Œ
                </button>
                <button class="tab-button" data-tab="applied" onclick="switchTab('applied')">
                    ì§€ì›ì¤‘
                </button>
            </div>
        </div>
        
        <!-- ì‘ì—… ëª©ë¡ -->
        <div id="jobsContainer" class="jobs-container">
            <div class="empty-state">
                <div class="empty-icon">â³</div>
                <div class="empty-title">ì‘ì—…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>
    
    <!-- ì‘ì—… ì™„ë£Œ ëª¨ë‹¬ -->
    <div id="completeModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title">ì‘ì—… ì™„ë£Œ ë³´ê³ </h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ì™„ë£Œ ì‚¬ì§„ (ì„ íƒ)</label>
                    <input type="file" id="completionPhoto" class="form-input" accept="image/*">
                </div>
                <div class="form-group">
                    <label class="form-label">ì™„ë£Œ ë©”ëª¨</label>
                    <textarea id="completionNotes" class="form-textarea" rows="4" 
                        placeholder="ì‘ì—… ì™„ë£Œ ë‚´ìš©ì´ë‚˜ íŠ¹ì´ì‚¬í•­ì„ ì‘ì„±í•˜ì„¸ìš”"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">ì‹¤ì œ ì‘ì—… ì‹œê°„ (ë¶„)</label>
                    <input type="number" id="actualDuration" class="form-input" value="120">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeCompleteModal()">
                    ì·¨ì†Œ
                </button>
                <button type="button" class="btn btn-primary" onclick="submitCompletion()">
                    ì™„ë£Œ ë³´ê³ 
                </button>
            </div>
        </div>
    </div>
    
    <script>
        let currentUser = null;
        let userProfile = null;
        let myJobs = [];
        let currentTab = 'assigned';
        let selectedJobId = null;
        
        // í˜ì´ì§€ ì´ˆê¸°í™”
        async function initPage() {
            // ì¸ì¦ í™•ì¸
            const session = await authManager.checkSession();
            if (!session || session.userType !== 'partner') {
                window.location.href = 'index.html';
                return;
            }
            
            currentUser = session.user;
            userProfile = session.profile;
            
            // ì‘ì—… ëª©ë¡ ë¡œë“œ
            await loadMyJobs();
            updateStats();
        }
        
        // ë‚´ ì‘ì—… ë¡œë“œ
        async function loadMyJobs() {
            try {
                const result = await partnersAPI.getMyJobs(currentUser.id);
                
                if (result.success && result.data) {
                    myJobs = result.data;
                    filterJobs();
                } else {
                    console.error('ì‘ì—… ë¡œë“œ ì‹¤íŒ¨:', result.error);
                    myJobs = [];
                    renderJobs([]);
                }
            } catch (error) {
                console.error('ì‘ì—… ë¡œë“œ ì˜¤ë¥˜:', error);
                myJobs = [];
                renderJobs([]);
            }
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            const today = new Date().toDateString();
            const todayJobs = myJobs.filter(job => 
                new Date(job.scheduled_date).toDateString() === today
            ).length;
            
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const weekJobs = myJobs.filter(job => 
                new Date(job.scheduled_date) >= weekStart
            ).length;
            
            const currentMonth = new Date().getMonth();
            const monthCompleted = myJobs.filter(job => 
                job.status === 'completed' && 
                new Date(job.completed_at || job.updated_at).getMonth() === currentMonth
            ).length;
            
            const monthEarnings = myJobs
                .filter(job => 
                    job.status === 'completed' && 
                    new Date(job.completed_at || job.updated_at).getMonth() === currentMonth
                )
                .reduce((sum, job) => sum + (job.final_price || job.base_price || 0), 0);
            
            document.getElementById('todayJobs').textContent = todayJobs;
            document.getElementById('weekJobs').textContent = weekJobs;
            document.getElementById('monthCompleted').textContent = monthCompleted;
            document.getElementById('monthEarnings').textContent = monthEarnings.toLocaleString('ko-KR');
        }
        
        // íƒ­ ì „í™˜
        function switchTab(tab) {
            currentTab = tab;
            
            // íƒ­ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            
            filterJobs();
        }
        
        // ì‘ì—… í•„í„°ë§
        function filterJobs() {
            let filtered = [];
            
            switch (currentTab) {
                case 'assigned':
                    filtered = myJobs.filter(job => job.status === 'assigned');
                    break;
                case 'in_progress':
                    filtered = myJobs.filter(job => job.status === 'in_progress');
                    break;
                case 'completed':
                    filtered = myJobs.filter(job => job.status === 'completed');
                    break;
                case 'applied':
                    // ì§€ì›ì¤‘ì¸ ì‘ì—…ì€ ë³„ë„ API í•„ìš”
                    filtered = [];
                    break;
            }
            
            // ë‚ ì§œìˆœ ì •ë ¬
            filtered.sort((a, b) => new Date(b.scheduled_date) - new Date(a.scheduled_date));
            
            renderJobs(filtered);
        }
        
        // ì‘ì—… ëª©ë¡ ë Œë”ë§
        function renderJobs(jobs) {
            const container = document.getElementById('jobsContainer');
            
            if (jobs.length === 0) {
                const emptyMessages = {
                    'assigned': 'ë°°ì •ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤',
                    'in_progress': 'ì§„í–‰ì¤‘ì¸ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤',
                    'completed': 'ì™„ë£Œí•œ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤',
                    'applied': 'ì§€ì›ì¤‘ì¸ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤'
                };
                
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <div class="empty-title">${emptyMessages[currentTab]}</div>
                        <div class="empty-message">
                            <a href="available-jobs.html" class="btn btn-primary">
                                ìƒˆ ì‘ì—… ì°¾ì•„ë³´ê¸°
                            </a>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = jobs.map(job => createJobCard(job)).join('');
        }
        
        // ì‘ì—… ì¹´ë“œ ìƒì„±
        function createJobCard(job) {
            const statusLabels = {
                'assigned': 'ë°°ì •ë¨',
                'in_progress': 'ì§„í–‰ì¤‘',
                'completed': 'ì™„ë£Œ',
                'pending_review': 'ë¦¬ë·° ëŒ€ê¸°'
            };
            
            const statusClasses = {
                'assigned': 'status-assigned',
                'in_progress': 'status-in_progress',
                'completed': 'status-completed',
                'pending_review': 'status-pending_review'
            };
            
            const scheduledDate = new Date(job.scheduled_date).toLocaleDateString('ko-KR');
            const scheduledTime = job.scheduled_time ? job.scheduled_time.slice(0, 5) : 'ì‹œê°„ ë¯¸ì •';
            
            return `
                <div class="job-card">
                    <span class="job-status-badge ${statusClasses[job.status]}">
                        ${statusLabels[job.status]}
                    </span>
                    
                    <div class="job-header">
                        <h3 class="job-title">${job.title}</h3>
                        <div class="job-business">
                            ğŸ¢ ${job.business?.business_name || 'ë¹„ì¦ˆë‹ˆìŠ¤'}
                        </div>
                    </div>
                    
                    <div class="job-details">
                        <div class="detail-item">
                            ğŸ“ ${job.space?.address || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ'}
                        </div>
                        <div class="detail-item">
                            ğŸ“… ${scheduledDate} ${scheduledTime}
                        </div>
                        <div class="detail-item">
                            â±ï¸ ${job.estimated_duration || 120}ë¶„ ì˜ˆìƒ
                        </div>
                        <div class="detail-item">
                            ğŸ“ ${job.business?.phone || 'ì—°ë½ì²˜ ì—†ìŒ'}
                        </div>
                    </div>
                    
                    <div class="job-price-info">
                        <span class="price-label">ì‘ì—… ìš”ê¸ˆ</span>
                        <span class="price-value">â‚©${(job.base_price || 0).toLocaleString('ko-KR')}</span>
                    </div>
                    
                    <div class="job-actions">
                        ${job.status === 'assigned' ? `
                            <button class="btn btn-primary" onclick="startJob('${job.id}')">
                                ì‘ì—… ì‹œì‘
                            </button>
                        ` : ''}
                        ${job.status === 'in_progress' ? `
                            <button class="btn btn-success" onclick="openCompleteModal('${job.id}')">
                                ì‘ì—… ì™„ë£Œ
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary" onclick="viewJobDetails('${job.id}')">
                            ìƒì„¸ë³´ê¸°
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ì‘ì—… ì‹œì‘
        async function startJob(jobId) {
            if (!confirm('ì‘ì—…ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const result = await partnersAPI.updateJobStatus(jobId, 'in_progress');
                
                if (result.success) {
                    alert('ì‘ì—…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    await loadMyJobs();
                } else {
                    alert('ì‘ì—… ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì‘ì—… ì‹œì‘ ì˜¤ë¥˜:', error);
                alert('ì‘ì—… ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ì™„ë£Œ ëª¨ë‹¬ ì—´ê¸°
        function openCompleteModal(jobId) {
            selectedJobId = jobId;
            const job = myJobs.find(j => j.id == jobId);
            if (job) {
                document.getElementById('actualDuration').value = job.estimated_duration || 120;
            }
            document.getElementById('completeModal').style.display = 'flex';
        }
        
        // ì™„ë£Œ ëª¨ë‹¬ ë‹«ê¸°
        function closeCompleteModal() {
            selectedJobId = null;
            document.getElementById('completeModal').style.display = 'none';
            document.getElementById('completionNotes').value = '';
            document.getElementById('completionPhoto').value = '';
        }
        
        // ì‘ì—… ì™„ë£Œ ì œì¶œ
        async function submitCompletion() {
            if (!selectedJobId) return;
            
            const notes = document.getElementById('completionNotes').value;
            const actualDuration = document.getElementById('actualDuration').value;
            
            try {
                const completionData = {
                    status: 'completed',
                    completion_notes: notes,
                    actual_duration: parseInt(actualDuration),
                    completed_at: new Date().toISOString()
                };
                
                const result = await partnersAPI.completeJob(selectedJobId, completionData);
                
                if (result.success) {
                    alert('ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë¹„ì¦ˆë‹ˆìŠ¤ì˜ í™•ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
                    closeCompleteModal();
                    await loadMyJobs();
                    updateStats();
                } else {
                    alert('ì‘ì—… ì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì‘ì—… ì™„ë£Œ ì˜¤ë¥˜:', error);
                alert('ì‘ì—… ì™„ë£Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ì‘ì—… ìƒì„¸ë³´ê¸°
        function viewJobDetails(jobId) {
            const job = myJobs.find(j => j.id == jobId);
            if (!job) return;
            
            alert(`ì‘ì—…: ${job.title}\nì£¼ì†Œ: ${job.space?.address}\nì¼ì •: ${new Date(job.scheduled_date).toLocaleDateString('ko-KR')}\nìš”ê¸ˆ: â‚©${job.base_price?.toLocaleString('ko-KR')}`);
        }
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        document.getElementById('completeModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCompleteModal();
            }
        });
        
        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>