<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒŒíŠ¸ë„ˆ ëŒ€ì‹œë³´ë“œ - Linky Partners</title>
    
    <!-- Styles -->
    <link rel="stylesheet" href="../shared/css/base.css">
    <link rel="stylesheet" href="../shared/css/components.css">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Config & Scripts -->
    <script src="../shared/js/config.js"></script>
    <script src="../shared/js/auth.js"></script>
    <script src="../shared/js/api.js"></script>
    
    <style>
        .dashboard-header {
            background: linear-gradient(135deg, var(--color-primary), #16a34a);
            color: white;
            margin-bottom: var(--spacing-xl);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-xl) var(--spacing-lg);
        }
        
        .welcome-section h1 {
            margin: 0;
            color: white;
        }
        
        .welcome-section p {
            margin: var(--spacing-xs) 0 0 0;
            opacity: 0.9;
        }
        
        .header-actions {
            display: flex;
            gap: var(--spacing-md);
        }
        
        .header-actions .btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .header-actions .btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .dashboard-content {
            padding: 0 var(--spacing-lg) var(--spacing-xl);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }
        
        .rating-card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--spacing-lg);
            text-align: center;
        }
        
        .rating-stars {
            font-size: var(--font-size-2xl);
            color: #fbbf24;
            margin-bottom: var(--spacing-sm);
        }
        
        .rating-value {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            color: var(--color-text);
        }
        
        .rating-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-light);
            margin-top: var(--spacing-xs);
        }
        
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }
        
        .action-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-xl);
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all var(--transition-base);
            text-decoration: none;
            color: var(--color-text);
        }
        
        .action-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            background: var(--color-surface);
        }
        
        .action-icon {
            font-size: 48px;
            margin-bottom: var(--spacing-md);
            color: var(--color-primary);
        }
        
        .action-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }
        
        .action-description {
            font-size: var(--font-size-sm);
            color: var(--color-text-light);
            text-align: center;
        }
        
        .jobs-section {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            padding: var(--spacing-lg);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }
        
        .section-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin: 0;
        }
        
        .job-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        .job-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            background: var(--color-surface);
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
            border-left: 4px solid var(--color-primary);
        }
        
        .job-card:hover {
            background: white;
            box-shadow: var(--shadow-sm);
        }
        
        .job-info {
            flex: 1;
        }
        
        .job-title {
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
            color: var(--color-text);
        }
        
        .job-meta {
            display: flex;
            gap: var(--spacing-md);
            font-size: var(--font-size-sm);
            color: var(--color-text-light);
        }
        
        .job-price {
            font-size: var(--font-size-lg);
            font-weight: 700;
            color: var(--color-primary);
        }
        
        .job-action {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: var(--spacing-sm);
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <div class="header-content">
                <div class="welcome-section">
                    <h1>ì•ˆë…•í•˜ì„¸ìš”, <span id="partnerName">íŒŒíŠ¸ë„ˆ</span>ë‹˜!</h1>
                    <p>ì˜¤ëŠ˜ë„ ë©‹ì§„ í•˜ë£¨ ë³´ë‚´ì„¸ìš” ğŸ’ª</p>
                </div>
                <div class="header-actions">
                    <button class="btn" onclick="window.location.href='profile.html'">
                        í”„ë¡œí•„ ì„¤ì •
                    </button>
                    <button class="btn" id="logoutBtn">
                        ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container dashboard-content">
        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-grid">
            <div class="rating-card">
                <div class="rating-stars">â­â­â­â­â­</div>
                <div class="rating-value" id="rating">0.0</div>
                <div class="rating-label">í‰ê·  í‰ì </div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completedJobs">0</div>
                <div class="stat-label">ì™„ë£Œí•œ ì‘ì—…</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeJobs">0</div>
                <div class="stat-label">ì§„í–‰ì¤‘ì¸ ì‘ì—…</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">â‚©<span id="monthlyEarnings">0</span></div>
                <div class="stat-label">ì´ë²ˆë‹¬ ìˆ˜ìµ</div>
            </div>
        </div>
        
        <!-- ì£¼ìš” ì•¡ì…˜ ë²„íŠ¼ -->
        <div class="action-grid">
            <a href="jobs.html?filter=available" class="action-card">
                <div class="action-icon">ğŸ”</div>
                <div class="action-title">ì‘ì—… ì°¾ê¸°</div>
                <div class="action-description">ìƒˆë¡œìš´ ì‘ì—…ì„ ì°¾ì•„ ì§€ì›í•˜ì„¸ìš”</div>
            </a>
            <a href="jobs.html?filter=my" class="action-card">
                <div class="action-icon">ğŸ“‹</div>
                <div class="action-title">ë‚´ ì‘ì—…</div>
                <div class="action-description">ì§„í–‰ì¤‘ì¸ ì‘ì—…ì„ ê´€ë¦¬í•˜ì„¸ìš”</div>
            </a>
            <a href="earnings.html" class="action-card">
                <div class="action-icon">ğŸ’°</div>
                <div class="action-title">ìˆ˜ìµ ê´€ë¦¬</div>
                <div class="action-description">ìˆ˜ìµ ë‚´ì—­ì„ í™•ì¸í•˜ì„¸ìš”</div>
            </a>
            <a href="schedule.html" class="action-card">
                <div class="action-icon">ğŸ“…</div>
                <div class="action-title">ì¼ì • ê´€ë¦¬</div>
                <div class="action-description">ì‘ì—… ì¼ì •ì„ í™•ì¸í•˜ì„¸ìš”</div>
            </a>
        </div>
        
        <!-- ëŒ€ê¸°ì¤‘ì¸ ì‘ì—… -->
        <div class="jobs-section">
            <div class="section-header">
                <h2 class="section-title">ğŸ†• ì§€ì› ê°€ëŠ¥í•œ ì‘ì—…</h2>
                <a href="jobs.html?filter=available" class="btn btn-sm btn-primary">ë” ë³´ê¸°</a>
            </div>
            <div id="availableJobs" class="job-list">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“­</div>
                    <div class="empty-state-title">í˜„ì¬ ì§€ì› ê°€ëŠ¥í•œ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    <div class="empty-state-message">ìƒˆë¡œìš´ ì‘ì—…ì´ ë“±ë¡ë˜ë©´ ì•Œë ¤ë“œë¦´ê²Œìš”!</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentUser = null;
        let userProfile = null;
        
        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        async function initDashboard() {
            // ì¸ì¦ í™•ì¸
            const session = await authManager.checkSession();
            if (!session || session.userType !== 'partner') {
                window.location.href = 'index.html';
                return;
            }
            
            currentUser = session.user;
            userProfile = session.profile;
            
            // ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ
            document.getElementById('partnerName').textContent = 
                userProfile.name || userProfile.nickname || 'íŒŒíŠ¸ë„ˆ';
            
            // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
            await loadDashboardStats();
            await loadAvailableJobs();
        }
        
        // ëŒ€ì‹œë³´ë“œ í†µê³„ ë¡œë“œ
        async function loadDashboardStats() {
            try {
                const stats = await partnerAPI.getDashboardStats(currentUser.id);
                
                if (stats.success && stats.data) {
                    // í‰ì  í‘œì‹œ
                    const rating = stats.data.rating || 0;
                    document.getElementById('rating').textContent = rating.toFixed(1);
                    
                    // ë³„ì  ì—…ë°ì´íŠ¸
                    const fullStars = Math.floor(rating);
                    const halfStar = rating % 1 >= 0.5 ? 1 : 0;
                    const emptyStars = 5 - fullStars - halfStar;
                    const starsHtml = 'â­'.repeat(fullStars) + 
                                     (halfStar ? 'â­' : '') + 
                                     'â˜†'.repeat(emptyStars);
                    document.querySelector('.rating-stars').textContent = starsHtml;
                    
                    // ê¸°íƒ€ í†µê³„
                    document.getElementById('completedJobs').textContent = stats.data.completedJobs;
                    document.getElementById('activeJobs').textContent = stats.data.activeJobs;
                    document.getElementById('monthlyEarnings').textContent = 
                        stats.data.monthlyEarnings.toLocaleString('ko-KR');
                }
            } catch (error) {
                console.error('Failed to load dashboard stats:', error);
            }
        }
        
        // ì§€ì› ê°€ëŠ¥í•œ ì‘ì—… ë¡œë“œ
        async function loadAvailableJobs() {
            try {
                const result = await partnerAPI.getAvailableJobs();
                
                if (result.success && result.data && result.data.length > 0) {
                    const jobs = result.data.slice(0, 3); // ìµœê·¼ 3ê°œë§Œ
                    const jobsHtml = jobs.map(job => createJobCard(job)).join('');
                    document.getElementById('availableJobs').innerHTML = jobsHtml;
                }
            } catch (error) {
                console.error('Failed to load available jobs:', error);
            }
        }
        
        // ì‘ì—… ì¹´ë“œ HTML ìƒì„±
        function createJobCard(job) {
            const scheduledDate = new Date(job.scheduled_date).toLocaleDateString('ko-KR');
            const scheduledTime = job.scheduled_time ? job.scheduled_time.slice(0, 5) : '';
            
            return `
                <div class="job-card">
                    <div class="job-info">
                        <div class="job-title">${job.title}</div>
                        <div class="job-meta">
                            <span>ğŸ“ ${job.space?.address || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ'}</span>
                            <span>ğŸ“… ${scheduledDate} ${scheduledTime}</span>
                            <span>â±ï¸ ${job.estimated_duration || 120}ë¶„</span>
                        </div>
                    </div>
                    <div class="job-action">
                        <div class="job-price">â‚©${(job.base_price || 0).toLocaleString('ko-KR')}</div>
                        <button class="btn btn-primary btn-sm" onclick="applyForJob('${job.id}')">
                            ì§€ì›í•˜ê¸°
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ì‘ì—… ì§€ì›
        async function applyForJob(jobId) {
            if (!confirm('ì´ ì‘ì—…ì— ì§€ì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const result = await partnerAPI.applyForJob(jobId, currentUser.id);
                
                if (result.success) {
                    alert('ì§€ì›ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    await loadAvailableJobs(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    alert('ì§€ì›ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ' + (result.error || ''));
                }
            } catch (error) {
                console.error('Failed to apply for job:', error);
                alert('ì§€ì› ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ë¡œê·¸ì•„ì›ƒ
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await authManager.logout();
            window.location.href = 'index.html';
        });
        
        // ì´ˆê¸°í™” ì‹¤í–‰
        initDashboard();
    </script>
</body>
</html>