<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linky - 테스트 데이터 생성</title>
    
        <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    
    
    <style>
        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f7fafc;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #22c55e;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        
        .section h3 {
            color: #1f2937;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #22c55e;
            color: white;
        }
        
        .btn-primary:hover {
            background: #16a34a;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .account-info {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
        }
        
        .account-info h4 {
            margin-bottom: 10px;
            color: #374151;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Linky 테스트 데이터 생성 도구</h1>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <a href="index.html" style="color: #22c55e; text-decoration: none; font-weight: 600;">← 메인 페이지로 돌아가기</a>
        </div>
        
        <div class="section">
            <h3>📋 현재 생성된 테스트 계정</h3>
            <div id="existingAccounts">
                <div class="account-info">
                    <h4>🏢 테스트 사업자 계정</h4>
                    <div>이메일: business@test.com</div>
                    <div>비밀번호: test1234</div>
                    <div>이름: 테스트카페</div>
                    <div>상태: 승인 완료</div>
                </div>
                
                <div class="account-info">
                    <h4>🤝 테스트 파트너 계정</h4>
                    <div>이메일: partner@test.com</div>
                    <div>비밀번호: test1234</div>
                    <div>이름: 김파트너</div>
                    <div>상태: 승인 완료</div>
                </div>
                
                <div class="account-info">
                    <h4>⚙️ 테스트 관리자 계정</h4>
                    <div>이메일: admin@test.com</div>
                    <div>비밀번호: test1234</div>
                    <div>이름: 관리자</div>
                    <div>상태: 활성</div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h3>👥 사용자 계정 생성</h3>
            <button onclick="createTestUsers()" class="btn btn-primary">
                테스트 사용자 생성
            </button>
            <div id="userStatus"></div>
        </div>
        
        <div class="section">
            <h3>🏢 테스트 공간 생성</h3>
            <button onclick="createTestSpaces()" class="btn btn-primary">
                테스트 공간 생성
            </button>
            <div id="spaceStatus"></div>
        </div>
        
        <div class="section">
            <h3>💼 테스트 작업 생성</h3>
            <button onclick="createTestJobs()" class="btn btn-primary">
                테스트 작업 생성
            </button>
            <div id="jobStatus"></div>
        </div>
        
        <div class="section">
            <h3>🗑️ 데이터 관리</h3>
            <button onclick="clearTestData()" class="btn btn-danger">
                테스트 데이터 삭제
            </button>
            <button onclick="checkCurrentData()" class="btn btn-secondary">
                현재 데이터 확인
            </button>
            <div id="dataStatus"></div>
        </div>
    </div>

    <!-- Supabase 설정 -->
    <script src="supabase-config.js"></script>
    <script>
        // 테스트 계정 정보
        const testAccounts = {
            business: {
                email: 'business@test.com',
                password: 'test1234',
                name: '테스트카페',
                phone: '010-1234-5678',
                type: 'business',
                status: 'approved',
                business: {
                    businessName: '강남 테스트카페',
                    businessNumber: '123-45-67890',
                    businessType: 'studyroom',
                    businessAddress: '서울시 강남구 테스트동',
                    representativeName: '김사장',
                    bankAccount: {
                        bank: '국민은행',
                        accountNumber: '1234-5678-9012',
                        accountHolder: '김사장'
                    },
                    monthlyUsage: 15,
                    totalSpent: 270000,
                    spaceCount: 2
                }
            },
            partner: {
                email: 'partner@test.com',
                password: 'test1234',
                name: '김파트너',
                phone: '010-9876-5432',
                type: 'partner',
                status: 'approved',
                partner: {
                    realName: '김정리',
                    workInfo: {
                        areas: ['강남구', '서초구'],
                        availableTimes: {
                            weekday: ['morning', 'afternoon', 'evening'],
                            weekend: ['morning', 'afternoon']
                        },
                        transportation: 'public',
                        experience: '1year'
                    },
                    performance: {
                        rating: 4.8,
                        completedJobs: 45,
                        cancelledJobs: 1,
                        totalEarnings: 540000,
                        thisMonthEarnings: 120000,
                        level: 'silver'
                    },
                    bankAccount: {
                        bank: '카카오뱅크',
                        accountNumber: '3333-4444-5555',
                        accountHolder: '김정리'
                    }
                }
            },
            admin: {
                email: 'admin@test.com',
                password: 'test1234',
                name: '관리자',
                phone: '010-0000-0000',
                type: 'admin',
                status: 'approved'
            }
        };

        // 테스트 공간 데이터
        const testSpaces = [
            {
                name: '강남 스터디룸 A',
                type: 'studyroom',
                size: 15,
                capacity: 6,
                address: {
                    fullAddress: '서울시 강남구 테스트동 123-45 3층',
                    sido: '서울시',
                    sigungu: '강남구',
                    dong: '테스트동',
                    detail: '테스트빌딩 3층 301호',
                    postalCode: '06120',
                    coordinates: { lat: 37.5172, lng: 127.0286 }
                },
                accessInfo: {
                    entrancePassword: '1234',
                    parkingAvailable: true,
                    parkingInfo: '건물 지하 1층',
                    publicTransport: '강남역 5번 출구 도보 5분'
                },
                amenities: {
                    hasToilet: true,
                    toiletLocation: 'same',
                    hasSink: true,
                    hasKitchen: false,
                    hasAircon: true,
                    hasHeating: true,
                    hasWifi: true,
                    hasCCTV: true
                },
                status: 'active'
            },
            {
                name: '서초 파티룸 B',
                type: 'partyroom',
                size: 20,
                capacity: 10,
                address: {
                    fullAddress: '서울시 서초구 테스트로 456 2층',
                    sido: '서울시',
                    sigungu: '서초구',
                    dong: '테스트동',
                    detail: '파티빌딩 2층',
                    postalCode: '06520'
                },
                status: 'active'
            }
        ];

        // Firebase 초기화 확인
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (typeof window.supabaseClient === 'undefined') {
                    showStatus('dataStatus', 'Firebase가 초기화되지 않았습니다.', 'error');
                } else {
                    showStatus('dataStatus', 'Firebase 연결 완료', 'success');
                    checkCurrentData();
                }
            }, 1000);
        });

        // 상태 메시지 표시
        function showStatus(containerId, message, type = 'success') {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // 로딩 상태 표시
        function showLoading(containerId, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="status"><span class="loading"></span>${message}</div>`;
        }

        // 테스트 사용자 생성
        async function createTestUsers() {
            showLoading('userStatus', '테스트 사용자 생성 중...');
            
            try {
                for (const [type, userData] of Object.entries(testAccounts)) {
                    try {
                        // 이미 존재하는지 확인
                        const existingUser = await checkUserExists(userData.email);
                        if (existingUser) {
                            console.log(`${type} 사용자 이미 존재:`, userData.email);
                            continue;
                        }

                        // 사용자 생성
                        const userCredential = await auth.createUserWithEmailAndPassword(
                            userData.email, 
                            userData.password
                        );
                        
                        // Firestore에 사용자 정보 저장
                        const userDoc = {
                            uid: userCredential.user.uid,
                            email: userData.email,
                            name: userData.name,
                            phone: userData.phone,
                            type: userData.type,
                            status: userData.status,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };

                        // 타입별 추가 정보
                        if (userData.business) {
                            userDoc.business = userData.business;
                        }
                        if (userData.partner) {
                            userDoc.partner = userData.partner;
                        }

                        await db.collection('users').doc(userCredential.user.uid).set(userDoc);
                        
                        console.log(`${type} 사용자 생성 완료:`, userData.email);
                        
                        // 로그아웃 (다음 사용자 생성을 위해)
                        await auth.signOut();
                        
                    } catch (error) {
                        if (error.code === 'auth/email-already-in-use') {
                            console.log(`${type} 사용자 이미 존재:`, userData.email);
                        } else {
                            throw error;
                        }
                    }
                }
                
                showStatus('userStatus', '테스트 사용자 생성 완료!', 'success');
                
            } catch (error) {
                console.error('사용자 생성 오류:', error);
                showStatus('userStatus', `오류: ${error.message}`, 'error');
            }
        }

        // 사용자 존재 여부 확인
        async function checkUserExists(email) {
            try {
                const snapshot = await db.collection('users')
                    .where('email', '==', email)
                    .get();
                return !snapshot.empty;
            } catch (error) {
                return false;
            }
        }

        // 테스트 공간 생성
        async function createTestSpaces() {
            showLoading('spaceStatus', '테스트 공간 생성 중...');
            
            try {
                // 사업자 계정 찾기
                const businessSnapshot = await db.collection('users')
                    .where('email', '==', 'business@test.com')
                    .get();
                
                if (businessSnapshot.empty) {
                    throw new Error('테스트 사업자 계정을 찾을 수 없습니다. 먼저 사용자를 생성하세요.');
                }
                
                const businessUser = businessSnapshot.docs[0];
                const businessId = businessUser.id;
                
                // 공간 생성
                for (const spaceData of testSpaces) {
                    const space = {
                        ...spaceData,
                        ownerId: businessId,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        stats: {
                            totalJobs: 0,
                            thisMonthJobs: 0,
                            averageRating: 0
                        }
                    };
                    
                    await db.collection('spaces').add(space);
                }
                
                showStatus('spaceStatus', '테스트 공간 생성 완료!', 'success');
                
            } catch (error) {
                console.error('공간 생성 오류:', error);
                showStatus('spaceStatus', `오류: ${error.message}`, 'error');
            }
        }

        // 테스트 작업 생성
        async function createTestJobs() {
            showLoading('jobStatus', '테스트 작업 생성 중...');
            
            try {
                // 사업자와 공간 정보 가져오기
                const businessSnapshot = await db.collection('users')
                    .where('email', '==', 'business@test.com')
                    .get();
                
                const spacesSnapshot = await db.collection('spaces')
                    .limit(1)
                    .get();
                
                if (businessSnapshot.empty || spacesSnapshot.empty) {
                    throw new Error('테스트 사용자나 공간이 없습니다. 먼저 생성하세요.');
                }
                
                const businessId = businessSnapshot.docs[0].id;
                const spaceId = spacesSnapshot.docs[0].id;
                
                // 다양한 상태의 작업 생성
                const jobStatuses = ['pending', 'matched', 'completed'];
                
                for (let i = 0; i < 3; i++) {
                    const now = new Date();
                    const requestDate = new Date(now.getTime() + (i * 24 * 60 * 60 * 1000));
                    
                    const jobData = {
                        jobId: `JOB-${now.toISOString().split('T')[0].replace(/-/g, '')}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`,
                        spaceId: spaceId,
                        businessId: businessId,
                        partnerId: jobStatuses[i] !== 'pending' ? 'partner_id_placeholder' : null,
                        status: jobStatuses[i],
                        
                        schedule: {
                            requestedDate: requestDate.toISOString().split('T')[0],
                            requestedTime: '14:00',
                            urgency: 'normal',
                            estimatedDuration: 30,
                            flexibleTime: true
                        },
                        
                        services: {
                            basic: {
                                selected: true,
                                price: 12000,
                                details: "기본 정리정돈, 쓰레기 처리, 소모품 보충"
                            },
                            floor: {
                                selected: i % 2 === 0,
                                price: i % 2 === 0 ? 3000 : 0,
                                size: "15평 이하"
                            },
                            dishes: {
                                selected: false,
                                price: 0,
                                quantity: null
                            },
                            toilet: {
                                selected: i === 2,
                                price: i === 2 ? 3000 : 0,
                                count: i === 2 ? 1 : 0
                            }
                        },
                        
                        pricing: {
                            basePrice: 12000,
                            additionalServices: (i % 2 === 0 ? 3000 : 0) + (i === 2 ? 3000 : 0),
                            urgencyFee: 0,
                            discount: 0,
                            totalPrice: 12000 + (i % 2 === 0 ? 3000 : 0) + (i === 2 ? 3000 : 0),
                            commission: Math.floor((12000 + (i % 2 === 0 ? 3000 : 0) + (i === 2 ? 3000 : 0)) * 0.2),
                            partnerEarnings: Math.floor((12000 + (i % 2 === 0 ? 3000 : 0) + (i === 2 ? 3000 : 0)) * 0.8)
                        },
                        
                        matching: {
                            requestedAt: new Date().toISOString(),
                            notifiedPartners: [],
                            rejectedBy: [],
                            acceptedAt: jobStatuses[i] !== 'pending' ? new Date().toISOString() : null,
                            matchingAttempts: 1
                        },
                        
                        execution: null,
                        evidence: {
                            beforePhotos: [],
                            afterPhotos: [],
                            additionalPhotos: []
                        },
                        
                        review: {
                            businessRating: null,
                            businessComment: null,
                            partnerRating: null,
                            partnerComment: null,
                            reviewedAt: null
                        },
                        
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        completedAt: jobStatuses[i] === 'completed' ? new Date().toISOString() : null,
                        cancelledAt: null,
                        cancelReason: null
                    };
                    
                    await db.collection('jobs').add(jobData);
                }
                
                showStatus('jobStatus', '테스트 작업 생성 완료!', 'success');
                
            } catch (error) {
                console.error('작업 생성 오류:', error);
                showStatus('jobStatus', `오류: ${error.message}`, 'error');
            }
        }

        // 현재 데이터 확인
        async function checkCurrentData() {
            showLoading('dataStatus', '데이터 확인 중...');
            
            try {
                const [usersSnapshot, spacesSnapshot, jobsSnapshot] = await Promise.all([
                    db.collection('users').get(),
                    db.collection('spaces').get(),
                    db.collection('jobs').get()
                ]);
                
                const users = {};
                usersSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (!users[data.type]) users[data.type] = 0;
                    users[data.type]++;
                });
                
                const message = `
                    📊 현재 데이터 현황:<br>
                    👥 사용자: ${usersSnapshot.size}명 (사업자: ${users.business || 0}, 파트너: ${users.partner || 0}, 관리자: ${users.admin || 0})<br>
                    🏢 공간: ${spacesSnapshot.size}개<br>
                    💼 작업: ${jobsSnapshot.size}개
                `;
                
                showStatus('dataStatus', message, 'success');
                
            } catch (error) {
                console.error('데이터 확인 오류:', error);
                showStatus('dataStatus', `오류: ${error.message}`, 'error');
            }
        }

        // 테스트 데이터 삭제
        async function clearTestData() {
            if (!confirm('정말 모든 테스트 데이터를 삭제하시겠습니까?')) return;
            
            showLoading('dataStatus', '테스트 데이터 삭제 중...');
            
            try {
                // 모든 컬렉션의 문서 삭제
                const collections = ['users', 'spaces', 'jobs'];
                
                for (const collectionName of collections) {
                    const snapshot = await db.collection(collectionName).get();
                    const batch = db.batch();
                    
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    if (snapshot.docs.length > 0) {
                        await batch.commit();
                    }
                }
                
                showStatus('dataStatus', '테스트 데이터 삭제 완료!', 'success');
                
            } catch (error) {
                console.error('데이터 삭제 오류:', error);
                showStatus('dataStatus', `오류: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>