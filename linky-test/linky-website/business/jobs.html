<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>작업 관리 - Linky Business</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Supabase 설정 -->
    <script src="../supabase-config.js"></script>
    
    <!-- 인증 및 API -->
    <script src="../js/auth/auth-manager.js"></script>
    <script src="../js/auth/business-auth.js"></script>
    <script src="../js/api/business-api.js"></script>
    <script src="../js/auth-utils.js"></script>
    
    <!-- 공통 스타일 -->
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/components.css">
    
    <style>
        .jobs-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            background: #f8fafc;
            min-height: calc(100vh - 200px);
        }
        
        .page-header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .page-title {
            font-size: 32px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 12px;
        }
        
        .page-subtitle {
            color: #6b7280;
            font-size: 16px;
        }
        
        /* 탭 네비게이션 */
        .tabs {
            display: flex;
            gap: 2px;
            background: #e5e7eb;
            padding: 2px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .tab {
            flex: 1;
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .tab:hover {
            color: #374151;
        }
        
        .tab.active {
            background: white;
            color: #22c55e;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ef4444;
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }
        
        /* 작업 목록 */
        .jobs-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .job-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .job-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        
        .job-header {
            padding: 24px;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .job-title {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .job-meta {
            display: flex;
            gap: 20px;
            color: #6b7280;
            font-size: 14px;
        }
        
        .job-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .job-body {
            padding: 24px;
        }
        
        .job-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .detail-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
        }
        
        .detail-value {
            font-weight: 600;
            color: #1f2937;
        }
        
        /* 파트너 신청 섹션 */
        .applications-section {
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }
        
        .applications-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .applications-title {
            font-weight: 600;
            color: #374151;
        }
        
        .applications-count {
            background: #22c55e;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .applications-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .application-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .partner-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .partner-avatar {
            width: 48px;
            height: 48px;
            background: #e5e7eb;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .partner-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .partner-name {
            font-weight: 600;
            color: #1f2937;
        }
        
        .partner-stats {
            display: flex;
            gap: 12px;
            font-size: 14px;
            color: #6b7280;
        }
        
        .partner-rating {
            color: #fbbf24;
        }
        
        .application-actions {
            display: flex;
            gap: 8px;
        }
        
        /* 상태 배지 */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-badge.accepted {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status-badge.in_progress {
            background: #e0e7ff;
            color: #3730a3;
        }
        
        .status-badge.completed {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-badge.cancelled {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* 버튼 */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .btn-primary {
            background: #22c55e;
            color: white;
        }
        
        .btn-primary:hover {
            background: #16a34a;
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        /* 빈 상태 */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .empty-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }
        
        .empty-title {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 12px;
        }
        
        .empty-description {
            color: #6b7280;
            font-size: 16px;
            margin-bottom: 30px;
        }
        
        /* 로딩 */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f4f6;
            border-top: 5px solid #22c55e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 모달 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            padding: 30px;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
        }
        
        .modal-body {
            margin-bottom: 30px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
    </style>
</head>
<body>
    <!-- 헤더 -->
    <header id="header"></header>
    
    <!-- 작업 관리 컨테이너 -->
    <div class="jobs-container">
        <!-- 페이지 헤더 -->
        <div class="page-header">
            <h1 class="page-title">작업 관리</h1>
            <p class="page-subtitle">정리 요청과 진행 상황을 한눈에 확인하세요</p>
        </div>
        
        <!-- 탭 네비게이션 -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('all')" id="tab-all">
                전체
            </button>
            <button class="tab" onclick="switchTab('pending')" id="tab-pending">
                대기 중
                <span class="tab-badge" id="pending-count" style="display: none;">0</span>
            </button>
            <button class="tab" onclick="switchTab('accepted')" id="tab-accepted">
                파트너 배정
            </button>
            <button class="tab" onclick="switchTab('in_progress')" id="tab-in_progress">
                진행 중
            </button>
            <button class="tab" onclick="switchTab('completed')" id="tab-completed">
                완료
            </button>
        </div>
        
        <!-- 로딩 상태 -->
        <div id="loadingState" class="loading-container" style="display: none;">
            <div class="loading-spinner"></div>
        </div>
        
        <!-- 작업 목록 -->
        <div id="jobsContent" style="display: none;">
            <div id="jobsList" class="jobs-list"></div>
            
            <!-- 빈 상태 -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-icon">📋</div>
                <h2 class="empty-title">작업이 없습니다</h2>
                <p class="empty-description" id="emptyDescription">
                    아직 등록된 작업이 없습니다.
                </p>
                <a href="create-job.html" class="btn btn-primary">
                    첫 정리 요청하기
                </a>
            </div>
        </div>
    </div>
    
    <!-- 푸터 -->
    <footer id="footer"></footer>
    
    <!-- 파트너 승인 모달 -->
    <div id="approveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">파트너 승인</h2>
            </div>
            <div class="modal-body">
                <p>이 파트너에게 작업을 맡기시겠습니까?</p>
                <div style="margin-top: 20px; padding: 16px; background: #f9fafb; border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 8px;" id="modalPartnerName">-</div>
                    <div style="font-size: 14px; color: #6b7280;">
                        평점: <span id="modalPartnerRating">-</span> | 
                        완료 작업: <span id="modalPartnerJobs">-</span>건
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">취소</button>
                <button class="btn btn-primary" onclick="confirmApproval()">승인</button>
            </div>
        </div>
    </div>
    
    <script>
        // 전역 변수
        let currentUser = null;
        let businessProfile = null;
        let currentTab = 'all';
        let allJobs = [];
        let pendingApproval = null;
        
        // 페이지 초기화
        async function initializePage() {
            try {
                showLoading(true);
                
                // 세션 확인
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (!session) {
                    window.location.href = './index.html';
                    return;
                }
                
                currentUser = session.user;
                
                // 비즈니스 프로필 확인
                const { data: profile, error } = await window.supabaseClient
                    .from('businesses')
                    .select('*')
                    .eq('auth_uid', currentUser.id)
                    .single();
                
                if (error || !profile) {
                    alert('프로필을 불러올 수 없습니다.');
                    window.location.href = 'dashboard.html';
                    return;
                }
                
                businessProfile = profile;
                
                // URL 파라미터 확인
                const urlParams = new URLSearchParams(window.location.search);
                const status = urlParams.get('status');
                if (status) {
                    currentTab = status;
                }
                
                // 작업 목록 로드
                await loadJobs();
                
            } catch (error) {
                console.error('초기화 오류:', error);
                alert('페이지 로드 중 오류가 발생했습니다.');
            } finally {
                showLoading(false);
            }
        }
        
        // 작업 목록 로드
        async function loadJobs() {
            try {
                // 작업 목록 조회 (관련 정보 포함)
                const { data: jobs, error } = await window.supabaseClient
                    .from('jobs')
                    .select(`
                        *,
                        space:spaces(*),
                        job_applications(
                            *,
                            partner:partners(*)
                        )
                    `)
                    .eq('business_id', currentUser.id)  // auth_uid 사용
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                allJobs = jobs || [];
                displayJobs();
                updateTabCounts();
                
            } catch (error) {
                console.error('작업 로드 오류:', error);
                alert('작업 목록을 불러올 수 없습니다.');
            }
        }
        
        // 작업 목록 표시
        function displayJobs() {
            const filteredJobs = filterJobsByTab();
            const container = document.getElementById('jobsList');
            const emptyState = document.getElementById('emptyState');
            
            if (filteredJobs.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                updateEmptyMessage();
                return;
            }
            
            container.style.display = 'block';
            emptyState.style.display = 'none';
            
            container.innerHTML = filteredJobs.map(job => {
                const pendingApplications = job.job_applications?.filter(app => app.status === 'pending') || [];
                
                return `
                    <div class="job-card">
                        <div class="job-header">
                            <h3 class="job-title">${job.title}</h3>
                            <div class="job-meta">
                                <div class="job-meta-item">
                                    <span>🏢</span>
                                    <span>${job.space?.name || '-'}</span>
                                </div>
                                <div class="job-meta-item">
                                    <span>📅</span>
                                    <span>${new Date(job.preferred_date).toLocaleDateString()}</span>
                                </div>
                                <div class="job-meta-item">
                                    <span class="status-badge ${job.status}">
                                        ${getStatusText(job.status)}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="job-body">
                            <div class="job-details">
                                <div class="detail-item">
                                    <span class="detail-label">작업 유형</span>
                                    <span class="detail-value">${getJobTypeText(job.type)}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">예상 비용</span>
                                    <span class="detail-value">₩${(job.price || 0).toLocaleString()}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">희망 시간</span>
                                    <span class="detail-value">${getTimeText(job.preferred_time)}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">긴급도</span>
                                    <span class="detail-value">${getUrgencyText(job.urgency)}</span>
                                </div>
                            </div>
                            
                            ${job.description ? `
                                <div style="margin-top: 16px; padding: 12px; background: #f9fafb; border-radius: 8px;">
                                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">요청사항</div>
                                    <div style="color: #1f2937;">${job.description}</div>
                                </div>
                            ` : ''}
                            
                            ${job.status === 'pending' && pendingApplications.length > 0 ? `
                                <div class="applications-section">
                                    <div class="applications-header">
                                        <span class="applications-title">파트너 신청</span>
                                        <span class="applications-count">${pendingApplications.length}명</span>
                                    </div>
                                    <div class="applications-list">
                                        ${pendingApplications.map(app => `
                                            <div class="application-item">
                                                <div class="partner-info">
                                                    <div class="partner-avatar">👷</div>
                                                    <div class="partner-details">
                                                        <div class="partner-name">${app.partner?.name || '파트너'}</div>
                                                        <div class="partner-stats">
                                                            <span class="partner-rating">⭐ ${app.partner?.rating || 0}</span>
                                                            <span>완료 ${app.partner?.completed_jobs || 0}건</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="application-actions">
                                                    <button class="btn btn-sm btn-primary" 
                                                            onclick="approvePartner('${job.id}', '${app.id}', '${app.partner_id}', '${app.partner?.name}', ${app.partner?.rating || 0}, ${app.partner?.completed_jobs || 0})">
                                                        승인
                                                    </button>
                                                    <button class="btn btn-sm btn-secondary" 
                                                            onclick="rejectPartner('${job.id}', '${app.id}')">
                                                        거절
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${job.status === 'accepted' || job.status === 'in_progress' ? `
                                <div style="margin-top: 16px; padding: 12px; background: #f0fdf4; border-radius: 8px;">
                                    <div style="font-size: 12px; color: #166534; margin-bottom: 4px;">담당 파트너</div>
                                    <div style="color: #1f2937; font-weight: 600;">
                                        ${job.partner?.name || '파트너 배정됨'}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // 탭별 작업 필터링
        function filterJobsByTab() {
            if (currentTab === 'all') {
                return allJobs;
            }
            return allJobs.filter(job => job.status === currentTab);
        }
        
        // 탭 전환
        function switchTab(tab) {
            currentTab = tab;
            
            // 탭 활성화 상태 업데이트
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            // 작업 목록 다시 표시
            displayJobs();
        }
        
        // 탭 카운트 업데이트
        function updateTabCounts() {
            const counts = {
                pending: allJobs.filter(j => j.status === 'pending').length,
                accepted: allJobs.filter(j => j.status === 'accepted').length,
                in_progress: allJobs.filter(j => j.status === 'in_progress').length,
                completed: allJobs.filter(j => j.status === 'completed').length
            };
            
            // 대기 중 카운트 표시
            const pendingCount = document.getElementById('pending-count');
            if (counts.pending > 0) {
                pendingCount.textContent = counts.pending;
                pendingCount.style.display = 'inline-block';
            } else {
                pendingCount.style.display = 'none';
            }
        }
        
        // 빈 상태 메시지 업데이트
        function updateEmptyMessage() {
            const messages = {
                all: '아직 등록된 작업이 없습니다.',
                pending: '대기 중인 작업이 없습니다.',
                accepted: '파트너가 배정된 작업이 없습니다.',
                in_progress: '진행 중인 작업이 없습니다.',
                completed: '완료된 작업이 없습니다.'
            };
            
            document.getElementById('emptyDescription').textContent = messages[currentTab] || messages.all;
        }
        
        // 파트너 승인
        function approvePartner(jobId, applicationId, partnerId, partnerName, rating, completedJobs) {
            pendingApproval = { jobId, applicationId, partnerId };
            
            // 모달에 정보 표시
            document.getElementById('modalPartnerName').textContent = partnerName;
            document.getElementById('modalPartnerRating').textContent = rating.toFixed(1);
            document.getElementById('modalPartnerJobs').textContent = completedJobs;
            
            // 모달 열기
            document.getElementById('approveModal').classList.add('active');
        }
        
        // 승인 확인
        async function confirmApproval() {
            if (!pendingApproval) return;
            
            try {
                // 1. 신청 승인
                const { error: appError } = await window.supabaseClient
                    .from('job_applications')
                    .update({ status: 'accepted' })
                    .eq('id', pendingApproval.applicationId);
                
                if (appError) throw appError;
                
                // 2. 작업 상태 업데이트 및 파트너 할당
                const { error: jobError } = await window.supabaseClient
                    .from('jobs')
                    .update({ 
                        status: 'accepted',
                        partner_id: pendingApproval.partnerId
                    })
                    .eq('id', pendingApproval.jobId);
                
                if (jobError) throw jobError;
                
                // 3. 다른 신청 거절
                const { error: rejectError } = await window.supabaseClient
                    .from('job_applications')
                    .update({ status: 'rejected' })
                    .eq('job_id', pendingApproval.jobId)
                    .neq('id', pendingApproval.applicationId)
                    .eq('status', 'pending');
                
                if (rejectError) console.error('다른 신청 거절 오류:', rejectError);
                
                alert('파트너가 승인되었습니다!');
                closeModal();
                await loadJobs();
                
            } catch (error) {
                console.error('승인 오류:', error);
                alert('승인 처리 중 오류가 발생했습니다.');
            }
        }
        
        // 파트너 거절
        async function rejectPartner(jobId, applicationId) {
            if (!confirm('이 파트너의 신청을 거절하시겠습니까?')) return;
            
            try {
                const { error } = await window.supabaseClient
                    .from('job_applications')
                    .update({ status: 'rejected' })
                    .eq('id', applicationId);
                
                if (error) throw error;
                
                alert('신청이 거절되었습니다.');
                await loadJobs();
                
            } catch (error) {
                console.error('거절 오류:', error);
                alert('거절 처리 중 오류가 발생했습니다.');
            }
        }
        
        // 모달 닫기
        function closeModal() {
            document.getElementById('approveModal').classList.remove('active');
            pendingApproval = null;
        }
        
        // 상태 텍스트
        function getStatusText(status) {
            const texts = {
                pending: '대기 중',
                accepted: '파트너 배정',
                in_progress: '진행 중',
                completed: '완료',
                cancelled: '취소됨'
            };
            return texts[status] || status;
        }
        
        // 작업 유형 텍스트
        function getJobTypeText(type) {
            const texts = {
                regular: '정기 청소',
                deep: '대청소',
                move_in: '입주 청소',
                move_out: '이사 청소',
                emergency: '긴급 청소'
            };
            return texts[type] || type;
        }
        
        // 시간대 텍스트
        function getTimeText(time) {
            const texts = {
                morning: '오전',
                afternoon: '오후',
                evening: '저녁',
                flexible: '시간 무관'
            };
            return texts[time] || time;
        }
        
        // 긴급도 텍스트
        function getUrgencyText(urgency) {
            const texts = {
                normal: '보통',
                urgent: '긴급',
                very_urgent: '매우 긴급'
            };
            return texts[urgency] || urgency;
        }
        
        // 로딩 표시
        function showLoading(show) {
            document.getElementById('loadingState').style.display = show ? 'flex' : 'none';
            document.getElementById('jobsContent').style.display = show ? 'none' : 'block';
        }
        
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', () => {
            // 헤더/푸터 로드
            loadComponent('header', '../components/header.html');
            loadComponent('footer', '../components/footer.html');
            
            // 페이지 초기화
            initializePage();
        });
        
        // 컴포넌트 로드 함수
        async function loadComponent(id, path) {
            try {
                const response = await fetch(path);
                const html = await response.text();
                document.getElementById(id).innerHTML = html;
            } catch (error) {
                console.error(`${id} 로드 오류:`, error);
            }
        }
    </script>
</body>
</html>