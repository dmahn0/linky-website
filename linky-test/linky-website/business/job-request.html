<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linky - ì •ë¦¬ ì„œë¹„ìŠ¤ ìš”ì²­</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <!-- Firebase ì„¤ì • -->
    <script src="../firebase-config.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: #2d3748;
            background: #f7fafc;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
            color: #1a202c;
        }

        .header p {
            color: #6b7280;
        }

        .form-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .form-section h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #1a202c;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .service-options {
            display: grid;
            gap: 15px;
        }

        .service-option {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .service-option:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }

        .service-option.selected {
            border-color: #22c55e;
            background: #f0fdf4;
        }

        .service-option input[type="checkbox"] {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 20px;
            height: 20px;
        }

        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .service-name {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
        }

        .service-price {
            font-size: 16px;
            font-weight: bold;
            color: #22c55e;
        }

        .service-description {
            color: #6b7280;
            font-size: 14px;
            line-height: 1.5;
        }

        .urgency-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .urgency-option {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .urgency-option:hover {
            border-color: #3b82f6;
        }

        .urgency-option.selected {
            border-color: #22c55e;
            background: #f0fdf4;
        }

        .urgency-option input[type="radio"] {
            display: none;
        }

        .urgency-title {
            font-size: 16px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .urgency-desc {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .urgency-fee {
            font-size: 14px;
            font-weight: bold;
            color: #ef4444;
        }

        .price-summary {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .price-summary h3 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #1f2937;
        }

        .price-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
        }

        .price-item.total {
            border-top: 1px solid #e2e8f0;
            padding-top: 10px;
            margin-top: 10px;
            font-weight: bold;
            font-size: 18px;
        }

        .price-item.total .price {
            color: #22c55e;
            font-size: 20px;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            text-decoration: none;
        }

        .btn:hover {
            background: #2563eb;
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #22c55e;
        }

        .btn-primary:hover {
            background: #16a34a;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .help-text {
            font-size: 14px;
            color: #6b7280;
            margin-top: 5px;
        }

        .required {
            color: #ef4444;
        }

        .loading {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .space-info {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .space-info h3 {
            color: #166534;
            margin-bottom: 10px;
        }

        .space-info p {
            color: #15803d;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .urgency-options {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§¹ ì •ë¦¬ ì„œë¹„ìŠ¤ ìš”ì²­</h1>
            <p>ê³µê°„ì„ ì„ íƒí•˜ê³  í•„ìš”í•œ ì„œë¹„ìŠ¤ë¥¼ ìš”ì²­í•˜ì„¸ìš”</p>
        </div>

        <div class="alert" id="alertMessage"></div>

        <!-- ê³µê°„ ì •ë³´ -->
        <div id="spaceInfo" class="space-info" style="display: none;">
            <h3>ì„ íƒëœ ê³µê°„</h3>
            <p id="spaceName"></p>
            <p id="spaceAddress"></p>
            <p id="spaceSize"></p>
        </div>

        <form id="jobRequestForm">
            <!-- ê³µê°„ ì„ íƒ -->
            <div class="form-section">
                <h2>ğŸ¢ ê³µê°„ ì„ íƒ</h2>
                
                <div class="form-group">
                    <label for="spaceSelect">ê³µê°„ ì„ íƒ <span class="required">*</span></label>
                    <select id="spaceSelect" name="spaceId" required>
                        <option value="">ë¡œë”© ì¤‘...</option>
                    </select>
                </div>
            </div>

            <!-- ì„œë¹„ìŠ¤ ì„ íƒ -->
            <div class="form-section">
                <h2>ğŸ› ï¸ ì„œë¹„ìŠ¤ ì„ íƒ</h2>
                
                <div class="service-options">
                    <div class="service-option" onclick="toggleService('basic')">
                        <input type="checkbox" id="basic" name="services" value="basic" checked>
                        <div class="service-header">
                            <span class="service-name">ê¸°ë³¸ ì •ë¦¬</span>
                            <span class="service-price">12,000ì›</span>
                        </div>
                        <div class="service-description">
                            ê¸°ë³¸ì ì¸ ì •ë¦¬ì •ëˆ, ì“°ë ˆê¸° ì²˜ë¦¬, ì†Œëª¨í’ˆ ë³´ì¶© (íœ´ì§€, ë¬¼í‹°ìŠˆ ë“±)
                        </div>
                    </div>

                    <div class="service-option" onclick="toggleService('floor')">
                        <input type="checkbox" id="floor" name="services" value="floor">
                        <div class="service-header">
                            <span class="service-name">ë°”ë‹¥ ì²­ì†Œ</span>
                            <span class="service-price">+3,000ì›</span>
                        </div>
                        <div class="service-description">
                            ë°”ë‹¥ ì§„ê³µì²­ì†Œê¸° ë° ë¬¼ê±¸ë ˆì§ˆ (15í‰ ì´í•˜ ê¸°ì¤€)
                        </div>
                    </div>

                    <div class="service-option" onclick="toggleService('toilet')">
                        <input type="checkbox" id="toilet" name="services" value="toilet">
                        <div class="service-header">
                            <span class="service-name">í™”ì¥ì‹¤ ì²­ì†Œ</span>
                            <span class="service-price">+3,000ì›</span>
                        </div>
                        <div class="service-description">
                            í™”ì¥ì‹¤ ì²­ì†Œ ë° ì†Œë…, íœ´ì§€ êµì²´
                        </div>
                    </div>

                    <div class="service-option" onclick="toggleService('dishes')">
                        <input type="checkbox" id="dishes" name="services" value="dishes">
                        <div class="service-header">
                            <span class="service-name">ì„¤ê±°ì§€</span>
                            <span class="service-price">+2,000ì›</span>
                        </div>
                        <div class="service-description">
                            ì»µ, ì ‘ì‹œ ë“± ê°„ë‹¨í•œ ì„¤ê±°ì§€ (10ê°œ ì´í•˜)
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì¼ì • ì„ íƒ -->
            <div class="form-section">
                <h2>ğŸ“… ì¼ì • ì„ íƒ</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="requestDate">ìš”ì²­ ë‚ ì§œ <span class="required">*</span></label>
                        <input type="date" id="requestDate" name="requestDate" required>
                    </div>

                    <div class="form-group">
                        <label for="requestTime">ìš”ì²­ ì‹œê°„ <span class="required">*</span></label>
                        <input type="time" id="requestTime" name="requestTime" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>ê¸´ê¸‰ë„ ì„ íƒ</label>
                    <div class="urgency-options">
                        <div class="urgency-option selected" onclick="selectUrgency('normal')">
                            <input type="radio" id="normal" name="urgency" value="normal" checked>
                            <div class="urgency-title">ì¼ë°˜ ìš”ì²­</div>
                            <div class="urgency-desc">24ì‹œê°„ ë‚´</div>
                            <div class="urgency-fee">ì¶”ê°€ ìš”ê¸ˆ ì—†ìŒ</div>
                        </div>

                        <div class="urgency-option" onclick="selectUrgency('urgent4h')">
                            <input type="radio" id="urgent4h" name="urgency" value="urgent4h">
                            <div class="urgency-title">ê¸´ê¸‰ ìš”ì²­</div>
                            <div class="urgency-desc">4ì‹œê°„ ë‚´</div>
                            <div class="urgency-fee">+10,000ì›</div>
                        </div>

                        <div class="urgency-option" onclick="selectUrgency('urgent2h')">
                            <input type="radio" id="urgent2h" name="urgency" value="urgent2h">
                            <div class="urgency-title">ì´ˆê¸´ê¸‰ ìš”ì²­</div>
                            <div class="urgency-desc">2ì‹œê°„ ë‚´</div>
                            <div class="urgency-fee">+20,000ì›</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì¶”ê°€ ìš”ì²­ì‚¬í•­ -->
            <div class="form-section">
                <h2>ğŸ“ ì¶”ê°€ ìš”ì²­ì‚¬í•­</h2>
                
                <div class="form-group">
                    <label for="customRequests">íŠ¹ë³„ ìš”ì²­ì‚¬í•­</label>
                    <textarea id="customRequests" name="customRequests" 
                              placeholder="ì˜ˆ: íšŒì˜ì‹¤ í…Œì´ë¸” ë°°ì¹˜ëŠ” ã…ìë¡œ í•´ì£¼ì„¸ìš”, ì»¤í”¼ë¨¸ì‹  ë¬¼í†µ êµì²´ ë“±"></textarea>
                    <div class="help-text">ì¶”ê°€ ìš”ì²­ì‚¬í•­ì´ ìˆìœ¼ë©´ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”</div>
                </div>
            </div>

            <!-- ê°€ê²© ìš”ì•½ -->
            <div class="price-summary">
                <h3>ğŸ’° ìš”ê¸ˆ ì •ë³´</h3>
                <div class="price-item">
                    <span>ê¸°ë³¸ ì •ë¦¬</span>
                    <span class="price">12,000ì›</span>
                </div>
                <div class="price-item" id="floorPrice" style="display: none;">
                    <span>ë°”ë‹¥ ì²­ì†Œ</span>
                    <span class="price">+3,000ì›</span>
                </div>
                <div class="price-item" id="toiletPrice" style="display: none;">
                    <span>í™”ì¥ì‹¤ ì²­ì†Œ</span>
                    <span class="price">+3,000ì›</span>
                </div>
                <div class="price-item" id="dishesPrice" style="display: none;">
                    <span>ì„¤ê±°ì§€</span>
                    <span class="price">+2,000ì›</span>
                </div>
                <div class="price-item" id="urgencyPrice" style="display: none;">
                    <span>ê¸´ê¸‰ ìš”ì²­</span>
                    <span class="price">+0ì›</span>
                </div>
                <div class="price-item total">
                    <span>ì´ ìš”ê¸ˆ</span>
                    <span class="price" id="totalPrice">12,000ì›</span>
                </div>
            </div>

            <div class="btn-group">
                <button type="button" class="btn btn-secondary" onclick="history.back()">ì·¨ì†Œ</button>
                <button type="submit" class="btn btn-primary">
                    <span class="btn-text">ì •ë¦¬ ì„œë¹„ìŠ¤ ìš”ì²­í•˜ê¸°</span>
                    <span class="loading"></span>
                </button>
            </div>
        </form>
    </div>

    <script>
        let currentUser = null;
        let userSpaces = [];
        let selectedSpaceId = null;
        let totalPrice = 12000;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ë³¸ê°’ ì„¤ì •
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('requestDate').value = today;
            document.getElementById('requestDate').min = today;

            // í˜„ì¬ ì‹œê°„ + 1ì‹œê°„ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
            const now = new Date();
            now.setHours(now.getHours() + 1);
            const timeStr = now.toTimeString().slice(0, 5);
            document.getElementById('requestTime').value = timeStr;

            // URL íŒŒë¼ë¯¸í„°ì—ì„œ spaceId í™•ì¸
            const urlParams = new URLSearchParams(window.location.search);
            selectedSpaceId = urlParams.get('spaceId');

            // Firebase ì´ˆê¸°í™” ëŒ€ê¸°
            setTimeout(() => {
                if (typeof auth !== 'undefined') {
                    auth.onAuthStateChanged((user) => {
                        if (user) {
                            checkBusinessUser(user);
                        } else {
                            // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (í˜„ì¬ í˜ì´ì§€ë¥¼ redirect íŒŒë¼ë¯¸í„°ë¡œ)
                            const currentPage = window.location.pathname.split('/').pop();
                            window.location.href = `index.html?redirect=${encodeURIComponent(currentPage)}`;
                        }
                    });
                } else {
                    alert('Firebase ì´ˆê¸°í™” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    window.location.href = '../index.html';
                }
            }, 1000);
        });

        // ì‚¬ì—…ì ê³„ì • í™•ì¸ ë° ê³µê°„ ë¡œë“œ
        async function checkBusinessUser(user) {
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    if (userData.type === 'business' && userData.status === 'approved') {
                        currentUser = { ...user, ...userData };
                        await loadUserSpaces();
                        return;
                    }
                }
                // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (í˜„ì¬ í˜ì´ì§€ë¥¼ redirect íŒŒë¼ë¯¸í„°ë¡œ)
                const currentPage = window.location.pathname.split('/').pop();
                window.location.href = `index.html?redirect=${encodeURIComponent(currentPage)}`;
            } catch (error) {
                console.error('ì‚¬ìš©ì í™•ì¸ ì˜¤ë¥˜:', error);
                alert('ì‚¬ìš©ì í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                window.location.href = '../index.html';
            }
        }

        // ì‚¬ìš©ì ê³µê°„ ëª©ë¡ ë¡œë“œ
        async function loadUserSpaces() {
            try {
                const spacesSnapshot = await db.collection('spaces')
                    .where('ownerId', '==', currentUser.uid)
                    .where('status', '==', 'active')
                    .get();

                userSpaces = [];
                spacesSnapshot.forEach(doc => {
                    userSpaces.push({ id: doc.id, ...doc.data() });
                });
                
                // ì´ë¦„ìˆœìœ¼ë¡œ ì •ë ¬
                userSpaces.sort((a, b) => a.name.localeCompare(b.name));

                updateSpaceSelect();
            } catch (error) {
                console.error('ê³µê°„ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                showAlert('ê³µê°„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ê³µê°„ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
        function updateSpaceSelect() {
            const spaceSelect = document.getElementById('spaceSelect');
            
            if (userSpaces.length === 0) {
                spaceSelect.innerHTML = '<option value="">ë“±ë¡ëœ ê³µê°„ì´ ì—†ìŠµë‹ˆë‹¤</option>';
                return;
            }

            spaceSelect.innerHTML = '<option value="">ê³µê°„ì„ ì„ íƒí•˜ì„¸ìš”</option>';
            
            userSpaces.forEach(space => {
                const option = document.createElement('option');
                option.value = space.id;
                option.textContent = `${space.name} (${space.address?.sigungu || ''})`;
                spaceSelect.appendChild(option);
            });

            // URL íŒŒë¼ë¯¸í„°ì—ì„œ ë°›ì€ spaceIdê°€ ìˆìœ¼ë©´ ì„ íƒ
            if (selectedSpaceId && userSpaces.some(space => space.id === selectedSpaceId)) {
                spaceSelect.value = selectedSpaceId;
                showSpaceInfo(selectedSpaceId);
            }

            // ê³µê°„ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            spaceSelect.addEventListener('change', function() {
                const spaceId = this.value;
                if (spaceId) {
                    showSpaceInfo(spaceId);
                } else {
                    hideSpaceInfo();
                }
            });
        }

        // ì„ íƒëœ ê³µê°„ ì •ë³´ í‘œì‹œ
        function showSpaceInfo(spaceId) {
            const space = userSpaces.find(s => s.id === spaceId);
            if (!space) return;

            const spaceInfo = document.getElementById('spaceInfo');
            document.getElementById('spaceName').textContent = space.name;
            document.getElementById('spaceAddress').textContent = `ğŸ“ ${space.address?.fullAddress || ''}`;
            document.getElementById('spaceSize').textContent = `ğŸ“ ${space.size || 0}í‰`;
            
            spaceInfo.style.display = 'block';
        }

        // ê³µê°„ ì •ë³´ ìˆ¨ê¸°ê¸°
        function hideSpaceInfo() {
            document.getElementById('spaceInfo').style.display = 'none';
        }

        // ì„œë¹„ìŠ¤ ì„ íƒ í† ê¸€
        function toggleService(serviceId) {
            const checkbox = document.getElementById(serviceId);
            const option = checkbox.closest('.service-option');
            
            if (serviceId === 'basic') {
                // ê¸°ë³¸ ì •ë¦¬ëŠ” í•„ìˆ˜ì´ë¯€ë¡œ í•´ì œ ë¶ˆê°€
                return;
            }
            
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                option.classList.add('selected');
            } else {
                option.classList.remove('selected');
            }
            
            updatePricing();
        }

        // ê¸´ê¸‰ë„ ì„ íƒ
        function selectUrgency(urgencyType) {
            // ëª¨ë“  ê¸´ê¸‰ë„ ì˜µì…˜ ì´ˆê¸°í™”
            document.querySelectorAll('.urgency-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // ì„ íƒëœ ì˜µì…˜ í™œì„±í™”
            document.getElementById(urgencyType).checked = true;
            document.getElementById(urgencyType).closest('.urgency-option').classList.add('selected');
            
            updatePricing();
        }

        // ê°€ê²© ê³„ì‚° ì—…ë°ì´íŠ¸
        function updatePricing() {
            let basePrice = 12000;
            let additionalPrice = 0;
            let urgencyFee = 0;

            // ì¶”ê°€ ì„œë¹„ìŠ¤ ê°€ê²© ê³„ì‚°
            if (document.getElementById('floor').checked) {
                additionalPrice += 3000;
                document.getElementById('floorPrice').style.display = 'flex';
            } else {
                document.getElementById('floorPrice').style.display = 'none';
            }

            if (document.getElementById('toilet').checked) {
                additionalPrice += 3000;
                document.getElementById('toiletPrice').style.display = 'flex';
            } else {
                document.getElementById('toiletPrice').style.display = 'none';
            }

            if (document.getElementById('dishes').checked) {
                additionalPrice += 2000;
                document.getElementById('dishesPrice').style.display = 'flex';
            } else {
                document.getElementById('dishesPrice').style.display = 'none';
            }

            // ê¸´ê¸‰ ìš”ì²­ ìˆ˜ìˆ˜ë£Œ
            const urgencyType = document.querySelector('input[name="urgency"]:checked').value;
            if (urgencyType === 'urgent4h') {
                urgencyFee = 10000;
                document.getElementById('urgencyPrice').style.display = 'flex';
                document.getElementById('urgencyPrice').querySelector('.price').textContent = '+10,000ì›';
            } else if (urgencyType === 'urgent2h') {
                urgencyFee = 20000;
                document.getElementById('urgencyPrice').style.display = 'flex';
                document.getElementById('urgencyPrice').querySelector('.price').textContent = '+20,000ì›';
            } else {
                document.getElementById('urgencyPrice').style.display = 'none';
            }

            // ì´ ê°€ê²© ê³„ì‚°
            totalPrice = basePrice + additionalPrice + urgencyFee;
            document.getElementById('totalPrice').textContent = totalPrice.toLocaleString() + 'ì›';
        }

        // í¼ ì œì¶œ ì²˜ë¦¬
        document.getElementById('jobRequestForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const loading = submitBtn.querySelector('.loading');

            // ë¡œë”© ìƒíƒœ
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            loading.style.display = 'inline-block';

            try {
                // í¼ ë°ì´í„° ìˆ˜ì§‘
                const formData = new FormData(e.target);
                const selectedServices = Array.from(formData.getAll('services'));
                
                // ì‘ì—… ID ìƒì„±
                const jobId = 'JOB-' + new Date().toISOString().slice(0, 10).replace(/-/g, '') + '-' + 
                              Math.random().toString(36).substr(2, 6).toUpperCase();

                const jobData = {
                    jobId: jobId,
                    spaceId: formData.get('spaceId'),
                    businessId: currentUser.uid,
                    partnerId: null,
                    
                    status: 'pending',
                    
                    schedule: {
                        requestedDate: formData.get('requestDate'),
                        requestedTime: formData.get('requestTime'),
                        urgency: formData.get('urgency'),
                        estimatedDuration: 30,
                        flexibleTime: true
                    },
                    
                    services: {
                        basic: {
                            selected: selectedServices.includes('basic'),
                            price: 12000,
                            details: "ê¸°ë³¸ ì •ë¦¬ì •ëˆ, ì“°ë ˆê¸° ì²˜ë¦¬, ì†Œëª¨í’ˆ ë³´ì¶©"
                        },
                        floor: {
                            selected: selectedServices.includes('floor'),
                            price: selectedServices.includes('floor') ? 3000 : 0,
                            size: "15í‰ ì´í•˜"
                        },
                        toilet: {
                            selected: selectedServices.includes('toilet'),
                            price: selectedServices.includes('toilet') ? 3000 : 0,
                            count: 1
                        },
                        dishes: {
                            selected: selectedServices.includes('dishes'),
                            price: selectedServices.includes('dishes') ? 2000 : 0,
                            quantity: 10
                        },
                        customRequests: formData.get('customRequests') || ''
                    },
                    
                    pricing: {
                        basePrice: 12000,
                        additionalServices: totalPrice - 12000 - getUrgencyFee(formData.get('urgency')),
                        urgencyFee: getUrgencyFee(formData.get('urgency')),
                        discount: 0,
                        discountReason: null,
                        totalPrice: totalPrice,
                        commission: Math.floor(totalPrice * 0.2),
                        partnerEarnings: totalPrice - Math.floor(totalPrice * 0.2)
                    },
                    
                    matching: {
                        requestedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        notifiedPartners: [],
                        rejectedBy: [],
                        acceptedAt: null,
                        matchingAttempts: 0
                    },
                    
                    execution: {},
                    evidence: {
                        beforePhotos: [],
                        afterPhotos: [],
                        additionalPhotos: []
                    },
                    
                    review: {
                        businessRating: null,
                        businessComment: null,
                        partnerRating: null,
                        partnerComment: null,
                        reviewedAt: null
                    },
                    
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Firestoreì— ì‘ì—… ìš”ì²­ ì €ì¥
                await db.collection('jobs').doc(jobId).set(jobData);
                
                showAlert('ì •ë¦¬ ì„œë¹„ìŠ¤ ìš”ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                
                // 2ì´ˆ í›„ ì‘ì—… í˜„í™© í˜ì´ì§€ë¡œ ì´ë™
                setTimeout(() => {
                    window.location.href = `jobs.html`;
                }, 2000);

            } catch (error) {
                console.error('ì‘ì—… ìš”ì²­ ì˜¤ë¥˜:', error);
                showAlert('ì‘ì—… ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            } finally {
                // ë¡œë”© ìƒíƒœ í•´ì œ
                submitBtn.disabled = false;
                btnText.style.display = 'inline';
                loading.style.display = 'none';
            }
        });

        // ê¸´ê¸‰ ìš”ì²­ ìˆ˜ìˆ˜ë£Œ ê³„ì‚°
        function getUrgencyFee(urgencyType) {
            switch (urgencyType) {
                case 'urgent4h': return 10000;
                case 'urgent2h': return 20000;
                default: return 0;
            }
        }

        // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
        function showAlert(message, type) {
            const alertMessage = document.getElementById('alertMessage');
            alertMessage.textContent = message;
            alertMessage.className = `alert ${type}`;
            alertMessage.style.display = 'block';
            
            // 5ì´ˆ í›„ ì•Œë¦¼ ìˆ¨ê¸°ê¸°
            setTimeout(() => {
                alertMessage.style.display = 'none';
            }, 5000);
        }

        // ì´ˆê¸° ê°€ê²© ê³„ì‚°
        updatePricing();
    </script>
</body>
</html>