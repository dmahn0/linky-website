<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linky - Ï†ïÎ¶¨ ÏÑúÎπÑÏä§ ÏöîÏ≤≠</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <!-- Firebase ÏÑ§Ï†ï -->
    <script src="../firebase-config.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: #2d3748;
            background: #f7fafc;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
            color: #1a202c;
        }

        .header p {
            color: #6b7280;
        }

        .form-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .form-section h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #1a202c;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .service-options {
            display: grid;
            gap: 15px;
        }

        .service-option {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .service-option:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }

        .service-option.selected {
            border-color: #22c55e;
            background: #f0fdf4;
        }

        .service-option input[type="checkbox"] {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 20px;
            height: 20px;
        }

        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .service-name {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
        }

        .service-price {
            font-size: 16px;
            font-weight: bold;
            color: #22c55e;
        }

        .service-description {
            color: #6b7280;
            font-size: 14px;
            line-height: 1.5;
        }

        .urgency-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .urgency-option {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .urgency-option:hover {
            border-color: #3b82f6;
        }

        .urgency-option.selected {
            border-color: #22c55e;
            background: #f0fdf4;
        }

        .urgency-option input[type="radio"] {
            display: none;
        }

        .urgency-title {
            font-size: 16px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .urgency-desc {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .urgency-fee {
            font-size: 14px;
            font-weight: bold;
            color: #ef4444;
        }

        .price-summary {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .price-summary h3 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #1f2937;
        }

        .price-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
        }

        .price-item.total {
            border-top: 1px solid #e2e8f0;
            padding-top: 10px;
            margin-top: 10px;
            font-weight: bold;
            font-size: 18px;
        }

        .price-item.total .price {
            color: #22c55e;
            font-size: 20px;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            text-decoration: none;
        }

        .btn:hover {
            background: #2563eb;
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #22c55e;
        }

        .btn-primary:hover {
            background: #16a34a;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .help-text {
            font-size: 14px;
            color: #6b7280;
            margin-top: 5px;
        }

        .required {
            color: #ef4444;
        }

        .loading {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .space-info {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .space-info h3 {
            color: #166534;
            margin-bottom: 10px;
        }

        .space-info p {
            color: #15803d;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .urgency-options {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üßπ Ï†ïÎ¶¨ ÏÑúÎπÑÏä§ ÏöîÏ≤≠</h1>
            <p>Í≥µÍ∞ÑÏùÑ ÏÑ†ÌÉùÌïòÍ≥† ÌïÑÏöîÌïú ÏÑúÎπÑÏä§Î•º ÏöîÏ≤≠ÌïòÏÑ∏Ïöî</p>
        </div>

        <div class="alert" id="alertMessage"></div>

        <!-- Í≥µÍ∞Ñ Ï†ïÎ≥¥ -->
        <div id="spaceInfo" class="space-info" style="display: none;">
            <h3>ÏÑ†ÌÉùÎêú Í≥µÍ∞Ñ</h3>
            <p id="spaceName"></p>
            <p id="spaceAddress"></p>
            <p id="spaceSize"></p>
        </div>

        <form id="jobRequestForm">
            <!-- Í≥µÍ∞Ñ ÏÑ†ÌÉù -->
            <div class="form-section">
                <h2>üè¢ Í≥µÍ∞Ñ ÏÑ†ÌÉù</h2>
                
                <div class="form-group">
                    <label for="spaceSelect">Í≥µÍ∞Ñ ÏÑ†ÌÉù <span class="required">*</span></label>
                    <select id="spaceSelect" name="spaceId" required>
                        <option value="">Î°úÎî© Ï§ë...</option>
                    </select>
                </div>
            </div>

            <!-- ÏÑúÎπÑÏä§ ÏÑ†ÌÉù -->
            <div class="form-section">
                <h2>üõ†Ô∏è ÏÑúÎπÑÏä§ ÏÑ†ÌÉù</h2>
                
                <div class="service-options">
                    <div class="service-option" onclick="toggleService('basic')">
                        <input type="checkbox" id="basic" name="services" value="basic" checked>
                        <div class="service-header">
                            <span class="service-name">Í∏∞Î≥∏ Ï†ïÎ¶¨</span>
                            <span class="service-price">12,000Ïõê</span>
                        </div>
                        <div class="service-description">
                            Í∏∞Î≥∏Ï†ÅÏù∏ Ï†ïÎ¶¨Ï†ïÎèà, Ïì∞Î†àÍ∏∞ Ï≤òÎ¶¨, ÏÜåÎ™®Ìíà Î≥¥Ï∂© (Ìú¥ÏßÄ, Î¨ºÌã∞Ïäà Îì±)
                        </div>
                    </div>

                    <div class="service-option" onclick="toggleService('floor')">
                        <input type="checkbox" id="floor" name="services" value="floor">
                        <div class="service-header">
                            <span class="service-name">Î∞îÎã• Ï≤≠ÏÜå</span>
                            <span class="service-price">+3,000Ïõê</span>
                        </div>
                        <div class="service-description">
                            Î∞îÎã• ÏßÑÍ≥µÏ≤≠ÏÜåÍ∏∞ Î∞è Î¨ºÍ±∏Î†àÏßà (15Ìèâ Ïù¥Ìïò Í∏∞Ï§Ä)
                        </div>
                    </div>

                    <div class="service-option" onclick="toggleService('toilet')">
                        <input type="checkbox" id="toilet" name="services" value="toilet">
                        <div class="service-header">
                            <span class="service-name">ÌôîÏû•Ïã§ Ï≤≠ÏÜå</span>
                            <span class="service-price">+3,000Ïõê</span>
                        </div>
                        <div class="service-description">
                            ÌôîÏû•Ïã§ Ï≤≠ÏÜå Î∞è ÏÜåÎèÖ, Ìú¥ÏßÄ ÍµêÏ≤¥
                        </div>
                    </div>

                    <div class="service-option" onclick="toggleService('dishes')">
                        <input type="checkbox" id="dishes" name="services" value="dishes">
                        <div class="service-header">
                            <span class="service-name">ÏÑ§Í±∞ÏßÄ</span>
                            <span class="service-price">+2,000Ïõê</span>
                        </div>
                        <div class="service-description">
                            Ïªµ, Ï†ëÏãú Îì± Í∞ÑÎã®Ìïú ÏÑ§Í±∞ÏßÄ (10Í∞ú Ïù¥Ìïò)
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÏùºÏ†ï ÏÑ†ÌÉù -->
            <div class="form-section">
                <h2>üìÖ ÏùºÏ†ï ÏÑ†ÌÉù</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="requestDate">ÏöîÏ≤≠ ÎÇ†Ïßú <span class="required">*</span></label>
                        <input type="date" id="requestDate" name="requestDate" required>
                    </div>

                    <div class="form-group">
                        <label for="requestTime">ÏöîÏ≤≠ ÏãúÍ∞Ñ <span class="required">*</span></label>
                        <input type="time" id="requestTime" name="requestTime" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Í∏¥Í∏âÎèÑ ÏÑ†ÌÉù</label>
                    <div class="urgency-options">
                        <div class="urgency-option selected" onclick="selectUrgency('normal')">
                            <input type="radio" id="normal" name="urgency" value="normal" checked>
                            <div class="urgency-title">ÏùºÎ∞ò ÏöîÏ≤≠</div>
                            <div class="urgency-desc">24ÏãúÍ∞Ñ ÎÇ¥</div>
                            <div class="urgency-fee">Ï∂îÍ∞Ä ÏöîÍ∏à ÏóÜÏùå</div>
                        </div>

                        <div class="urgency-option" onclick="selectUrgency('urgent4h')">
                            <input type="radio" id="urgent4h" name="urgency" value="urgent4h">
                            <div class="urgency-title">Í∏¥Í∏â ÏöîÏ≤≠</div>
                            <div class="urgency-desc">4ÏãúÍ∞Ñ ÎÇ¥</div>
                            <div class="urgency-fee">+10,000Ïõê</div>
                        </div>

                        <div class="urgency-option" onclick="selectUrgency('urgent2h')">
                            <input type="radio" id="urgent2h" name="urgency" value="urgent2h">
                            <div class="urgency-title">Ï¥àÍ∏¥Í∏â ÏöîÏ≤≠</div>
                            <div class="urgency-desc">2ÏãúÍ∞Ñ ÎÇ¥</div>
                            <div class="urgency-fee">+20,000Ïõê</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ï∂îÍ∞Ä ÏöîÏ≤≠ÏÇ¨Ìï≠ -->
            <div class="form-section">
                <h2>üìù Ï∂îÍ∞Ä ÏöîÏ≤≠ÏÇ¨Ìï≠</h2>
                
                <div class="form-group">
                    <label for="customRequests">ÌäπÎ≥Ñ ÏöîÏ≤≠ÏÇ¨Ìï≠</label>
                    <textarea id="customRequests" name="customRequests" 
                              placeholder="Ïòà: ÌöåÏùòÏã§ ÌÖåÏù¥Î∏î Î∞∞ÏπòÎäî „ÖÅÏûêÎ°ú Ìï¥Ï£ºÏÑ∏Ïöî, Ïª§ÌîºÎ®∏Ïã† Î¨ºÌÜµ ÍµêÏ≤¥ Îì±"></textarea>
                    <div class="help-text">Ï∂îÍ∞Ä ÏöîÏ≤≠ÏÇ¨Ìï≠Ïù¥ ÏûàÏúºÎ©¥ ÏûêÏÑ∏Ìûà Ï†ÅÏñ¥Ï£ºÏÑ∏Ïöî</div>
                </div>
            </div>

            <!-- Í∞ÄÍ≤© ÏöîÏïΩ -->
            <div class="price-summary">
                <h3>üí∞ ÏöîÍ∏à Ï†ïÎ≥¥</h3>
                <div class="price-item">
                    <span>Í∏∞Î≥∏ Ï†ïÎ¶¨</span>
                    <span class="price">12,000Ïõê</span>
                </div>
                <div class="price-item" id="floorPrice" style="display: none;">
                    <span>Î∞îÎã• Ï≤≠ÏÜå</span>
                    <span class="price">+3,000Ïõê</span>
                </div>
                <div class="price-item" id="toiletPrice" style="display: none;">
                    <span>ÌôîÏû•Ïã§ Ï≤≠ÏÜå</span>
                    <span class="price">+3,000Ïõê</span>
                </div>
                <div class="price-item" id="dishesPrice" style="display: none;">
                    <span>ÏÑ§Í±∞ÏßÄ</span>
                    <span class="price">+2,000Ïõê</span>
                </div>
                <div class="price-item" id="urgencyPrice" style="display: none;">
                    <span>Í∏¥Í∏â ÏöîÏ≤≠</span>
                    <span class="price">+0Ïõê</span>
                </div>
                <div class="price-item total">
                    <span>Ï¥ù ÏöîÍ∏à</span>
                    <span class="price" id="totalPrice">12,000Ïõê</span>
                </div>
            </div>

            <div class="btn-group">
                <button type="button" class="btn btn-secondary" onclick="history.back()">Ï∑®ÏÜå</button>
                <button type="submit" class="btn btn-primary">
                    <span class="btn-text">Ï†ïÎ¶¨ ÏÑúÎπÑÏä§ ÏöîÏ≤≠ÌïòÍ∏∞</span>
                    <span class="loading"></span>
                </button>
            </div>
        </form>
    </div>

    <script>
        let currentUser = null;
        let userSpaces = [];
        let selectedSpaceId = null;
        let totalPrice = 12000;

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            // Ïò§Îäò ÎÇ†Ïßú Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('requestDate').value = today;
            document.getElementById('requestDate').min = today;

            // ÌòÑÏû¨ ÏãúÍ∞Ñ + 1ÏãúÍ∞ÑÏùÑ Í∏∞Î≥∏Í∞íÏúºÎ°ú ÏÑ§Ï†ï
            const now = new Date();
            now.setHours(now.getHours() + 1);
            const timeStr = now.toTimeString().slice(0, 5);
            document.getElementById('requestTime').value = timeStr;

            // URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú spaceId ÌôïÏù∏
            const urlParams = new URLSearchParams(window.location.search);
            selectedSpaceId = urlParams.get('spaceId');

            // Firebase Ï¥àÍ∏∞Ìôî ÎåÄÍ∏∞
            setTimeout(() => {
                if (typeof auth !== 'undefined') {
                    auth.onAuthStateChanged((user) => {
                        if (user) {
                            checkBusinessUser(user);
                        } else {
                            // Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Î¶¨Îã§Ïù¥Î†âÌä∏ (ÌòÑÏû¨ ÌéòÏù¥ÏßÄÎ•º redirect ÌååÎùºÎØ∏ÌÑ∞Î°ú)
                            const currentPage = window.location.pathname.split('/').pop();
                            window.location.href = `index.html?redirect=${encodeURIComponent(currentPage)}`;
                        }
                    });
                } else {
                    alert('Firebase Ï¥àÍ∏∞Ìôî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                    window.location.href = '../index.html';
                }
            }, 1000);
        });

        // ÏÇ¨ÏóÖÏûê Í≥ÑÏ†ï ÌôïÏù∏ Î∞è Í≥µÍ∞Ñ Î°úÎìú
        async function checkBusinessUser(user) {
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    if (userData.type === 'business' && userData.status === 'approved') {
                        currentUser = { ...user, ...userData };
                        await loadUserSpaces();
                        return;
                    }
                }
                // Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Î¶¨Îã§Ïù¥Î†âÌä∏ (ÌòÑÏû¨ ÌéòÏù¥ÏßÄÎ•º redirect ÌååÎùºÎØ∏ÌÑ∞Î°ú)
                const currentPage = window.location.pathname.split('/').pop();
                window.location.href = `index.html?redirect=${encodeURIComponent(currentPage)}`;
            } catch (error) {
                console.error('ÏÇ¨Ïö©Ïûê ÌôïÏù∏ Ïò§Î•ò:', error);
                alert('ÏÇ¨Ïö©Ïûê ÌôïÏù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                window.location.href = '../index.html';
            }
        }

        // ÏÇ¨Ïö©Ïûê Í≥µÍ∞Ñ Î™©Î°ù Î°úÎìú
        async function loadUserSpaces() {
            try {
                const spacesSnapshot = await db.collection('spaces')
                    .where('ownerId', '==', currentUser.uid)
                    .where('status', '==', 'active')
                    .get();

                userSpaces = [];
                spacesSnapshot.forEach(doc => {
                    userSpaces.push({ id: doc.id, ...doc.data() });
                });
                
                // Ïù¥Î¶ÑÏàúÏúºÎ°ú Ï†ïÎ†¨
                userSpaces.sort((a, b) => a.name.localeCompare(b.name));

                updateSpaceSelect();
            } catch (error) {
                console.error('Í≥µÍ∞Ñ Î™©Î°ù Î°úÎìú Ïò§Î•ò:', error);
                showAlert('Í≥µÍ∞Ñ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        // Í≥µÍ∞Ñ ÏÑ†ÌÉù ÎìúÎ°≠Îã§Ïö¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updateSpaceSelect() {
            const spaceSelect = document.getElementById('spaceSelect');
            
            if (userSpaces.length === 0) {
                spaceSelect.innerHTML = '<option value="">Îì±Î°ùÎêú Í≥µÍ∞ÑÏù¥ ÏóÜÏäµÎãàÎã§</option>';
                return;
            }

            spaceSelect.innerHTML = '<option value="">Í≥µÍ∞ÑÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
            
            userSpaces.forEach(space => {
                const option = document.createElement('option');
                option.value = space.id;
                option.textContent = `${space.name} (${space.address?.sigungu || ''})`;
                spaceSelect.appendChild(option);
            });

            // URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú Î∞õÏùÄ spaceIdÍ∞Ä ÏûàÏúºÎ©¥ ÏÑ†ÌÉù
            if (selectedSpaceId && userSpaces.some(space => space.id === selectedSpaceId)) {
                spaceSelect.value = selectedSpaceId;
                showSpaceInfo(selectedSpaceId);
            }

            // Í≥µÍ∞Ñ ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
            spaceSelect.addEventListener('change', function() {
                const spaceId = this.value;
                if (spaceId) {
                    showSpaceInfo(spaceId);
                } else {
                    hideSpaceInfo();
                }
            });
        }

        // ÏÑ†ÌÉùÎêú Í≥µÍ∞Ñ Ï†ïÎ≥¥ ÌëúÏãú
        function showSpaceInfo(spaceId) {
            const space = userSpaces.find(s => s.id === spaceId);
            if (!space) return;

            const spaceInfo = document.getElementById('spaceInfo');
            document.getElementById('spaceName').textContent = space.name;
            document.getElementById('spaceAddress').textContent = `üìç ${space.address?.fullAddress || ''}`;
            document.getElementById('spaceSize').textContent = `üìè ${space.size || 0}Ìèâ`;
            
            spaceInfo.style.display = 'block';
        }

        // Í≥µÍ∞Ñ Ï†ïÎ≥¥ Ïà®Í∏∞Í∏∞
        function hideSpaceInfo() {
            document.getElementById('spaceInfo').style.display = 'none';
        }

        // ÏÑúÎπÑÏä§ ÏÑ†ÌÉù ÌÜ†Í∏Ä
        function toggleService(serviceId) {
            const checkbox = document.getElementById(serviceId);
            const option = checkbox.closest('.service-option');
            
            if (serviceId === 'basic') {
                // Í∏∞Î≥∏ Ï†ïÎ¶¨Îäî ÌïÑÏàòÏù¥ÎØÄÎ°ú Ìï¥Ï†ú Î∂àÍ∞Ä
                return;
            }
            
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                option.classList.add('selected');
            } else {
                option.classList.remove('selected');
            }
            
            updatePricing();
        }

        // Í∏¥Í∏âÎèÑ ÏÑ†ÌÉù
        function selectUrgency(urgencyType) {
            // Î™®Îì† Í∏¥Í∏âÎèÑ ÏòµÏÖò Ï¥àÍ∏∞Ìôî
            document.querySelectorAll('.urgency-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // ÏÑ†ÌÉùÎêú ÏòµÏÖò ÌôúÏÑ±Ìôî
            document.getElementById(urgencyType).checked = true;
            document.getElementById(urgencyType).closest('.urgency-option').classList.add('selected');
            
            updatePricing();
        }

        // Í∞ÄÍ≤© Í≥ÑÏÇ∞ ÏóÖÎç∞Ïù¥Ìä∏
        function updatePricing() {
            let basePrice = 12000;
            let additionalPrice = 0;
            let urgencyFee = 0;

            // Ï∂îÍ∞Ä ÏÑúÎπÑÏä§ Í∞ÄÍ≤© Í≥ÑÏÇ∞
            if (document.getElementById('floor').checked) {
                additionalPrice += 3000;
                document.getElementById('floorPrice').style.display = 'flex';
            } else {
                document.getElementById('floorPrice').style.display = 'none';
            }

            if (document.getElementById('toilet').checked) {
                additionalPrice += 3000;
                document.getElementById('toiletPrice').style.display = 'flex';
            } else {
                document.getElementById('toiletPrice').style.display = 'none';
            }

            if (document.getElementById('dishes').checked) {
                additionalPrice += 2000;
                document.getElementById('dishesPrice').style.display = 'flex';
            } else {
                document.getElementById('dishesPrice').style.display = 'none';
            }

            // Í∏¥Í∏â ÏöîÏ≤≠ ÏàòÏàòÎ£å
            const urgencyType = document.querySelector('input[name="urgency"]:checked').value;
            if (urgencyType === 'urgent4h') {
                urgencyFee = 10000;
                document.getElementById('urgencyPrice').style.display = 'flex';
                document.getElementById('urgencyPrice').querySelector('.price').textContent = '+10,000Ïõê';
            } else if (urgencyType === 'urgent2h') {
                urgencyFee = 20000;
                document.getElementById('urgencyPrice').style.display = 'flex';
                document.getElementById('urgencyPrice').querySelector('.price').textContent = '+20,000Ïõê';
            } else {
                document.getElementById('urgencyPrice').style.display = 'none';
            }

            // Ï¥ù Í∞ÄÍ≤© Í≥ÑÏÇ∞
            totalPrice = basePrice + additionalPrice + urgencyFee;
            document.getElementById('totalPrice').textContent = totalPrice.toLocaleString() + 'Ïõê';
        }

        // Ìèº Ï†úÏ∂ú Ï≤òÎ¶¨
        document.getElementById('jobRequestForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const loading = submitBtn.querySelector('.loading');

            // Î°úÎî© ÏÉÅÌÉú
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            loading.style.display = 'inline-block';

            try {
                // Ìèº Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
                const formData = new FormData(e.target);
                const selectedServices = Array.from(formData.getAll('services'));
                
                // ÏûëÏóÖ ID ÏÉùÏÑ±
                const jobId = 'JOB-' + new Date().toISOString().slice(0, 10).replace(/-/g, '') + '-' + 
                              Math.random().toString(36).substr(2, 6).toUpperCase();

                const jobData = {
                    jobId: jobId,
                    spaceId: formData.get('spaceId'),
                    businessId: currentUser.uid,
                    partnerId: null,
                    
                    status: 'pending',
                    
                    schedule: {
                        requestedDate: formData.get('requestDate'),
                        requestedTime: formData.get('requestTime'),
                        urgency: formData.get('urgency'),
                        estimatedDuration: 30,
                        flexibleTime: true
                    },
                    
                    services: {
                        basic: {
                            selected: selectedServices.includes('basic'),
                            price: 12000,
                            details: "Í∏∞Î≥∏ Ï†ïÎ¶¨Ï†ïÎèà, Ïì∞Î†àÍ∏∞ Ï≤òÎ¶¨, ÏÜåÎ™®Ìíà Î≥¥Ï∂©"
                        },
                        floor: {
                            selected: selectedServices.includes('floor'),
                            price: selectedServices.includes('floor') ? 3000 : 0,
                            size: "15Ìèâ Ïù¥Ìïò"
                        },
                        toilet: {
                            selected: selectedServices.includes('toilet'),
                            price: selectedServices.includes('toilet') ? 3000 : 0,
                            count: 1
                        },
                        dishes: {
                            selected: selectedServices.includes('dishes'),
                            price: selectedServices.includes('dishes') ? 2000 : 0,
                            quantity: 10
                        },
                        customRequests: formData.get('customRequests') || ''
                    },
                    
                    pricing: {
                        basePrice: 12000,
                        additionalServices: totalPrice - 12000 - getUrgencyFee(formData.get('urgency')),
                        urgencyFee: getUrgencyFee(formData.get('urgency')),
                        discount: 0,
                        discountReason: null,
                        totalPrice: totalPrice,
                        commission: Math.floor(totalPrice * 0.2),
                        partnerEarnings: totalPrice - Math.floor(totalPrice * 0.2)
                    },
                    
                    matching: {
                        requestedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        notifiedPartners: [],
                        rejectedBy: [],
                        acceptedAt: null,
                        matchingAttempts: 0
                    },
                    
                    execution: {},
                    evidence: {
                        beforePhotos: [],
                        afterPhotos: [],
                        additionalPhotos: []
                    },
                    
                    review: {
                        businessRating: null,
                        businessComment: null,
                        partnerRating: null,
                        partnerComment: null,
                        reviewedAt: null
                    },
                    
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // FirestoreÏóê ÏûëÏóÖ ÏöîÏ≤≠ Ï†ÄÏû•
                await db.collection('jobs').doc(jobId).set(jobData);
                
                showAlert('Ï†ïÎ¶¨ ÏÑúÎπÑÏä§ ÏöîÏ≤≠Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ëÏàòÎêòÏóàÏäµÎãàÎã§!', 'success');
                
                // 2Ï¥à ÌõÑ ÏûëÏóÖ ÌòÑÌô© ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
                setTimeout(() => {
                    window.location.href = `jobs.html`;
                }, 2000);

            } catch (error) {
                console.error('ÏûëÏóÖ ÏöîÏ≤≠ Ïò§Î•ò:', error);
                showAlert('ÏûëÏóÖ ÏöîÏ≤≠ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            } finally {
                // Î°úÎî© ÏÉÅÌÉú Ìï¥Ï†ú
                submitBtn.disabled = false;
                btnText.style.display = 'inline';
                loading.style.display = 'none';
            }
        });

        // Í∏¥Í∏â ÏöîÏ≤≠ ÏàòÏàòÎ£å Í≥ÑÏÇ∞
        function getUrgencyFee(urgencyType) {
            switch (urgencyType) {
                case 'urgent4h': return 10000;
                case 'urgent2h': return 20000;
                default: return 0;
            }
        }

        // ÏïåÎ¶º ÌëúÏãú Ìï®Ïàò
        function showAlert(message, type) {
            const alertMessage = document.getElementById('alertMessage');
            alertMessage.textContent = message;
            alertMessage.className = `alert ${type}`;
            alertMessage.style.display = 'block';
            
            // 5Ï¥à ÌõÑ ÏïåÎ¶º Ïà®Í∏∞Í∏∞
            setTimeout(() => {
                alertMessage.style.display = 'none';
            }, 5000);
        }

        // Ï¥àÍ∏∞ Í∞ÄÍ≤© Í≥ÑÏÇ∞
        updatePricing();
    </script>
</body>
</html>