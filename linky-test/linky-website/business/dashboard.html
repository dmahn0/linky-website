<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ì‹œë³´ë“œ - Linky Business</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <!-- Firebase ì„¤ì • -->
    <script src="../firebase-config.js"></script>
    
    <!-- ê³µí†µ ìŠ¤íƒ€ì¼ -->
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/components.css">
    
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            background: #f8fafc;
            min-height: calc(100vh - 200px);
        }
        
        .welcome-header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .welcome-title {
            font-size: 32px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 10px;
        }
        
        .welcome-subtitle {
            color: #6b7280;
            font-size: 18px;
        }
        
        /* í†µê³„ ì¹´ë“œ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            display: block;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }
        
        .stat-card.pending-review {
            background: #fef3c7;
            border: 2px solid #f59e0b;
        }
        
        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .stat-icon {
            font-size: 40px;
        }
        
        .stat-badge {
            background: #ef4444;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .stat-number {
            font-size: 40px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 16px;
            color: #6b7280;
        }
        
        .stat-detail {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
            font-size: 14px;
            color: #64748b;
        }
        
        /* ë¹ ë¥¸ ì‘ì—… ì„¹ì…˜ */
        .quick-actions {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 20px;
        }
        
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .action-btn {
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
            text-align: center;
            text-decoration: none;
            color: #374151;
            font-weight: 600;
            transition: all 0.2s;
            display: block;
        }
        
        .action-btn:hover {
            background: #f3f4f6;
            border-color: #10b981;
            color: #10b981;
        }
        
        .action-icon {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }
        
        /* ìµœê·¼ ì‘ì—… ì„¹ì…˜ */
        .recent-jobs {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .job-list {
            display: grid;
            gap: 15px;
        }
        
        .job-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .job-item:hover {
            background: #f3f4f6;
        }
        
        .job-info {
            flex: 1;
        }
        
        .job-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }
        
        .job-meta {
            font-size: 14px;
            color: #6b7280;
        }
        
        .job-status {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .status-pending_review {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-in_progress {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }
        
        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .action-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- í—¤ë” ì»´í¬ë„ŒíŠ¸ -->
    <div id="header-root"></div>
    
    <div class="dashboard-container">
        <!-- í™˜ì˜ ë©”ì‹œì§€ -->
        <div class="welcome-header">
            <h1 class="welcome-title">ì•ˆë…•í•˜ì„¸ìš”, <span id="userName">ì‚¬ì—…ì</span>ë‹˜!</h1>
            <p class="welcome-subtitle">ì˜¤ëŠ˜ë„ ê¹¨ë—í•œ ê³µê°„ì„ ë§Œë“¤ì–´ê°€ìš” ğŸŒŸ</p>
        </div>
        
        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-grid">
            <a href="job-list.html?tab=pending_review" class="stat-card pending-review" id="pendingReviewCard">
                <div class="stat-header">
                    <span class="stat-icon">ğŸ”</span>
                    <span class="stat-badge">ê¸´ê¸‰</span>
                </div>
                <div class="stat-number" id="pendingReviewCount">0</div>
                <div class="stat-label">ê²€í†  ëŒ€ê¸° ì‘ì—…</div>
                <div class="stat-detail">íŒŒíŠ¸ë„ˆê°€ ì™„ë£Œí•œ ì‘ì—…ì„ í™•ì¸í•´ì£¼ì„¸ìš”</div>
            </a>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-icon">ğŸƒ</span>
                </div>
                <div class="stat-number" id="inProgressCount">0</div>
                <div class="stat-label">ì§„í–‰ ì¤‘ì¸ ì‘ì—…</div>
                <div class="stat-detail">í˜„ì¬ íŒŒíŠ¸ë„ˆê°€ ì‘ì—… ì¤‘ì…ë‹ˆë‹¤</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-icon">âœ…</span>
                </div>
                <div class="stat-number" id="completedCount">0</div>
                <div class="stat-label">ì´ë²ˆ ë‹¬ ì™„ë£Œ</div>
                <div class="stat-detail">ì´ <span id="totalAmount">0</span>ì› ì§‘í–‰</div>
            </div>
        </div>
        
        <!-- ë¹ ë¥¸ ì‘ì—… -->
        <div class="quick-actions">
            <h2 class="section-title">ë¹ ë¥¸ ì‘ì—…</h2>
            <div class="action-grid">
                <a href="job-request.html" class="action-btn">
                    <span class="action-icon">â•</span>
                    ìƒˆ ì‘ì—… ìš”ì²­
                </a>
                <a href="job-list.html" class="action-btn">
                    <span class="action-icon">ğŸ“‹</span>
                    ì‘ì—… í˜„í™©
                </a>
                <a href="space-registration.html" class="action-btn">
                    <span class="action-icon">ğŸ¢</span>
                    ê³µê°„ ê´€ë¦¬
                </a>
                <a href="billing.html" class="action-btn">
                    <span class="action-icon">ğŸ’³</span>
                    ì •ì‚° ê´€ë¦¬
                </a>
            </div>
        </div>
        
        <!-- ìµœê·¼ ì‘ì—… -->
        <div class="recent-jobs">
            <h2 class="section-title">ìµœê·¼ ì‘ì—…</h2>
            <div class="job-list" id="recentJobsList">
                <!-- ìµœê·¼ ì‘ì—…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>
    
    <!-- í‘¸í„° ì»´í¬ë„ŒíŠ¸ -->
    <div id="footer-root"></div>
    
    <!-- ì¸ì¦ ëª¨ë‹¬ -->
    <script src="../auth-modal.js"></script>
    
    <!-- ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="../js/auth-utils.js"></script>
    <script src="../components/header.js"></script>
    <script src="../components/footer.js"></script>
    
    <script>
        let currentUser = null;
        let authModal;
        
        // í˜ì´ì§€ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            // authModal ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
            authModal = new AuthModal();
            // í—¤ë” ì´ˆê¸°í™”
            new HeaderComponent({
                showBusinessMenu: true,
                currentPage: 'dashboard'
            });
            
            // í‘¸í„° ì´ˆê¸°í™”
            new FooterComponent();
            
            // ì¸ì¦ í™•ì¸
            const { isAuthenticated, user } = await checkAuthStatus();
            if (!isAuthenticated || user.type !== 'business') {
                // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (í˜„ì¬ í˜ì´ì§€ë¥¼ redirect íŒŒë¼ë¯¸í„°ë¡œ)
                const currentPath = window.location.pathname + window.location.search;
                window.location.href = `index.html?redirect=${encodeURIComponent('dashboard.html')}`;
                return;
            }
            
            currentUser = user;
            document.getElementById('userName').textContent = user.name || 'ì‚¬ì—…ì';
            
            // í†µê³„ ë° ì‘ì—… ë¡œë“œ
            await loadDashboardData();
        });
        
        // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
        async function loadDashboardData() {
            try {
                // ì´ë²ˆ ë‹¬ ì‹œì‘ì¼
                const now = new Date();
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                
                // ì‘ì—… í†µê³„ ê°€ì ¸ì˜¤ê¸°
                const [pendingReview, inProgress, completed] = await Promise.all([
                    db.collection('jobs')
                        .where('businessId', '==', currentUser.uid)
                        .where('status', '==', 'pending_review')
                        .get(),
                    db.collection('jobs')
                        .where('businessId', '==', currentUser.uid)
                        .where('status', '==', 'in_progress')
                        .get(),
                    db.collection('jobs')
                        .where('businessId', '==', currentUser.uid)
                        .where('status', '==', 'completed')
                        .where('completedAt', '>=', monthStart)
                        .get()
                ]);
                
                // í†µê³„ í‘œì‹œ
                document.getElementById('pendingReviewCount').textContent = pendingReview.size;
                document.getElementById('inProgressCount').textContent = inProgress.size;
                document.getElementById('completedCount').textContent = completed.size;
                
                // ê²€í†  ëŒ€ê¸° ì•Œë¦¼
                if (pendingReview.size > 0) {
                    document.getElementById('pendingReviewCard').classList.add('pending-review');
                }
                
                // ì´ë²ˆ ë‹¬ ì´ ë¹„ìš© ê³„ì‚°
                let totalAmount = 0;
                completed.forEach(doc => {
                    const job = doc.data();
                    totalAmount += job.pricing?.totalPrice || 0;
                });
                document.getElementById('totalAmount').textContent = totalAmount.toLocaleString();
                
                // ìµœê·¼ ì‘ì—… ë¡œë“œ
                await loadRecentJobs();
                
            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // ìµœê·¼ ì‘ì—… ë¡œë“œ
        async function loadRecentJobs() {
            try {
                const recentJobs = await db.collection('jobs')
                    .where('businessId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .limit(5)
                    .get();
                
                const jobsList = document.getElementById('recentJobsList');
                
                if (recentJobs.empty) {
                    jobsList.innerHTML = '<p style="text-align: center; color: #9ca3af;">ì•„ì§ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                
                jobsList.innerHTML = '';
                
                recentJobs.forEach(doc => {
                    const job = doc.data();
                    const jobItem = createJobItem(doc.id, job);
                    jobsList.appendChild(jobItem);
                });
                
            } catch (error) {
                console.error('ìµœê·¼ ì‘ì—… ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // ì‘ì—… ì•„ì´í…œ ìƒì„±
        function createJobItem(jobId, jobData) {
            const div = document.createElement('div');
            div.className = 'job-item';
            div.style.cursor = 'pointer';
            
            const statusMap = {
                'pending': 'ëŒ€ê¸°ì¤‘',
                'matched': 'ë§¤ì¹­ë¨',
                'in_progress': 'ì§„í–‰ì¤‘',
                'pending_review': 'ê²€í†  ëŒ€ê¸°',
                'completed': 'ì™„ë£Œ',
                'rejected': 'ê±°ë¶€ë¨',
                'cancelled': 'ì·¨ì†Œë¨'
            };
            
            const statusClass = `status-${jobData.status}`;
            
            div.innerHTML = `
                <div class="job-info">
                    <div class="job-name">${jobData.spaceInfo?.name || 'ê³µê°„ ì •ë³´ ì—†ìŒ'}</div>
                    <div class="job-meta">
                        ${formatDate(jobData.schedule?.requestedDate)} â€¢ 
                        ${jobData.schedule?.requestedTime || '-'}
                    </div>
                </div>
                <span class="job-status ${statusClass}">
                    ${statusMap[jobData.status] || jobData.status}
                </span>
            `;
            
            // í´ë¦­ ì´ë²¤íŠ¸
            div.onclick = () => {
                if (jobData.status === 'pending_review') {
                    window.location.href = `job-completion-review.html?jobId=${jobId}`;
                } else {
                    window.location.href = `job-detail.html?jobId=${jobId}`;
                }
            };
            
            return div;
        }
        
        // ë‚ ì§œ í¬ë§·
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR');
        }
    </script>
</body>
</html>