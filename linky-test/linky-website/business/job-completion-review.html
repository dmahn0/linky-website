<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‘ì—… ì™„ë£Œ ê²€í†  - Linky Business</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <!-- Firebase ì„¤ì • -->
    <script src="../firebase-config.js"></script>
    
    <!-- ê³µí†µ ìŠ¤íƒ€ì¼ -->
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/components.css">
    
    <style>
        .review-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
            background: #f8fafc;
            min-height: calc(100vh - 200px);
        }
        
        .review-header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .job-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
        
        .summary-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .summary-label {
            font-size: 14px;
            color: #6b7280;
        }
        
        .summary-value {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        
        /* íŒŒíŠ¸ë„ˆ ì •ë³´ ì„¹ì…˜ */
        .partner-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .partner-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .partner-avatar {
            width: 60px;
            height: 60px;
            background: #e0e7ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #4338ca;
        }
        
        .partner-details h3 {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .partner-stats {
            display: flex;
            gap: 20px;
            margin-top: 5px;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #6b7280;
        }
        
        .rating {
            color: #f59e0b;
        }
        
        /* ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ */
        .checklist-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checklist-grid {
            display: grid;
            gap: 10px;
        }
        
        .checklist-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            gap: 15px;
        }
        
        .checklist-item.completed {
            background: #e0f2fe;
        }
        
        .checklist-icon {
            font-size: 20px;
        }
        
        .checklist-text {
            flex: 1;
            color: #334155;
        }
        
        /* ì‚¬ì§„ ì„¹ì…˜ */
        .photos-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .photo-category {
            margin-bottom: 30px;
        }
        
        .photo-category:last-child {
            margin-bottom: 0;
        }
        
        .category-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            aspect-ratio: 1;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.2s;
        }
        
        .photo-item:hover img {
            transform: scale(1.05);
        }
        
        /* ì™„ë£Œ ë©”ëª¨ ì„¹ì…˜ */
        .notes-section {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .notes-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 10px;
        }
        
        .notes-content {
            color: #334155;
            line-height: 1.6;
        }
        
        /* ì•¡ì…˜ ì„¹ì…˜ */
        .action-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .btn-approve {
            background: #10b981;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-approve:hover {
            background: #059669;
        }
        
        .btn-reject {
            background: white;
            color: #ef4444;
            padding: 15px 40px;
            border: 2px solid #ef4444;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-reject:hover {
            background: #fef2f2;
        }
        
        .info-text {
            font-size: 14px;
            color: #6b7280;
        }
        
        /* ê±°ë¶€ ì‚¬ìœ  ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
        }
        
        .modal-close {
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            background: none;
            border: none;
        }
        
        .reject-reasons {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .reason-option {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .reason-option:hover {
            background: #f1f5f9;
        }
        
        .reason-option input[type="radio"] {
            margin-right: 10px;
        }
        
        .reason-textarea {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            resize: vertical;
            margin-bottom: 20px;
        }
        
        /* ì‚¬ì§„ ë·°ì–´ ëª¨ë‹¬ */
        .photo-viewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
        }
        
        .photo-viewer-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            max-height: 90%;
        }
        
        .photo-viewer-content img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
        }
        
        .photo-viewer-close {
            position: absolute;
            top: 20px;
            right: 40px;
            font-size: 40px;
            color: white;
            cursor: pointer;
            background: none;
            border: none;
        }
        
        /* ë¡œë”© ìƒíƒœ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .job-summary {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .photo-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- í—¤ë” ì»´í¬ë„ŒíŠ¸ -->
    <div id="header-root"></div>
    
    <div class="review-container">
        <!-- ë¦¬ë·° í—¤ë” -->
        <div class="review-header">
            <span class="status-badge status-pending">ê²€í†  ëŒ€ê¸°</span>
            <h1>ì‘ì—… ì™„ë£Œ ê²€í† </h1>
            <div class="job-summary">
                <div class="summary-item">
                    <span class="summary-label">ê³µê°„ëª…</span>
                    <span class="summary-value" id="spaceName">-</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ì‘ì—…ì¼</span>
                    <span class="summary-value" id="jobDate">-</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ì‘ì—… ì‹œê°„</span>
                    <span class="summary-value" id="jobTime">-</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ê²°ì œ ì˜ˆì •ì•¡</span>
                    <span class="summary-value" id="jobPrice">-</span>
                </div>
            </div>
        </div>
        
        <!-- íŒŒíŠ¸ë„ˆ ì •ë³´ -->
        <div class="partner-section">
            <h2 class="section-title">
                <span>ğŸ‘·</span>
                <span>ë‹´ë‹¹ íŒŒíŠ¸ë„ˆ</span>
            </h2>
            <div class="partner-info">
                <div class="partner-avatar" id="partnerAvatar">íŒŒ</div>
                <div class="partner-details">
                    <h3 id="partnerName">-</h3>
                    <div class="partner-stats">
                        <div class="stat-item">
                            <span class="rating">â­</span>
                            <span id="partnerRating">4.8</span>
                        </div>
                        <div class="stat-item">
                            <span>ì™„ë£Œ ì‘ì—…</span>
                            <span id="partnerJobs">152ê±´</span>
                        </div>
                        <div class="stat-item">
                            <span>ê²½ë ¥</span>
                            <span id="partnerExperience">2ë…„ 3ê°œì›”</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ -->
        <div class="checklist-section">
            <h2 class="section-title">
                <span>âœ…</span>
                <span>ì‘ì—… ì²´í¬ë¦¬ìŠ¤íŠ¸</span>
            </h2>
            <div class="checklist-grid" id="checklistGrid">
                <!-- ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª©ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>
        
        <!-- ì‚¬ì§„ ì„¹ì…˜ -->
        <div class="photos-section">
            <h2 class="section-title">
                <span>ğŸ“¸</span>
                <span>ì‘ì—… ì‚¬ì§„</span>
            </h2>
            
            <!-- ì‘ì—… ì „ ì‚¬ì§„ -->
            <div class="photo-category">
                <h3 class="category-title">ì‘ì—… ì „</h3>
                <div class="photo-grid" id="beforePhotos">
                    <!-- ì‘ì—… ì „ ì‚¬ì§„ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
            
            <!-- ì‘ì—… í›„ ì‚¬ì§„ -->
            <div class="photo-category">
                <h3 class="category-title">ì‘ì—… í›„</h3>
                <div class="photo-grid" id="afterPhotos">
                    <!-- ì‘ì—… í›„ ì‚¬ì§„ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
            
            <!-- ì¶”ê°€ ì‚¬ì§„ -->
            <div class="photo-category" id="additionalCategory" style="display: none;">
                <h3 class="category-title">ì¶”ê°€ ì‚¬ì§„</h3>
                <div class="photo-grid" id="additionalPhotos">
                    <!-- ì¶”ê°€ ì‚¬ì§„ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
        
        <!-- ì™„ë£Œ ë©”ëª¨ -->
        <div class="notes-section" id="notesSection" style="display: none;">
            <h3 class="notes-title">íŒŒíŠ¸ë„ˆ ë©”ëª¨</h3>
            <div class="notes-content" id="completionNotes">-</div>
        </div>
        
        <!-- ì•¡ì…˜ ì„¹ì…˜ -->
        <div class="action-section">
            <div class="action-buttons">
                <button class="btn-approve" onclick="approveCompletion()">ìŠ¹ì¸í•˜ê¸°</button>
                <button class="btn-reject" onclick="showRejectModal()">ì¬ì‘ì—… ìš”ì²­</button>
            </div>
            <p class="info-text">
                ìŠ¹ì¸ ì‹œ íŒŒíŠ¸ë„ˆì—ê²Œ ì •ì‚°ì´ ì§„í–‰ë˜ë©°, ì¬ì‘ì—… ìš”ì²­ ì‹œ íŒŒíŠ¸ë„ˆì—ê²Œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤.
            </p>
        </div>
    </div>
    
    <!-- ê±°ë¶€ ì‚¬ìœ  ëª¨ë‹¬ -->
    <div id="rejectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ì¬ì‘ì—… ìš”ì²­ ì‚¬ìœ </h3>
                <button class="modal-close" onclick="closeRejectModal()">&times;</button>
            </div>
            
            <div class="reject-reasons">
                <label class="reason-option">
                    <input type="radio" name="rejectReason" value="incomplete">
                    <span>ì‘ì—…ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</span>
                </label>
                <label class="reason-option">
                    <input type="radio" name="rejectReason" value="quality">
                    <span>ì‘ì—… í’ˆì§ˆì´ ê¸°ì¤€ì— ë¯¸ë‹¬í•©ë‹ˆë‹¤</span>
                </label>
                <label class="reason-option">
                    <input type="radio" name="rejectReason" value="photo">
                    <span>ì‚¬ì§„ì´ ë¶ˆëª…í™•í•˜ê±°ë‚˜ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤</span>
                </label>
                <label class="reason-option">
                    <input type="radio" name="rejectReason" value="other">
                    <span>ê¸°íƒ€</span>
                </label>
            </div>
            
            <textarea class="reason-textarea" id="rejectDetails" placeholder="ìƒì„¸ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (í•„ìˆ˜)"></textarea>
            
            <button class="btn-reject" style="width: 100%;" onclick="submitRejection()">ì¬ì‘ì—… ìš”ì²­í•˜ê¸°</button>
        </div>
    </div>
    
    <!-- ì‚¬ì§„ ë·°ì–´ ëª¨ë‹¬ -->
    <div id="photoViewer" class="photo-viewer" onclick="closePhotoViewer()">
        <button class="photo-viewer-close">&times;</button>
        <div class="photo-viewer-content">
            <img id="viewerImage" src="" alt="ì‘ì—… ì‚¬ì§„">
        </div>
    </div>
    
    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p id="loadingText">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
    </div>
    
    <!-- í‘¸í„° ì»´í¬ë„ŒíŠ¸ -->
    <div id="footer-root"></div>
    
    <!-- ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="../js/auth-utils.js"></script>
    <script src="../components/header.js"></script>
    <script src="../components/footer.js"></script>
    
    <script>
        let currentUser = null;
        let jobId = null;
        let jobData = null;
        
        // í˜ì´ì§€ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì‘ì—… ID ê°€ì ¸ì˜¤ê¸°
            const urlParams = new URLSearchParams(window.location.search);
            jobId = urlParams.get('jobId');
            
            if (!jobId) {
                alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
                window.location.href = 'jobs.html';
                return;
            }
            
            // í—¤ë” ì´ˆê¸°í™”
            new HeaderComponent({
                showBusinessMenu: true,
                currentPage: 'jobs'
            });
            
            // í‘¸í„° ì´ˆê¸°í™”
            new FooterComponent();
            
            // ì¸ì¦ í™•ì¸
            const { isAuthenticated, user } = await checkAuthStatus();
            if (!isAuthenticated || user.type !== 'business') {
                alert('ì‚¬ì—…ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '../index.html';
                return;
            }
            
            currentUser = user;
            
            // ì‘ì—… ì •ë³´ ë¡œë“œ
            await loadJobData();
        });
        
        // ì‘ì—… ì •ë³´ ë¡œë“œ
        async function loadJobData() {
            try {
                const jobDoc = await db.collection('jobs').doc(jobId).get();
                
                if (!jobDoc.exists) {
                    alert('ì‘ì—… ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    window.location.href = 'jobs.html';
                    return;
                }
                
                jobData = jobDoc.data();
                
                // ì‚¬ì—…ì ê¶Œí•œ í™•ì¸
                if (jobData.businessId !== currentUser.uid) {
                    alert('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                    window.location.href = 'jobs.html';
                    return;
                }
                
                // ì‘ì—… ìƒíƒœ í™•ì¸
                if (jobData.status !== 'pending_review') {
                    alert('ê²€í†  ëŒ€ê¸° ì¤‘ì¸ ì‘ì—…ë§Œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    window.location.href = 'jobs.html';
                    return;
                }
                
                // ì‘ì—… ì •ë³´ í‘œì‹œ
                displayJobInfo();
                
                // íŒŒíŠ¸ë„ˆ ì •ë³´ í‘œì‹œ
                await displayPartnerInfo();
                
                // ì™„ë£Œ ë³´ê³  ë‚´ìš© í‘œì‹œ
                displayCompletionReport();
                
            } catch (error) {
                console.error('ì‘ì—… ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì‘ì—… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ì‘ì—… ì •ë³´ í‘œì‹œ
        function displayJobInfo() {
            document.getElementById('spaceName').textContent = jobData.spaceInfo?.name || '-';
            document.getElementById('jobDate').textContent = jobData.schedule?.requestedDate || '-';
            document.getElementById('jobTime').textContent = jobData.schedule?.requestedTime || '-';
            document.getElementById('jobPrice').textContent = `â‚©${(jobData.pricing?.totalPrice || 0).toLocaleString()}`;
        }
        
        // íŒŒíŠ¸ë„ˆ ì •ë³´ í‘œì‹œ
        async function displayPartnerInfo() {
            try {
                const partnerDoc = await db.collection('users').doc(jobData.partnerId).get();
                
                if (partnerDoc.exists) {
                    const partnerData = partnerDoc.data();
                    
                    // íŒŒíŠ¸ë„ˆ ì´ë¦„ê³¼ ì•„ë°”íƒ€
                    const partnerName = partnerData.name || 'íŒŒíŠ¸ë„ˆ';
                    document.getElementById('partnerName').textContent = partnerName;
                    document.getElementById('partnerAvatar').textContent = partnerName.charAt(0);
                    
                    // íŒŒíŠ¸ë„ˆ í†µê³„ (ì‹¤ì œë¡œëŠ” ë³„ë„ í†µê³„ ì»¬ë ‰ì…˜ì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)
                    // ì—¬ê¸°ì„œëŠ” ì˜ˆì‹œ ë°ì´í„° ì‚¬ìš©
                    document.getElementById('partnerRating').textContent = '4.8';
                    document.getElementById('partnerJobs').textContent = '152ê±´';
                    document.getElementById('partnerExperience').textContent = '2ë…„ 3ê°œì›”';
                }
            } catch (error) {
                console.error('íŒŒíŠ¸ë„ˆ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // ì™„ë£Œ ë³´ê³  ë‚´ìš© í‘œì‹œ
        function displayCompletionReport() {
            const completion = jobData.completion;
            
            if (!completion) {
                alert('ì™„ë£Œ ë³´ê³  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                window.location.href = 'jobs.html';
                return;
            }
            
            // ì²´í¬ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
            displayChecklist(completion.checklist);
            
            // ì‚¬ì§„ í‘œì‹œ
            displayPhotos(completion.photos);
            
            // ì™„ë£Œ ë©”ëª¨ í‘œì‹œ
            if (completion.notes) {
                document.getElementById('notesSection').style.display = 'block';
                document.getElementById('completionNotes').textContent = completion.notes;
            }
        }
        
        // ì²´í¬ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
        function displayChecklist(checklist) {
            const container = document.getElementById('checklistGrid');
            
            container.innerHTML = checklist.map(item => `
                <div class="checklist-item ${item.completed ? 'completed' : ''}">
                    <span class="checklist-icon">${item.completed ? 'âœ…' : 'â¬œ'}</span>
                    <span class="checklist-text">${item.item}</span>
                </div>
            `).join('');
        }
        
        // ì‚¬ì§„ í‘œì‹œ
        function displayPhotos(photos) {
            const beforePhotos = photos.filter(p => p.type === 'before');
            const afterPhotos = photos.filter(p => p.type === 'after');
            const additionalPhotos = photos.filter(p => p.type === 'additional');
            
            // ì‘ì—… ì „ ì‚¬ì§„
            const beforeContainer = document.getElementById('beforePhotos');
            beforeContainer.innerHTML = beforePhotos.map((photo, index) => `
                <div class="photo-item" onclick="viewPhoto('${photo.url}')">
                    <img src="${photo.url}" alt="ì‘ì—… ì „ ì‚¬ì§„ ${index + 1}">
                </div>
            `).join('');
            
            // ì‘ì—… í›„ ì‚¬ì§„
            const afterContainer = document.getElementById('afterPhotos');
            afterContainer.innerHTML = afterPhotos.map((photo, index) => `
                <div class="photo-item" onclick="viewPhoto('${photo.url}')">
                    <img src="${photo.url}" alt="ì‘ì—… í›„ ì‚¬ì§„ ${index + 1}">
                </div>
            `).join('');
            
            // ì¶”ê°€ ì‚¬ì§„
            if (additionalPhotos.length > 0) {
                document.getElementById('additionalCategory').style.display = 'block';
                const additionalContainer = document.getElementById('additionalPhotos');
                additionalContainer.innerHTML = additionalPhotos.map((photo, index) => `
                    <div class="photo-item" onclick="viewPhoto('${photo.url}')">
                        <img src="${photo.url}" alt="ì¶”ê°€ ì‚¬ì§„ ${index + 1}">
                    </div>
                `).join('');
            }
        }
        
        // ì‚¬ì§„ ë·°ì–´ ì—´ê¸°
        function viewPhoto(url) {
            document.getElementById('viewerImage').src = url;
            document.getElementById('photoViewer').style.display = 'block';
        }
        
        // ì‚¬ì§„ ë·°ì–´ ë‹«ê¸°
        function closePhotoViewer() {
            document.getElementById('photoViewer').style.display = 'none';
        }
        
        // ì‘ì—… ìŠ¹ì¸
        async function approveCompletion() {
            if (!confirm('ì‘ì—…ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nìŠ¹ì¸ í›„ íŒŒíŠ¸ë„ˆì—ê²Œ ì •ì‚°ì´ ì§„í–‰ë©ë‹ˆë‹¤.')) {
                return;
            }
            
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingText').textContent = 'ì‘ì—…ì„ ìŠ¹ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
            
            try {
                // ì‘ì—… ìƒíƒœ ì—…ë°ì´íŠ¸
                await db.collection('jobs').doc(jobId).update({
                    status: 'completed',
                    'completion.approvedAt': firebase.firestore.FieldValue.serverTimestamp(),
                    'completion.approvedBy': currentUser.uid
                });
                
                // íŒŒíŠ¸ë„ˆ ìˆ˜ìµ ê¸°ë¡ (ì‹¤ì œë¡œëŠ” ë³„ë„ ì •ì‚° ì‹œìŠ¤í…œ í•„ìš”)
                await recordPartnerEarnings();
                
                // ì„±ê³µ ë©”ì‹œì§€ ë° ë¦¬ë‹¤ì´ë ‰íŠ¸
                alert('ì‘ì—…ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.\níŒŒíŠ¸ë„ˆì—ê²Œ ì •ì‚°ì´ ì§„í–‰ë©ë‹ˆë‹¤.');
                window.location.href = 'jobs.html';
                
            } catch (error) {
                console.error('ì‘ì—… ìŠ¹ì¸ ì˜¤ë¥˜:', error);
                alert('ì‘ì—… ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }
        
        // íŒŒíŠ¸ë„ˆ ìˆ˜ìµ ê¸°ë¡
        async function recordPartnerEarnings() {
            const earningData = {
                partnerId: jobData.partnerId,
                jobId: jobId,
                businessId: currentUser.uid,
                amount: jobData.pricing?.partnerPrice || 0,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('earnings').add(earningData);
        }
        
        // ì¬ì‘ì—… ìš”ì²­ ëª¨ë‹¬ í‘œì‹œ
        function showRejectModal() {
            document.getElementById('rejectModal').style.display = 'block';
        }
        
        // ì¬ì‘ì—… ìš”ì²­ ëª¨ë‹¬ ë‹«ê¸°
        function closeRejectModal() {
            document.getElementById('rejectModal').style.display = 'none';
            document.getElementById('rejectDetails').value = '';
            document.querySelectorAll('input[name="rejectReason"]').forEach(radio => {
                radio.checked = false;
            });
        }
        
        // ì¬ì‘ì—… ìš”ì²­ ì œì¶œ
        async function submitRejection() {
            const selectedReason = document.querySelector('input[name="rejectReason"]:checked');
            const details = document.getElementById('rejectDetails').value.trim();
            
            if (!selectedReason) {
                alert('ì¬ì‘ì—… ìš”ì²­ ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!details) {
                alert('ìƒì„¸ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!confirm('ì¬ì‘ì—…ì„ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\níŒŒíŠ¸ë„ˆì—ê²Œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤.')) {
                return;
            }
            
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingText').textContent = 'ì¬ì‘ì—… ìš”ì²­ì„ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
            
            try {
                // ì‘ì—… ìƒíƒœ ì—…ë°ì´íŠ¸
                await db.collection('jobs').doc(jobId).update({
                    status: 'in_progress',
                    'completion.rejected': true,
                    'completion.rejectedAt': firebase.firestore.FieldValue.serverTimestamp(),
                    'completion.rejectedBy': currentUser.uid,
                    'completion.rejectionReason': selectedReason.value,
                    'completion.rejectionDetails': details
                });
                
                // íŒŒíŠ¸ë„ˆì—ê²Œ ì•Œë¦¼ (ì‹¤ì œë¡œëŠ” FCM ë“± ì‚¬ìš©)
                console.log('ì¬ì‘ì—… ì•Œë¦¼ ì „ì†¡:', jobData.partnerId);
                
                // ì„±ê³µ ë©”ì‹œì§€ ë° ë¦¬ë‹¤ì´ë ‰íŠ¸
                alert('ì¬ì‘ì—… ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.\níŒŒíŠ¸ë„ˆì—ê²Œ ì•Œë¦¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = 'jobs.html';
                
            } catch (error) {
                console.error('ì¬ì‘ì—… ìš”ì²­ ì˜¤ë¥˜:', error);
                alert('ì¬ì‘ì—… ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const rejectModal = document.getElementById('rejectModal');
            if (event.target === rejectModal) {
                closeRejectModal();
            }
        }
    </script>
</body>
</html>