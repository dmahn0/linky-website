<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linky - ê³µê°„ ë“±ë¡</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Supabase í™˜ê²½ë³€ìˆ˜ (ê°œë°œìš©) -->
    <script src="../supabase-env.js"></script>
    
    <!-- Supabase ì„¤ì • -->
    <script src="../supabase-config.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: #2d3748;
            background: #f7fafc;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
            color: #1a202c;
        }

        .header p {
            color: #6b7280;
        }

        .form-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .form-section h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #1a202c;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .photo-upload {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f9fafb;
            transition: border-color 0.2s;
        }

        .photo-upload:hover {
            border-color: #3b82f6;
        }

        .photo-upload input[type="file"] {
            display: none;
        }

        .photo-upload label {
            display: inline-block;
            padding: 12px 24px;
            background: #3b82f6;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .photo-upload label:hover {
            background: #2563eb;
        }

        .photo-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .photo-preview img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            text-decoration: none;
        }

        .btn:hover {
            background: #2563eb;
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .help-text {
            font-size: 14px;
            color: #6b7280;
            margin-top: 5px;
        }

        .required {
            color: #ef4444;
        }

        .loading {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¢ ê³µê°„ ë“±ë¡</h1>
            <p>ìƒˆë¡œìš´ ê³µê°„ì„ ë“±ë¡í•˜ì—¬ ì •ë¦¬ ì„œë¹„ìŠ¤ë¥¼ ìš”ì²­í•˜ì„¸ìš”</p>
        </div>

        <div class="alert" id="alertMessage"></div>

        <form id="spaceRegistrationForm">
            <!-- ê¸°ë³¸ ì •ë³´ -->
            <div class="form-section">
                <h2>ğŸ  ê¸°ë³¸ ì •ë³´</h2>
                
                <div class="form-group">
                    <label for="spaceName">ê³µê°„ëª… <span class="required">*</span></label>
                    <input type="text" id="spaceName" name="spaceName" required 
                           placeholder="ì˜ˆ: ê°•ë‚¨ ìŠ¤í„°ë””ë£¸ Aí˜¸">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="spaceType">ê³µê°„ ìœ í˜• <span class="required">*</span></label>
                        <select id="spaceType" name="spaceType" required>
                            <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
                            <option value="studyroom">ìŠ¤í„°ë””ë£¸</option>
                            <option value="partyroom">íŒŒí‹°ë£¸</option>
                            <option value="unmanned">ë¬´ì¸ë§¤ì¥</option>
                            <option value="office">ì‚¬ë¬´ì‹¤</option>
                            <option value="other">ê¸°íƒ€</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="spaceSize">ê³µê°„ í¬ê¸° (í‰) <span class="required">*</span></label>
                        <input type="number" id="spaceSize" name="spaceSize" required 
                               placeholder="15" min="1" max="100">
                    </div>
                </div>

                <div class="form-group">
                    <label for="capacity">ìµœëŒ€ ìˆ˜ìš©ì¸ì› (ëª…)</label>
                    <input type="number" id="capacity" name="capacity" 
                           placeholder="6" min="1" max="50">
                </div>
            </div>

            <!-- ìœ„ì¹˜ ì •ë³´ -->
            <div class="form-section">
                <h2>ğŸ“ ìœ„ì¹˜ ì •ë³´</h2>
                
                <div class="form-group">
                    <label for="fullAddress">ì „ì²´ ì£¼ì†Œ <span class="required">*</span></label>
                    <input type="text" id="fullAddress" name="fullAddress" required 
                           placeholder="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ë…¼í˜„ë™ 123-45 ë…¼í˜„ë¹Œë”© 3ì¸µ">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="sido">ì‹œë„ <span class="required">*</span></label>
                        <select id="sido" name="sido" required>
                            <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
                            <option value="ì„œìš¸ì‹œ">ì„œìš¸ì‹œ</option>
                            <option value="ê²½ê¸°ë„">ê²½ê¸°ë„</option>
                            <option value="ì¸ì²œì‹œ">ì¸ì²œì‹œ</option>
                            <option value="ë¶€ì‚°ì‹œ">ë¶€ì‚°ì‹œ</option>
                            <option value="ëŒ€êµ¬ì‹œ">ëŒ€êµ¬ì‹œ</option>
                            <option value="ëŒ€ì „ì‹œ">ëŒ€ì „ì‹œ</option>
                            <option value="ê´‘ì£¼ì‹œ">ê´‘ì£¼ì‹œ</option>
                            <option value="ìš¸ì‚°ì‹œ">ìš¸ì‚°ì‹œ</option>
                            <option value="ê°•ì›ë„">ê°•ì›ë„</option>
                            <option value="ì¶©ì²­ë¶ë„">ì¶©ì²­ë¶ë„</option>
                            <option value="ì¶©ì²­ë‚¨ë„">ì¶©ì²­ë‚¨ë„</option>
                            <option value="ì „ë¼ë¶ë„">ì „ë¼ë¶ë„</option>
                            <option value="ì „ë¼ë‚¨ë„">ì „ë¼ë‚¨ë„</option>
                            <option value="ê²½ìƒë¶ë„">ê²½ìƒë¶ë„</option>
                            <option value="ê²½ìƒë‚¨ë„">ê²½ìƒë‚¨ë„</option>
                            <option value="ì œì£¼ë„">ì œì£¼ë„</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="sigungu">ì‹œêµ°êµ¬ <span class="required">*</span></label>
                        <input type="text" id="sigungu" name="sigungu" required 
                               placeholder="ê°•ë‚¨êµ¬">
                    </div>
                </div>

                <div class="form-group">
                    <label for="detailAddress">ìƒì„¸ ì£¼ì†Œ</label>
                    <input type="text" id="detailAddress" name="detailAddress" 
                           placeholder="ë…¼í˜„ë¹Œë”© 3ì¸µ 301í˜¸">
                </div>
            </div>

            <!-- ì ‘ê·¼ ì •ë³´ -->
            <div class="form-section">
                <h2>ğŸšª ì ‘ê·¼ ì •ë³´</h2>
                
                <div class="form-group">
                    <label for="entrancePassword">ì¶œì… ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="text" id="entrancePassword" name="entrancePassword" 
                           placeholder="1234">
                    <div class="help-text">íŒŒíŠ¸ë„ˆê°€ ì¶œì…í•  ë•Œ í•„ìš”í•œ ë¹„ë°€ë²ˆí˜¸</div>
                </div>

                <div class="form-group">
                    <label for="accessInstructions">ì¶œì… ë°©ë²•</label>
                    <textarea id="accessInstructions" name="accessInstructions" 
                              placeholder="ì •ë¬¸ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í›„ ì—˜ë¦¬ë² ì´í„° 3ì¸µ, 301í˜¸ë¡œ ë“¤ì–´ì˜¤ì„¸ìš”"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="parkingInfo">ì£¼ì°¨ ì •ë³´</label>
                        <input type="text" id="parkingInfo" name="parkingInfo" 
                               placeholder="ê±´ë¬¼ ì§€í•˜ 1ì¸µ (2ì‹œê°„ ë¬´ë£Œ)">
                    </div>

                    <div class="form-group">
                        <label for="publicTransport">ëŒ€ì¤‘êµí†µ ì •ë³´</label>
                        <input type="text" id="publicTransport" name="publicTransport" 
                               placeholder="ê°•ë‚¨ì—­ 5ë²ˆ ì¶œêµ¬ ë„ë³´ 5ë¶„">
                    </div>
                </div>
            </div>

            <!-- ì‹œì„¤ ì •ë³´ -->
            <div class="form-section">
                <h2>ğŸ—ï¸ ì‹œì„¤ ì •ë³´</h2>
                
                <div class="form-group">
                    <label>ë³´ìœ  ì‹œì„¤</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="hasToilet" name="amenities" value="toilet">
                            <label for="hasToilet">í™”ì¥ì‹¤</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="hasSink" name="amenities" value="sink">
                            <label for="hasSink">ì„¸ë©´ëŒ€</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="hasKitchen" name="amenities" value="kitchen">
                            <label for="hasKitchen">ì£¼ë°©/ê°„ì´ì£¼ë°©</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="hasAircon" name="amenities" value="aircon">
                            <label for="hasAircon">ì—ì–´ì»¨</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="hasHeating" name="amenities" value="heating">
                            <label for="hasHeating">ë‚œë°©</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="hasWifi" name="amenities" value="wifi">
                            <label for="hasWifi">WiFi</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="hasCCTV" name="amenities" value="cctv">
                            <label for="hasCCTV">CCTV</label>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="openTime">ìš´ì˜ ì‹œì‘ ì‹œê°„</label>
                        <input type="time" id="openTime" name="openTime" value="09:00">
                    </div>

                    <div class="form-group">
                        <label for="closeTime">ìš´ì˜ ì¢…ë£Œ ì‹œê°„</label>
                        <input type="time" id="closeTime" name="closeTime" value="22:00">
                    </div>
                </div>
            </div>

            <!-- ì •ë¦¬ ì„œë¹„ìŠ¤ ì„¤ì • -->
            <div class="form-section">
                <h2>ğŸ§¹ ì •ë¦¬ ì„œë¹„ìŠ¤ ì„¤ì •</h2>
                
                <div class="form-group">
                    <label for="prohibitedItems">ì²˜ë¦¬ ê¸ˆì§€ ë¬¼í’ˆ</label>
                    <textarea id="prohibitedItems" name="prohibitedItems" 
                              placeholder="ìŒì‹ë¬¼ì“°ë ˆê¸°, ê°œì¸ ì†Œì§€í’ˆ"></textarea>
                    <div class="help-text">íŒŒíŠ¸ë„ˆê°€ ì²˜ë¦¬í•˜ë©´ ì•ˆ ë˜ëŠ” ë¬¼í’ˆë“¤ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
                </div>

                <div class="form-group">
                    <label for="specialRequests">íŠ¹ë³„ ìš”ì²­ì‚¬í•­</label>
                    <textarea id="specialRequests" name="specialRequests" 
                              placeholder="íšŒì˜ í…Œì´ë¸” ë°°ì¹˜ëŠ” ã…ìë¡œ ìœ ì§€í•´ì£¼ì„¸ìš”"></textarea>
                </div>
            </div>

            <!-- ê³µê°„ ì‚¬ì§„ -->
            <div class="form-section">
                <h2>ğŸ“¸ ê³µê°„ ì‚¬ì§„</h2>
                
                <div class="form-group">
                    <label>ê³µê°„ ì‚¬ì§„ ì—…ë¡œë“œ</label>
                    <div class="photo-upload">
                        <p>ğŸ“· ê³µê°„ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”</p>
                        <p style="color: #6b7280; font-size: 14px; margin: 10px 0;">
                            íŒŒíŠ¸ë„ˆê°€ ê³µê°„ì„ ì‰½ê²Œ ì°¾ê³  ì´í•´í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì¤ë‹ˆë‹¤
                        </p>
                        <label for="spacePhotos">ì‚¬ì§„ ì„ íƒ</label>
                        <input type="file" id="spacePhotos" name="spacePhotos" 
                               accept="image/*" multiple>
                    </div>
                    <div class="photo-preview" id="photoPreview"></div>
                </div>
            </div>

            <div class="btn-group">
                <button type="button" class="btn btn-secondary" onclick="history.back()">ì·¨ì†Œ</button>
                <button type="submit" class="btn">
                    <span class="btn-text">ê³µê°„ ë“±ë¡í•˜ê¸°</span>
                    <span class="loading"></span>
                </button>
            </div>
        </form>
    </div>

    <script>
        // ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸°
        document.getElementById('spacePhotos').addEventListener('change', function(e) {
            const files = e.target.files;
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';

            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    preview.appendChild(img);
                }
            });
        });

        // í¼ ì œì¶œ ì²˜ë¦¬
        document.getElementById('spaceRegistrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const loading = submitBtn.querySelector('.loading');
            const alertMessage = document.getElementById('alertMessage');

            // ë¡œê·¸ì¸ í™•ì¸
            const currentUser = auth.currentUser;
            if (!currentUser) {
                showAlert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            // ë¡œë”© ìƒíƒœ
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            loading.style.display = 'inline-block';

            try {
                // í¼ ë°ì´í„° ìˆ˜ì§‘
                const formData = new FormData(e.target);
                const spaceData = {
                    ownerId: currentUser.uid,
                    name: formData.get('spaceName'),
                    type: formData.get('spaceType'),
                    size: parseInt(formData.get('spaceSize')),
                    capacity: parseInt(formData.get('capacity')) || null,
                    
                    address: {
                        fullAddress: formData.get('fullAddress'),
                        sido: formData.get('sido'),
                        sigungu: formData.get('sigungu'),
                        detail: formData.get('detailAddress') || ''
                    },
                    
                    accessInfo: {
                        entrancePassword: formData.get('entrancePassword') || '',
                        specialInstructions: formData.get('accessInstructions') || '',
                        parkingInfo: formData.get('parkingInfo') || '',
                        publicTransport: formData.get('publicTransport') || ''
                    },
                    
                    amenities: {
                        hasToilet: formData.getAll('amenities').includes('toilet'),
                        hasSink: formData.getAll('amenities').includes('sink'),
                        hasKitchen: formData.getAll('amenities').includes('kitchen'),
                        hasAircon: formData.getAll('amenities').includes('aircon'),
                        hasHeating: formData.getAll('amenities').includes('heating'),
                        hasWifi: formData.getAll('amenities').includes('wifi'),
                        hasCCTV: formData.getAll('amenities').includes('cctv')
                    },
                    
                    operatingHours: {
                        openTime: formData.get('openTime') || '09:00',
                        closeTime: formData.get('closeTime') || '22:00'
                    },
                    
                    cleaningPreferences: {
                        prohibitedItems: formData.get('prohibitedItems') || '',
                        specialRequests: formData.get('specialRequests') || '',
                        photoRequired: true
                    },
                    
                    status: 'active',
                    stats: {
                        totalJobs: 0,
                        thisMonthJobs: 0,
                        averageRating: 0
                    }
                };

                // ì‚¬ì§„ ì—…ë¡œë“œ ì²˜ë¦¬ (í–¥í›„ êµ¬í˜„)
                const photos = document.getElementById('spacePhotos').files;
                if (photos.length > 0) {
                    // TODO: Firebase Storageì— ì‚¬ì§„ ì—…ë¡œë“œ
                    spaceData.photos = [];
                }

                // Firestoreì— ê³µê°„ ì •ë³´ ì €ì¥
                const result = await FirebaseDB.createSpace(spaceData);
                
                if (result.success) {
                    showAlert('ê³µê°„ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    
                    // 2ì´ˆ í›„ ì‚¬ì—…ì ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                } else {
                    showAlert('ê³µê°„ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + result.error, 'error');
                }

            } catch (error) {
                console.error('ê³µê°„ ë“±ë¡ ì˜¤ë¥˜:', error);
                showAlert('ê³µê°„ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                // ë¡œë”© ìƒíƒœ í•´ì œ
                submitBtn.disabled = false;
                btnText.style.display = 'inline';
                loading.style.display = 'none';
            }
        });

        // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
        function showAlert(message, type) {
            const alertMessage = document.getElementById('alertMessage');
            alertMessage.textContent = message;
            alertMessage.className = `alert ${type}`;
            alertMessage.style.display = 'block';
            
            // 5ì´ˆ í›„ ì•Œë¦¼ ìˆ¨ê¸°ê¸°
            setTimeout(() => {
                alertMessage.style.display = 'none';
            }, 5000);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ í™•ì¸
        document.addEventListener('DOMContentLoaded', function() {
            auth.onAuthStateChanged(function(user) {
                if (!user) {
                    // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (í˜„ì¬ í˜ì´ì§€ë¥¼ redirect íŒŒë¼ë¯¸í„°ë¡œ)
                    const currentPage = window.location.pathname.split('/').pop();
                    window.location.href = `index.html?redirect=${encodeURIComponent(currentPage)}`;
                }
            });
        });
    </script>
</body>
</html>