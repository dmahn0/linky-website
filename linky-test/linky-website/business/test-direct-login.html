<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>직접 로그인 테스트</title>
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        input { padding: 10px; margin: 5px; width: 300px; }
        button { padding: 10px 20px; background: #22c55e; color: white; border: none; cursor: pointer; }
        #log { background: #f5f5f5; padding: 20px; margin-top: 20px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>직접 로그인 테스트</h1>
    
    <input type="email" id="email" placeholder="이메일" value="test1234@test1234.com">
    <br>
    <input type="password" id="password" placeholder="비밀번호">
    <br>
    <button onclick="testLogin()">로그인 테스트</button>
    <button onclick="testAuthModal()">AuthModal 로그인</button>
    
    <div id="log"></div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Supabase 설정 -->
    <script>
        function waitForSupabase() {
            return new Promise((resolve) => {
                if (window.supabase && window.supabase.createClient) {
                    resolve();
                } else {
                    setTimeout(() => waitForSupabase().then(resolve), 50);
                }
            });
        }
        
        waitForSupabase().then(() => {
            console.log('Supabase SDK 로드 완료');
            const script = document.createElement('script');
            script.src = '../supabase-config.js';
            script.onload = () => console.log('supabase-config.js 로드 완료');
            document.head.appendChild(script);
        });
    </script>
    
    <!-- auth-modal.js -->
    <script src="../auth-modal.js" defer></script>
    
    <script>
        function log(msg) {
            document.getElementById('log').innerHTML += msg + '\n';
        }
        
        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            log('직접 로그인 테스트 시작...');
            
            try {
                log('signInWithPassword 호출 전');
                const { data, error } = await window.supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                log('signInWithPassword 호출 후');
                
                if (error) {
                    log('로그인 실패: ' + error.message);
                } else {
                    log('로그인 성공!');
                    log('사용자 ID: ' + data.user.id);
                    
                    // 사용자 정보 조회
                    const { data: userData } = await window.supabaseClient
                        .from('users')
                        .select('*')
                        .eq('uid', data.user.id)
                        .limit(1);
                    
                    if (userData && userData.length > 0) {
                        log('사용자 타입: ' + userData[0].type);
                        
                        // 리다이렉트
                        if (userData[0].type === 'business') {
                            log('3초 후 dashboard.html로 이동...');
                            setTimeout(() => {
                                window.location.href = 'dashboard.html';
                            }, 3000);
                        }
                    }
                }
            } catch (err) {
                log('예외 발생: ' + err.message);
                console.error(err);
            }
        }
        
        function testAuthModal() {
            if (window.authModal) {
                window.authModal.openLogin();
            } else {
                log('authModal이 아직 로드되지 않았습니다.');
            }
        }
    </script>
</body>
</html>