<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로그인 디버깅</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            padding: 12px 24px;
            background-color: #22c55e;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background-color: #16a34a;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .log {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .info { color: blue; }
    </style>
</head>
<body>
    <div class="container">
        <h1>로그인 디버깅 도구</h1>
        
        <div class="form-group">
            <label for="email">이메일:</label>
            <input type="email" id="email" placeholder="user@example.com">
        </div>
        
        <div class="form-group">
            <label for="password">비밀번호:</label>
            <input type="password" id="password" placeholder="비밀번호 입력">
        </div>
        
        <button onclick="testLogin()">로그인 테스트</button>
        <button onclick="checkUser()">사용자 정보 확인</button>
        <button onclick="checkSession()">세션 확인</button>
        <button onclick="clearLog()">로그 지우기</button>
        
        <div id="log" class="log">로그가 여기에 표시됩니다...\n</div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Supabase 설정 -->
    <script src="supabase-config.js"></script>
    
    <script>
        let supabaseClient;
        
        // 즉시 초기 로그 출력
        document.addEventListener('DOMContentLoaded', function() {
            log('페이지 로드 완료', 'info');
            log('Supabase 초기화 시작...', 'info');
            
            // Supabase SDK 확인
            if (typeof window.supabase === 'undefined') {
                log('Supabase SDK가 로드되지 않았습니다.', 'error');
                return;
            } else {
                log('Supabase SDK 로드 확인', 'success');
            }
            
            waitForSupabase();
        });
        
        // Supabase 초기화 대기
        async function waitForSupabase() {
            let attempts = 0;
            const maxAttempts = 50; // 5초 대기
            
            while (!window.supabaseClient && attempts < maxAttempts) {
                attempts++;
                log(`Supabase 클라이언트 대기 중... (${attempts}/${maxAttempts})`, 'info');
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            if (window.supabaseClient) {
                supabaseClient = window.supabaseClient;
                log('Supabase 클라이언트 준비 완료!', 'success');
                
                // 연결 테스트
                try {
                    const { data, error } = await supabaseClient.auth.getSession();
                    if (error) {
                        log(`세션 확인 오류: ${error.message}`, 'warning');
                    } else {
                        log('Supabase 연결 테스트 성공', 'success');
                        if (data.session) {
                            log('기존 세션이 존재합니다.', 'info');
                        } else {
                            log('새로운 세션이 필요합니다.', 'info');
                        }
                    }
                } catch (err) {
                    log(`연결 테스트 실패: ${err.message}`, 'error');
                }
            } else {
                log('Supabase 클라이언트 초기화 실패 - 시간 초과', 'error');
                log('supabase-config.js 파일을 확인해주세요.', 'error');
            }
        }
        
        function log(message, type = '') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type ? ` class="${type}"` : '';
            logElement.innerHTML += `<div${className}>[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '로그가 지워졌습니다...\n';
        }
        
        // 로그인 테스트
        async function testLogin() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!email || !password) {
                log('이메일과 비밀번호를 입력해주세요.', 'error');
                return;
            }
            
            try {
                log(`로그인 시도: ${email}`, 'info');
                
                // 1. Supabase 인증
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) {
                    log(`인증 실패: ${error.message}`, 'error');
                    return;
                }
                
                log('Supabase 인증 성공!', 'success');
                log(`사용자 ID: ${data.user.id}`, 'info');
                log(`이메일: ${data.user.email}`, 'info');
                
                // 2. Users 테이블에서 사용자 정보 조회
                const { data: userData, error: userError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('uid', data.user.id)
                    .limit(1);
                
                const userRecord = userData && userData.length > 0 ? userData[0] : null;
                
                if (userError) {
                    log(`사용자 정보 조회 오류: ${userError.message}`, 'error');
                } else if (userRecord) {
                    log('사용자 정보 조회 성공!', 'success');
                    log(`이름: ${userRecord.name}`, 'info');
                    log(`타입: ${userRecord.type}`, 'info');
                    log(`상태: ${userRecord.status || 'N/A'}`, 'info');
                    log(`생성일: ${userRecord.created_at}`, 'info');
                    
                    // 3. 리다이렉트 시뮬레이션
                    simulateRedirect(userRecord);
                } else {
                    log('사용자 정보를 찾을 수 없습니다.', 'warning');
                    log('Users 테이블에 해당 사용자가 없을 수 있습니다.', 'warning');
                }
                
            } catch (error) {
                log(`로그인 오류: ${error.message}`, 'error');
            }
        }
        
        // 리다이렉트 시뮬레이션
        function simulateRedirect(user) {
            const currentPath = window.location.pathname;
            const isInBusinessDir = currentPath.includes('/business/');
            const isInPartnersDir = currentPath.includes('/partners/');
            
            log('\n=== 리다이렉트 시뮬레이션 ===', 'info');
            log(`현재 경로: ${currentPath}`, 'info');
            log(`Business 디렉토리: ${isInBusinessDir}`, 'info');
            log(`Partners 디렉토리: ${isInPartnersDir}`, 'info');
            
            if (!user) {
                log('→ 메인 페이지로 이동 (사용자 데이터 없음)', 'warning');
                return;
            }
            
            if (!user.type) {
                log('→ 타입 설정 필요 (사용자 타입 없음)', 'warning');
                return;
            }
            
            if (user.type === 'business') {
                if (isInBusinessDir) {
                    log('→ dashboard.html로 이동', 'success');
                } else {
                    log('→ ./business/dashboard.html로 이동', 'success');
                }
            } else if (user.type === 'partner') {
                if (isInPartnersDir) {
                    log('→ ./dashboard.html로 이동', 'success');
                } else if (isInBusinessDir) {
                    log('→ ../partners/로 이동', 'success');
                } else {
                    log('→ ./partners/로 이동', 'success');
                }
            } else {
                log(`→ 페이지 새로고침 (알 수 없는 타입: ${user.type})`, 'warning');
            }
        }
        
        // 사용자 정보 확인
        async function checkUser() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                
                if (!user) {
                    log('현재 로그인된 사용자가 없습니다.', 'warning');
                    return;
                }
                
                log('현재 로그인된 사용자:', 'info');
                log(`ID: ${user.id}`, 'info');
                log(`이메일: ${user.email}`, 'info');
                log(`생성일: ${user.created_at}`, 'info');
                
                // Users 테이블 정보 조회
                const { data: userData, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('uid', user.id)
                    .limit(1);
                
                const userRecord = userData && userData.length > 0 ? userData[0] : null;
                
                if (error) {
                    log(`Users 테이블 조회 오류: ${error.message}`, 'error');
                } else if (userRecord) {
                    log('Users 테이블 정보:', 'info');
                    log(`이름: ${userRecord.name}`, 'info');
                    log(`타입: ${userRecord.type}`, 'info');
                    log(`상태: ${userRecord.status || 'N/A'}`, 'info');
                } else {
                    log('Users 테이블에서 사용자를 찾을 수 없습니다.', 'warning');
                }
                
            } catch (error) {
                log(`사용자 정보 확인 오류: ${error.message}`, 'error');
            }
        }
        
        // 세션 확인
        async function checkSession() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (!session) {
                    log('현재 세션이 없습니다.', 'warning');
                    return;
                }
                
                log('현재 세션 정보:', 'info');
                log(`액세스 토큰: ${session.access_token.substring(0, 20)}...`, 'info');
                log(`만료 시간: ${new Date(session.expires_at * 1000).toLocaleString()}`, 'info');
                log(`토큰 타입: ${session.token_type}`, 'info');
                
            } catch (error) {
                log(`세션 확인 오류: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>