<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase 초기화 테스트</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.pending {
            background: #fff3cd;
            color: #856404;
        }
        pre {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            overflow-x: auto;
        }
        button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 10px;
        }
        button:hover {
            background: #218838;
        }
        #log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Supabase 초기화 테스트</h1>
    
    <div class="test-section">
        <h2>1. SDK 로드 상태</h2>
        <p>Supabase SDK 로드 상태: <span id="sdk-status" class="status pending">확인 중...</span></p>
        <p>window.supabase 존재: <span id="window-supabase" class="status pending">확인 중...</span></p>
    </div>
    
    <div class="test-section">
        <h2>2. Supabase 설정 로드</h2>
        <p>supabase-config.js 로드: <span id="config-status" class="status pending">로드 전</span></p>
        <button onclick="loadSupabaseConfig()">supabase-config.js 로드</button>
    </div>
    
    <div class="test-section">
        <h2>3. Supabase 클라이언트 상태</h2>
        <p>window.supabaseClient 존재: <span id="client-status" class="status pending">확인 중...</span></p>
        <p>window.supabaseClient 타입: <span id="client-type" class="status pending">확인 중...</span></p>
        <button onclick="checkSupabaseClient()">클라이언트 확인</button>
    </div>
    
    <div class="test-section">
        <h2>4. 인증 테스트</h2>
        <button onclick="testSignIn()">로그인 테스트</button>
        <button onclick="testCurrentUser()">현재 사용자 확인</button>
        <button onclick="testAuthState()">인증 상태 구독</button>
    </div>
    
    <div class="test-section">
        <h2>5. 실시간 로그</h2>
        <div id="log"></div>
        <button onclick="clearLog()">로그 초기화</button>
    </div>
    
    <script>
        // 로그 함수
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : '#fff';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}]`, message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // SDK 로드 상태 확인
        function checkSDKStatus() {
            const sdkExists = typeof window.supabase !== 'undefined';
            const createClientExists = sdkExists && typeof window.supabase.createClient === 'function';
            
            document.getElementById('sdk-status').className = 'status ' + (createClientExists ? 'success' : 'error');
            document.getElementById('sdk-status').textContent = createClientExists ? '로드 완료' : '로드 실패';
            
            document.getElementById('window-supabase').className = 'status ' + (sdkExists ? 'success' : 'error');
            document.getElementById('window-supabase').textContent = sdkExists ? '존재함' : '존재하지 않음';
            
            log(`SDK 상태 - window.supabase: ${sdkExists}, createClient: ${createClientExists}`);
            
            if (createClientExists) {
                log('Supabase SDK 로드 완료!', 'success');
            }
        }
        
        // supabase-config.js 로드
        function loadSupabaseConfig() {
            log('supabase-config.js 로드 시작...');
            
            const script = document.createElement('script');
            script.src = './supabase-config.js';
            script.onload = () => {
                document.getElementById('config-status').className = 'status success';
                document.getElementById('config-status').textContent = '로드 완료';
                log('supabase-config.js 로드 완료', 'success');
                
                // supabaseReady 이벤트 리스너
                window.addEventListener('supabaseReady', () => {
                    log('supabaseReady 이벤트 발생!', 'success');
                    checkSupabaseClient();
                });
            };
            script.onerror = () => {
                document.getElementById('config-status').className = 'status error';
                document.getElementById('config-status').textContent = '로드 실패';
                log('supabase-config.js 로드 실패', 'error');
            };
            
            document.head.appendChild(script);
        }
        
        // Supabase 클라이언트 확인
        function checkSupabaseClient() {
            const clientExists = typeof window.supabaseClient !== 'undefined';
            const clientType = clientExists ? typeof window.supabaseClient : 'undefined';
            
            document.getElementById('client-status').className = 'status ' + (clientExists ? 'success' : 'error');
            document.getElementById('client-status').textContent = clientExists ? '존재함' : '존재하지 않음';
            
            document.getElementById('client-type').className = 'status ' + (clientExists ? 'success' : 'error');
            document.getElementById('client-type').textContent = clientType;
            
            log(`Supabase 클라이언트 - 존재: ${clientExists}, 타입: ${clientType}`);
            
            if (clientExists && window.supabaseClient.auth) {
                log('Supabase 클라이언트 정상 초기화됨!', 'success');
                log(`Auth 메서드: ${Object.keys(window.supabaseClient.auth).join(', ')}`);
            }
        }
        
        // 로그인 테스트
        async function testSignIn() {
            if (!window.supabaseClient) {
                log('Supabase 클라이언트가 초기화되지 않았습니다.', 'error');
                return;
            }
            
            log('로그인 테스트 시작...');
            
            try {
                // 테스트 계정으로 로그인 시도
                const { data, error } = await window.supabaseClient.auth.signInWithPassword({
                    email: 'test@example.com',
                    password: 'testpassword'
                });
                
                if (error) {
                    log(`로그인 실패: ${error.message}`, 'error');
                } else {
                    log('로그인 성공!', 'success');
                    log(`사용자 ID: ${data.user.id}`);
                }
            } catch (err) {
                log(`예외 발생: ${err.message}`, 'error');
            }
        }
        
        // 현재 사용자 확인
        async function testCurrentUser() {
            if (!window.supabaseClient) {
                log('Supabase 클라이언트가 초기화되지 않았습니다.', 'error');
                return;
            }
            
            log('현재 사용자 확인...');
            
            try {
                const { data: { user } } = await window.supabaseClient.auth.getUser();
                
                if (user) {
                    log('현재 로그인된 사용자:', 'success');
                    log(`ID: ${user.id}`);
                    log(`Email: ${user.email}`);
                } else {
                    log('로그인된 사용자가 없습니다.');
                }
            } catch (err) {
                log(`예외 발생: ${err.message}`, 'error');
            }
        }
        
        // 인증 상태 구독
        function testAuthState() {
            if (!window.supabaseClient) {
                log('Supabase 클라이언트가 초기화되지 않았습니다.', 'error');
                return;
            }
            
            log('인증 상태 구독 시작...');
            
            const { data: { subscription } } = window.supabaseClient.auth.onAuthStateChange((event, session) => {
                log(`인증 상태 변경: ${event}`);
                if (session) {
                    log(`세션 사용자: ${session.user.email}`);
                } else {
                    log('세션 없음');
                }
            });
            
            log('인증 상태 구독 완료', 'success');
        }
        
        // 페이지 로드 시 SDK 상태 확인
        window.addEventListener('load', () => {
            log('페이지 로드 완료');
            checkSDKStatus();
        });
        
        // SDK 로드 감지
        let sdkCheckInterval = setInterval(() => {
            if (window.supabase && window.supabase.createClient) {
                clearInterval(sdkCheckInterval);
                checkSDKStatus();
            }
        }, 100);
    </script>
</body>
</html>