<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linky - 데이터 검증 도구</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <!-- Firebase 설정 -->
    <script src="firebase-config.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #22c55e;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status.success {
            background: #22c55e;
            color: white;
        }
        
        .status.error {
            background: #ef4444;
            color: white;
        }
        
        .status.warning {
            background: #f59e0b;
            color: white;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .data-table th,
        .data-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .data-table th {
            background: #f0f0f0;
            font-weight: bold;
        }
        
        .btn {
            padding: 10px 20px;
            background: #22c55e;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .btn:hover {
            background: #16a34a;
        }
        
        .btn.danger {
            background: #ef4444;
        }
        
        .btn.danger:hover {
            background: #dc2626;
        }
        
        .log {
            background: #1e293b;
            color: #10b981;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .log .error {
            color: #ef4444;
        }
        
        .log .warning {
            color: #f59e0b;
        }
        
        .log .info {
            color: #3b82f6;
        }
        
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Linky 데이터 검증 도구</h1>
        
        <!-- Firebase 연결 상태 -->
        <div class="section">
            <h2>
                🔥 Firebase 연결 상태
                <span id="firebaseStatus" class="status">확인 중...</span>
            </h2>
            <div id="firebaseInfo"></div>
        </div>
        
        <!-- 현재 사용자 정보 -->
        <div class="section">
            <h2>
                👤 현재 로그인 사용자
                <span id="userStatus" class="status">확인 중...</span>
            </h2>
            <div id="currentUserInfo"></div>
            <button class="btn" onclick="refreshUserInfo()">새로고침</button>
            <button class="btn danger" onclick="logoutUser()">로그아웃</button>
        </div>
        
        <!-- 데이터베이스 상태 -->
        <div class="section">
            <h2>
                💾 데이터베이스 상태
                <span id="dbStatus" class="status">확인 중...</span>
            </h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>컬렉션</th>
                        <th>문서 수</th>
                        <th>상태</th>
                        <th>액션</th>
                    </tr>
                </thead>
                <tbody id="dbStatusTable">
                    <tr><td colspan="4">로딩 중...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- 최근 회원가입 목록 -->
        <div class="section">
            <h2>📝 최근 회원가입 (최근 10명)</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>이름</th>
                        <th>이메일</th>
                        <th>타입</th>
                        <th>상태</th>
                        <th>가입일</th>
                        <th>UID</th>
                    </tr>
                </thead>
                <tbody id="recentUsersTable">
                    <tr><td colspan="6">로딩 중...</td></tr>
                </tbody>
            </table>
            <button class="btn" onclick="loadRecentUsers()">새로고침</button>
        </div>
        
        <!-- 테스트 도구 -->
        <div class="section">
            <h2>🧪 테스트 도구</h2>
            <button class="btn" onclick="testSignup()">테스트 회원가입</button>
            <button class="btn" onclick="testFirestore()">Firestore 쓰기 테스트</button>
            <button class="btn" onclick="checkPermissions()">권한 확인</button>
            <button class="btn danger" onclick="clearTestData()">테스트 데이터 삭제</button>
        </div>
        
        <!-- 로그 콘솔 -->
        <div class="section">
            <h2>📋 실시간 로그</h2>
            <div id="logConsole" class="log">
                <div class="info">로그 콘솔 초기화됨...</div>
            </div>
            <button class="btn" onclick="clearLogs()">로그 지우기</button>
        </div>
    </div>
    
    <script>
        // 로그 함수
        function log(message, type = 'info') {
            const logConsole = document.getElementById('logConsole');
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${time}] ${message}`;
            logConsole.appendChild(logEntry);
            logConsole.scrollTop = logConsole.scrollHeight;
            
            // 콘솔에도 출력
            console.log(`[${type}] ${message}`);
        }
        
        function clearLogs() {
            document.getElementById('logConsole').innerHTML = '<div class="info">로그 콘솔 초기화됨...</div>';
        }
        
        // Firebase 상태 확인
        function checkFirebaseStatus() {
            const statusEl = document.getElementById('firebaseStatus');
            const infoEl = document.getElementById('firebaseInfo');
            
            try {
                if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                    statusEl.className = 'status success';
                    statusEl.textContent = '연결됨';
                    
                    const config = firebase.app().options;
                    infoEl.innerHTML = `
                        <p><strong>Project ID:</strong> ${config.projectId}</p>
                        <p><strong>Auth Domain:</strong> ${config.authDomain}</p>
                        <p><strong>API Key:</strong> ${config.apiKey.substring(0, 10)}...</p>
                    `;
                    log('Firebase 연결 확인됨', 'info');
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = '연결 실패';
                    infoEl.innerHTML = '<p>Firebase가 초기화되지 않았습니다.</p>';
                    log('Firebase 연결 실패', 'error');
                }
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = '오류';
                infoEl.innerHTML = `<p>오류: ${error.message}</p>`;
                log(`Firebase 상태 확인 오류: ${error.message}`, 'error');
            }
        }
        
        // 현재 사용자 정보
        function refreshUserInfo() {
            const statusEl = document.getElementById('userStatus');
            const infoEl = document.getElementById('currentUserInfo');
            
            const user = auth.currentUser;
            if (user) {
                statusEl.className = 'status success';
                statusEl.textContent = '로그인됨';
                
                // Firestore에서 추가 정보 가져오기
                db.collection('users').doc(user.uid).get()
                    .then(doc => {
                        if (doc.exists) {
                            const userData = doc.data();
                            infoEl.innerHTML = `
                                <p><strong>UID:</strong> ${user.uid}</p>
                                <p><strong>이메일:</strong> ${user.email}</p>
                                <p><strong>이름:</strong> ${userData.name || 'N/A'}</p>
                                <p><strong>타입:</strong> ${userData.type || 'N/A'}</p>
                                <p><strong>상태:</strong> ${userData.status || 'N/A'}</p>
                                <details>
                                    <summary>전체 데이터 보기</summary>
                                    <pre>${JSON.stringify(userData, null, 2)}</pre>
                                </details>
                            `;
                            log(`사용자 정보 로드 성공: ${user.email}`, 'info');
                        } else {
                            infoEl.innerHTML += '<p>Firestore에 사용자 문서가 없습니다.</p>';
                            log('Firestore에 사용자 문서 없음', 'warning');
                        }
                    })
                    .catch(error => {
                        infoEl.innerHTML += `<p>Firestore 조회 오류: ${error.message}</p>`;
                        log(`Firestore 조회 오류: ${error.message}`, 'error');
                    });
            } else {
                statusEl.className = 'status warning';
                statusEl.textContent = '로그인 안됨';
                infoEl.innerHTML = '<p>로그인된 사용자가 없습니다.</p>';
                log('로그인된 사용자 없음', 'warning');
            }
        }
        
        // 로그아웃
        async function logoutUser() {
            try {
                await auth.signOut();
                log('로그아웃 성공', 'info');
                refreshUserInfo();
            } catch (error) {
                log(`로그아웃 오류: ${error.message}`, 'error');
            }
        }
        
        // 데이터베이스 상태 확인
        async function checkDatabaseStatus() {
            const statusEl = document.getElementById('dbStatus');
            const tableBody = document.getElementById('dbStatusTable');
            
            try {
                const collections = ['users', 'spaces', 'jobs', 'pendingApprovals', 'config'];
                const results = [];
                
                for (const collection of collections) {
                    try {
                        const snapshot = await db.collection(collection).limit(1).get();
                        const count = await db.collection(collection).get().then(snap => snap.size);
                        results.push({
                            name: collection,
                            count: count,
                            status: 'success',
                            message: '정상'
                        });
                        log(`${collection} 컬렉션: ${count}개 문서`, 'info');
                    } catch (error) {
                        results.push({
                            name: collection,
                            count: 0,
                            status: 'error',
                            message: error.code || '접근 불가'
                        });
                        log(`${collection} 컬렉션 오류: ${error.message}`, 'error');
                    }
                }
                
                statusEl.className = 'status success';
                statusEl.textContent = '확인 완료';
                
                tableBody.innerHTML = results.map(r => `
                    <tr>
                        <td>${r.name}</td>
                        <td>${r.count}</td>
                        <td><span class="status ${r.status}">${r.message}</span></td>
                        <td><button class="btn" onclick="viewCollection('${r.name}')">보기</button></td>
                    </tr>
                `).join('');
                
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = '오류';
                tableBody.innerHTML = `<tr><td colspan="4">오류: ${error.message}</td></tr>`;
                log(`데이터베이스 상태 확인 오류: ${error.message}`, 'error');
            }
        }
        
        // 최근 회원가입 목록
        async function loadRecentUsers() {
            const tableBody = document.getElementById('recentUsersTable');
            
            try {
                const snapshot = await db.collection('users')
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();
                
                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="6">회원이 없습니다.</td></tr>';
                    return;
                }
                
                const users = [];
                snapshot.forEach(doc => {
                    users.push({ id: doc.id, ...doc.data() });
                });
                
                tableBody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.name || 'N/A'}</td>
                        <td>${user.email}</td>
                        <td>${user.type || 'N/A'}</td>
                        <td><span class="status ${user.status === 'approved' ? 'success' : 'warning'}">${user.status || 'N/A'}</span></td>
                        <td>${user.createdAt ? new Date(user.createdAt.toDate()).toLocaleString() : 'N/A'}</td>
                        <td>${user.id.substring(0, 8)}...</td>
                    </tr>
                `).join('');
                
                log(`최근 회원가입 ${users.length}명 로드됨`, 'info');
                
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="6">오류: ${error.message}</td></tr>`;
                log(`최근 회원가입 로드 오류: ${error.message}`, 'error');
            }
        }
        
        // 테스트 회원가입
        async function testSignup() {
            const testEmail = `test${Date.now()}@test.com`;
            const testPassword = 'test1234';
            
            log(`테스트 회원가입 시작: ${testEmail}`, 'info');
            
            try {
                const result = await FirebaseAuth.signUp(testEmail, testPassword, {
                    name: '테스트 사용자',
                    phone: '010-1234-5678',
                    type: 'business',
                    businessName: '테스트 사업장',
                    businessType: 'studyroom',
                    businessAddress: '테스트 주소'
                });
                
                if (result.success) {
                    log('테스트 회원가입 성공!', 'info');
                    alert('테스트 회원가입 성공!\n이메일: ' + testEmail);
                    loadRecentUsers();
                } else {
                    log(`테스트 회원가입 실패: ${result.error}`, 'error');
                    alert('테스트 회원가입 실패: ' + result.error);
                }
            } catch (error) {
                log(`테스트 회원가입 오류: ${error.message}`, 'error');
                alert('테스트 회원가입 오류: ' + error.message);
            }
        }
        
        // Firestore 쓰기 테스트
        async function testFirestore() {
            log('Firestore 쓰기 테스트 시작', 'info');
            
            try {
                const testDoc = {
                    test: true,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    message: '테스트 문서'
                };
                
                await db.collection('test').add(testDoc);
                log('Firestore 쓰기 성공!', 'info');
                alert('Firestore 쓰기 테스트 성공!');
            } catch (error) {
                log(`Firestore 쓰기 오류: ${error.message}`, 'error');
                alert('Firestore 쓰기 실패: ' + error.message);
            }
        }
        
        // 권한 확인
        async function checkPermissions() {
            log('권한 확인 시작', 'info');
            
            const tests = [
                { name: 'users 읽기', action: () => db.collection('users').limit(1).get() },
                { name: 'users 쓰기', action: () => db.collection('users').doc('test').set({ test: true }, { merge: true }) },
                { name: 'pendingApprovals 쓰기', action: () => db.collection('pendingApprovals').add({ test: true }) },
                { name: 'config 읽기', action: () => db.collection('config').limit(1).get() }
            ];
            
            for (const test of tests) {
                try {
                    await test.action();
                    log(`✅ ${test.name}: 성공`, 'info');
                } catch (error) {
                    log(`❌ ${test.name}: ${error.code || error.message}`, 'error');
                }
            }
            
            alert('권한 확인 완료! 로그를 확인하세요.');
        }
        
        // 컬렉션 보기
        function viewCollection(collectionName) {
            window.open(`https://console.firebase.google.com/project/${firebase.app().options.projectId}/firestore/data/~2F${collectionName}`, '_blank');
        }
        
        // 테스트 데이터 삭제
        async function clearTestData() {
            if (!confirm('정말로 테스트 데이터를 삭제하시겠습니까?')) return;
            
            log('테스트 데이터 삭제 시작', 'warning');
            
            try {
                // test 컬렉션 삭제
                const testDocs = await db.collection('test').get();
                const deletePromises = testDocs.docs.map(doc => doc.ref.delete());
                await Promise.all(deletePromises);
                
                log(`테스트 문서 ${testDocs.size}개 삭제됨`, 'info');
                alert('테스트 데이터 삭제 완료!');
            } catch (error) {
                log(`테스트 데이터 삭제 오류: ${error.message}`, 'error');
            }
        }
        
        // 페이지 로드 시 실행
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                checkFirebaseStatus();
                refreshUserInfo();
                checkDatabaseStatus();
                loadRecentUsers();
                
                // Auth 상태 변경 감지
                auth.onAuthStateChanged((user) => {
                    log(`Auth 상태 변경: ${user ? user.email : '로그아웃'}`, 'info');
                    refreshUserInfo();
                });
            }, 1000);
        });
    </script>
</body>
</html>