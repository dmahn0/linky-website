<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linky - ë°ì´í„° ê²€ì¦ ë„êµ¬</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <!-- Firebase ì„¤ì • -->
    <script src="firebase-config.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #22c55e;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status.success {
            background: #22c55e;
            color: white;
        }
        
        .status.error {
            background: #ef4444;
            color: white;
        }
        
        .status.warning {
            background: #f59e0b;
            color: white;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .data-table th,
        .data-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .data-table th {
            background: #f0f0f0;
            font-weight: bold;
        }
        
        .btn {
            padding: 10px 20px;
            background: #22c55e;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .btn:hover {
            background: #16a34a;
        }
        
        .btn.danger {
            background: #ef4444;
        }
        
        .btn.danger:hover {
            background: #dc2626;
        }
        
        .log {
            background: #1e293b;
            color: #10b981;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .log .error {
            color: #ef4444;
        }
        
        .log .warning {
            color: #f59e0b;
        }
        
        .log .info {
            color: #3b82f6;
        }
        
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Linky ë°ì´í„° ê²€ì¦ ë„êµ¬</h1>
        
        <!-- Firebase ì—°ê²° ìƒíƒœ -->
        <div class="section">
            <h2>
                ğŸ”¥ Firebase ì—°ê²° ìƒíƒœ
                <span id="firebaseStatus" class="status">í™•ì¸ ì¤‘...</span>
            </h2>
            <div id="firebaseInfo"></div>
        </div>
        
        <!-- í˜„ì¬ ì‚¬ìš©ì ì •ë³´ -->
        <div class="section">
            <h2>
                ğŸ‘¤ í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì
                <span id="userStatus" class="status">í™•ì¸ ì¤‘...</span>
            </h2>
            <div id="currentUserInfo"></div>
            <button class="btn" onclick="refreshUserInfo()">ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn danger" onclick="logoutUser()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        
        <!-- ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ -->
        <div class="section">
            <h2>
                ğŸ’¾ ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ
                <span id="dbStatus" class="status">í™•ì¸ ì¤‘...</span>
            </h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ì»¬ë ‰ì…˜</th>
                        <th>ë¬¸ì„œ ìˆ˜</th>
                        <th>ìƒíƒœ</th>
                        <th>ì•¡ì…˜</th>
                    </tr>
                </thead>
                <tbody id="dbStatusTable">
                    <tr><td colspan="4">ë¡œë”© ì¤‘...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- ìµœê·¼ íšŒì›ê°€ì… ëª©ë¡ -->
        <div class="section">
            <h2>ğŸ“ ìµœê·¼ íšŒì›ê°€ì… (ìµœê·¼ 10ëª…)</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ì´ë¦„</th>
                        <th>ì´ë©”ì¼</th>
                        <th>íƒ€ì…</th>
                        <th>ìƒíƒœ</th>
                        <th>ê°€ì…ì¼</th>
                        <th>UID</th>
                    </tr>
                </thead>
                <tbody id="recentUsersTable">
                    <tr><td colspan="6">ë¡œë”© ì¤‘...</td></tr>
                </tbody>
            </table>
            <button class="btn" onclick="loadRecentUsers()">ìƒˆë¡œê³ ì¹¨</button>
        </div>
        
        <!-- í…ŒìŠ¤íŠ¸ ë„êµ¬ -->
        <div class="section">
            <h2>ğŸ§ª í…ŒìŠ¤íŠ¸ ë„êµ¬</h2>
            <button class="btn" onclick="testSignup()">í…ŒìŠ¤íŠ¸ íšŒì›ê°€ì…</button>
            <button class="btn" onclick="testFirestore()">Firestore ì“°ê¸° í…ŒìŠ¤íŠ¸</button>
            <button class="btn" onclick="checkPermissions()">ê¶Œí•œ í™•ì¸</button>
            <button class="btn danger" onclick="clearTestData()">í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ</button>
        </div>
        
        <!-- ë¡œê·¸ ì½˜ì†” -->
        <div class="section">
            <h2>ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸</h2>
            <div id="logConsole" class="log">
                <div class="info">ë¡œê·¸ ì½˜ì†” ì´ˆê¸°í™”ë¨...</div>
            </div>
            <button class="btn" onclick="clearLogs()">ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>
    </div>
    
    <script>
        // ë¡œê·¸ í•¨ìˆ˜
        function log(message, type = 'info') {
            const logConsole = document.getElementById('logConsole');
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${time}] ${message}`;
            logConsole.appendChild(logEntry);
            logConsole.scrollTop = logConsole.scrollHeight;
            
            // ì½˜ì†”ì—ë„ ì¶œë ¥
            console.log(`[${type}] ${message}`);
        }
        
        function clearLogs() {
            document.getElementById('logConsole').innerHTML = '<div class="info">ë¡œê·¸ ì½˜ì†” ì´ˆê¸°í™”ë¨...</div>';
        }
        
        // Firebase ìƒíƒœ í™•ì¸
        function checkFirebaseStatus() {
            const statusEl = document.getElementById('firebaseStatus');
            const infoEl = document.getElementById('firebaseInfo');
            
            try {
                if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                    statusEl.className = 'status success';
                    statusEl.textContent = 'ì—°ê²°ë¨';
                    
                    const config = firebase.app().options;
                    infoEl.innerHTML = `
                        <p><strong>Project ID:</strong> ${config.projectId}</p>
                        <p><strong>Auth Domain:</strong> ${config.authDomain}</p>
                        <p><strong>API Key:</strong> ${config.apiKey.substring(0, 10)}...</p>
                    `;
                    log('Firebase ì—°ê²° í™•ì¸ë¨', 'info');
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = 'ì—°ê²° ì‹¤íŒ¨';
                    infoEl.innerHTML = '<p>Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>';
                    log('Firebase ì—°ê²° ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = 'ì˜¤ë¥˜';
                infoEl.innerHTML = `<p>ì˜¤ë¥˜: ${error.message}</p>`;
                log(`Firebase ìƒíƒœ í™•ì¸ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // í˜„ì¬ ì‚¬ìš©ì ì •ë³´
        function refreshUserInfo() {
            const statusEl = document.getElementById('userStatus');
            const infoEl = document.getElementById('currentUserInfo');
            
            const user = auth.currentUser;
            if (user) {
                statusEl.className = 'status success';
                statusEl.textContent = 'ë¡œê·¸ì¸ë¨';
                
                // Firestoreì—ì„œ ì¶”ê°€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                db.collection('users').doc(user.uid).get()
                    .then(doc => {
                        if (doc.exists) {
                            const userData = doc.data();
                            infoEl.innerHTML = `
                                <p><strong>UID:</strong> ${user.uid}</p>
                                <p><strong>ì´ë©”ì¼:</strong> ${user.email}</p>
                                <p><strong>ì´ë¦„:</strong> ${userData.name || 'N/A'}</p>
                                <p><strong>íƒ€ì…:</strong> ${userData.type || 'N/A'}</p>
                                <p><strong>ìƒíƒœ:</strong> ${userData.status || 'N/A'}</p>
                                <details>
                                    <summary>ì „ì²´ ë°ì´í„° ë³´ê¸°</summary>
                                    <pre>${JSON.stringify(userData, null, 2)}</pre>
                                </details>
                            `;
                            log(`ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì„±ê³µ: ${user.email}`, 'info');
                        } else {
                            infoEl.innerHTML += '<p>Firestoreì— ì‚¬ìš©ì ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                            log('Firestoreì— ì‚¬ìš©ì ë¬¸ì„œ ì—†ìŒ', 'warning');
                        }
                    })
                    .catch(error => {
                        infoEl.innerHTML += `<p>Firestore ì¡°íšŒ ì˜¤ë¥˜: ${error.message}</p>`;
                        log(`Firestore ì¡°íšŒ ì˜¤ë¥˜: ${error.message}`, 'error');
                    });
            } else {
                statusEl.className = 'status warning';
                statusEl.textContent = 'ë¡œê·¸ì¸ ì•ˆë¨';
                infoEl.innerHTML = '<p>ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                log('ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì—†ìŒ', 'warning');
            }
        }
        
        // ë¡œê·¸ì•„ì›ƒ
        async function logoutUser() {
            try {
                await auth.signOut();
                log('ë¡œê·¸ì•„ì›ƒ ì„±ê³µ', 'info');
                refreshUserInfo();
            } catch (error) {
                log(`ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ í™•ì¸
        async function checkDatabaseStatus() {
            const statusEl = document.getElementById('dbStatus');
            const tableBody = document.getElementById('dbStatusTable');
            
            try {
                const collections = ['users', 'spaces', 'jobs', 'pendingApprovals', 'config'];
                const results = [];
                
                for (const collection of collections) {
                    try {
                        const snapshot = await db.collection(collection).limit(1).get();
                        const count = await db.collection(collection).get().then(snap => snap.size);
                        results.push({
                            name: collection,
                            count: count,
                            status: 'success',
                            message: 'ì •ìƒ'
                        });
                        log(`${collection} ì»¬ë ‰ì…˜: ${count}ê°œ ë¬¸ì„œ`, 'info');
                    } catch (error) {
                        results.push({
                            name: collection,
                            count: 0,
                            status: 'error',
                            message: error.code || 'ì ‘ê·¼ ë¶ˆê°€'
                        });
                        log(`${collection} ì»¬ë ‰ì…˜ ì˜¤ë¥˜: ${error.message}`, 'error');
                    }
                }
                
                statusEl.className = 'status success';
                statusEl.textContent = 'í™•ì¸ ì™„ë£Œ';
                
                tableBody.innerHTML = results.map(r => `
                    <tr>
                        <td>${r.name}</td>
                        <td>${r.count}</td>
                        <td><span class="status ${r.status}">${r.message}</span></td>
                        <td><button class="btn" onclick="viewCollection('${r.name}')">ë³´ê¸°</button></td>
                    </tr>
                `).join('');
                
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = 'ì˜¤ë¥˜';
                tableBody.innerHTML = `<tr><td colspan="4">ì˜¤ë¥˜: ${error.message}</td></tr>`;
                log(`ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // ìµœê·¼ íšŒì›ê°€ì… ëª©ë¡
        async function loadRecentUsers() {
            const tableBody = document.getElementById('recentUsersTable');
            
            try {
                const snapshot = await db.collection('users')
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();
                
                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="6">íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }
                
                const users = [];
                snapshot.forEach(doc => {
                    users.push({ id: doc.id, ...doc.data() });
                });
                
                tableBody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.name || 'N/A'}</td>
                        <td>${user.email}</td>
                        <td>${user.type || 'N/A'}</td>
                        <td><span class="status ${user.status === 'approved' ? 'success' : 'warning'}">${user.status || 'N/A'}</span></td>
                        <td>${user.createdAt ? new Date(user.createdAt.toDate()).toLocaleString() : 'N/A'}</td>
                        <td>${user.id.substring(0, 8)}...</td>
                    </tr>
                `).join('');
                
                log(`ìµœê·¼ íšŒì›ê°€ì… ${users.length}ëª… ë¡œë“œë¨`, 'info');
                
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="6">ì˜¤ë¥˜: ${error.message}</td></tr>`;
                log(`ìµœê·¼ íšŒì›ê°€ì… ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // í…ŒìŠ¤íŠ¸ íšŒì›ê°€ì…
        async function testSignup() {
            const testEmail = `test${Date.now()}@test.com`;
            const testPassword = 'test1234';
            
            log(`í…ŒìŠ¤íŠ¸ íšŒì›ê°€ì… ì‹œì‘: ${testEmail}`, 'info');
            
            try {
                const result = await FirebaseAuth.signUp(testEmail, testPassword, {
                    name: 'í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì',
                    phone: '010-1234-5678',
                    type: 'business',
                    businessName: 'í…ŒìŠ¤íŠ¸ ì‚¬ì—…ì¥',
                    businessType: 'studyroom',
                    businessAddress: 'í…ŒìŠ¤íŠ¸ ì£¼ì†Œ'
                });
                
                if (result.success) {
                    log('í…ŒìŠ¤íŠ¸ íšŒì›ê°€ì… ì„±ê³µ!', 'info');
                    alert('í…ŒìŠ¤íŠ¸ íšŒì›ê°€ì… ì„±ê³µ!\nì´ë©”ì¼: ' + testEmail);
                    loadRecentUsers();
                } else {
                    log(`í…ŒìŠ¤íŠ¸ íšŒì›ê°€ì… ì‹¤íŒ¨: ${result.error}`, 'error');
                    alert('í…ŒìŠ¤íŠ¸ íšŒì›ê°€ì… ì‹¤íŒ¨: ' + result.error);
                }
            } catch (error) {
                log(`í…ŒìŠ¤íŠ¸ íšŒì›ê°€ì… ì˜¤ë¥˜: ${error.message}`, 'error');
                alert('í…ŒìŠ¤íŠ¸ íšŒì›ê°€ì… ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        // Firestore ì“°ê¸° í…ŒìŠ¤íŠ¸
        async function testFirestore() {
            log('Firestore ì“°ê¸° í…ŒìŠ¤íŠ¸ ì‹œì‘', 'info');
            
            try {
                const testDoc = {
                    test: true,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    message: 'í…ŒìŠ¤íŠ¸ ë¬¸ì„œ'
                };
                
                await db.collection('test').add(testDoc);
                log('Firestore ì“°ê¸° ì„±ê³µ!', 'info');
                alert('Firestore ì“°ê¸° í…ŒìŠ¤íŠ¸ ì„±ê³µ!');
            } catch (error) {
                log(`Firestore ì“°ê¸° ì˜¤ë¥˜: ${error.message}`, 'error');
                alert('Firestore ì“°ê¸° ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        // ê¶Œí•œ í™•ì¸
        async function checkPermissions() {
            log('ê¶Œí•œ í™•ì¸ ì‹œì‘', 'info');
            
            const tests = [
                { name: 'users ì½ê¸°', action: () => db.collection('users').limit(1).get() },
                { name: 'users ì“°ê¸°', action: () => db.collection('users').doc('test').set({ test: true }, { merge: true }) },
                { name: 'pendingApprovals ì“°ê¸°', action: () => db.collection('pendingApprovals').add({ test: true }) },
                { name: 'config ì½ê¸°', action: () => db.collection('config').limit(1).get() }
            ];
            
            for (const test of tests) {
                try {
                    await test.action();
                    log(`âœ… ${test.name}: ì„±ê³µ`, 'info');
                } catch (error) {
                    log(`âŒ ${test.name}: ${error.code || error.message}`, 'error');
                }
            }
            
            alert('ê¶Œí•œ í™•ì¸ ì™„ë£Œ! ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        }
        
        // ì»¬ë ‰ì…˜ ë³´ê¸°
        function viewCollection(collectionName) {
            window.open(`https://console.firebase.google.com/project/${firebase.app().options.projectId}/firestore/data/~2F${collectionName}`, '_blank');
        }
        
        // í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ
        async function clearTestData() {
            if (!confirm('ì •ë§ë¡œ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            log('í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ ì‹œì‘', 'warning');
            
            try {
                // test ì»¬ë ‰ì…˜ ì‚­ì œ
                const testDocs = await db.collection('test').get();
                const deletePromises = testDocs.docs.map(doc => doc.ref.delete());
                await Promise.all(deletePromises);
                
                log(`í…ŒìŠ¤íŠ¸ ë¬¸ì„œ ${testDocs.size}ê°œ ì‚­ì œë¨`, 'info');
                alert('í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ ì™„ë£Œ!');
            } catch (error) {
                log(`í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                checkFirebaseStatus();
                refreshUserInfo();
                checkDatabaseStatus();
                loadRecentUsers();
                
                // Auth ìƒíƒœ ë³€ê²½ ê°ì§€
                auth.onAuthStateChanged((user) => {
                    log(`Auth ìƒíƒœ ë³€ê²½: ${user ? user.email : 'ë¡œê·¸ì•„ì›ƒ'}`, 'info');
                    refreshUserInfo();
                });
            }, 1000);
        });
    </script>
</body>
</html>