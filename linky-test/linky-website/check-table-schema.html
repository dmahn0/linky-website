<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>테이블 스키마 확인</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #22c55e;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #16a34a;
        }
        .result {
            background: #f3f4f6;
            padding: 15px;
            margin-top: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f3f4f6;
            font-weight: bold;
        }
        .error {
            color: #ef4444;
        }
        .success {
            color: #16a34a;
        }
    </style>
</head>
<body>
    <h1>📊 Supabase 테이블 스키마 확인</h1>

    <div class="section">
        <h2>1. Users 테이블 구조 확인</h2>
        <button onclick="checkTableSchema()">테이블 스키마 조회</button>
        <button onclick="getSampleData()">샘플 데이터 조회</button>
        <div id="schemaResult" class="result"></div>
    </div>

    <div class="section">
        <h2>2. 최소 필수 데이터로 테스트</h2>
        <button onclick="testMinimalInsert()">최소 데이터 삽입 테스트</button>
        <div id="minimalResult" class="result"></div>
    </div>

    <div class="section">
        <h2>3. 단계별 필드 테스트</h2>
        <button onclick="testFieldByField()">필드별 테스트 실행</button>
        <div id="fieldResult" class="result"></div>
    </div>

    <script>
        // Supabase 초기화
        const supabaseUrl = 'https://mzihuflrbspvyjknxlad.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16aWh1ZmxyYnNwdnlqa254bGFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4MTk3ODgsImV4cCI6MjA2ODM5NTc4OH0.UDwv6eknjWwmbZ9WsRioi3J23_1az9O1pJFlnKgQ88s';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

        // 테이블 스키마 확인
        async function checkTableSchema() {
            const result = document.getElementById('schemaResult');
            result.innerHTML = '조회 중...';
            
            try {
                // 빈 쿼리로 에러 유발하여 스키마 정보 얻기
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .limit(1);
                
                if (data && data.length > 0) {
                    const columns = Object.keys(data[0]);
                    result.innerHTML = '<h3>Users 테이블 컬럼:</h3>';
                    result.innerHTML += '<table>';
                    result.innerHTML += '<tr><th>컬럼명</th><th>샘플 값</th><th>타입</th></tr>';
                    
                    columns.forEach(col => {
                        const value = data[0][col];
                        const type = Array.isArray(value) ? 'array' : typeof value;
                        result.innerHTML += `<tr><td>${col}</td><td>${JSON.stringify(value)}</td><td>${type}</td></tr>`;
                    });
                    
                    result.innerHTML += '</table>';
                } else {
                    result.innerHTML = '데이터가 없습니다. 빈 테이블일 수 있습니다.';
                }
                
            } catch (error) {
                result.innerHTML = `<span class="error">오류: ${error.message}</span>`;
            }
        }

        // 샘플 데이터 조회
        async function getSampleData() {
            const result = document.getElementById('schemaResult');
            result.innerHTML = '조회 중...';
            
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('type', 'partner')
                    .limit(3);
                
                if (error) throw error;
                
                result.innerHTML = '<h3>파트너 사용자 샘플 (최대 3개):</h3>';
                result.innerHTML += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                
            } catch (error) {
                result.innerHTML = `<span class="error">오류: ${error.message}</span>`;
            }
        }

        // 최소 데이터 삽입 테스트
        async function testMinimalInsert() {
            const result = document.getElementById('minimalResult');
            result.innerHTML = '테스트 중...';
            
            const testEmail = `test_${Date.now()}@example.com`;
            
            try {
                // 1. Auth 사용자 생성
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email: testEmail,
                    password: 'test123456'
                });
                
                if (authError) throw authError;
                
                result.innerHTML = '✅ Auth 사용자 생성 성공\n';
                result.innerHTML += `사용자 ID: ${authData.user.id}\n\n`;
                
                // 2. 최소 필수 필드만으로 시도
                const minimalData = {
                    uid: authData.user.id,
                    email: testEmail,
                    name: '테스트',  // name은 NOT NULL
                    type: 'partner'
                };
                
                result.innerHTML += '최소 데이터로 삽입 시도:\n';
                result.innerHTML += JSON.stringify(minimalData, null, 2) + '\n\n';
                
                const { error: dbError } = await supabaseClient
                    .from('users')
                    .insert([minimalData]);
                
                if (dbError) {
                    result.innerHTML += `<span class="error">❌ 실패: ${dbError.message}</span>\n`;
                    result.innerHTML += `상세: ${JSON.stringify(dbError, null, 2)}`;
                } else {
                    result.innerHTML += '<span class="success">✅ 성공! 최소 필드: uid, email, type</span>';
                }
                
            } catch (error) {
                result.innerHTML += `<span class="error">오류: ${error.message}</span>`;
            }
        }

        // 필드별 테스트
        async function testFieldByField() {
            const result = document.getElementById('fieldResult');
            result.innerHTML = '테스트 중...\n';
            
            const testEmail = `test_${Date.now()}@example.com`;
            
            try {
                // Auth 사용자 생성
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email: testEmail,
                    password: 'test123456'
                });
                
                if (authError) throw authError;
                
                const baseData = {
                    uid: authData.user.id,
                    email: testEmail,
                    type: 'partner'
                };
                
                // 테스트할 필드들
                const testFields = [
                    { name: 'name', value: '테스트 사용자' },
                    { name: 'phone', value: '010-1234-5678' },
                    { name: 'status', value: 'approved' },
                    { name: 'created_at', value: new Date().toISOString() },
                    { name: 'realName', value: '실명' },
                    { name: 'residence', value: '서울시' },
                    { name: 'workAreas', value: ['강남구'] },
                    { name: 'transportation', value: 'public' }
                ];
                
                result.innerHTML = '필드별 테스트 결과:\n\n';
                
                for (const field of testFields) {
                    const testData = { ...baseData, [field.name]: field.value };
                    
                    try {
                        const { error } = await supabaseClient
                            .from('users')
                            .insert([testData]);
                        
                        if (error) {
                            result.innerHTML += `❌ ${field.name}: 실패 - ${error.message}\n`;
                        } else {
                            result.innerHTML += `✅ ${field.name}: 성공\n`;
                        }
                        
                        // 삽입한 데이터 삭제 (정리)
                        await supabaseClient
                            .from('users')
                            .delete()
                            .eq('uid', authData.user.id);
                        
                    } catch (e) {
                        result.innerHTML += `❌ ${field.name}: 오류 - ${e.message}\n`;
                    }
                }
                
            } catch (error) {
                result.innerHTML += `<span class="error">오류: ${error.message}</span>`;
            }
        }
    </script>
</body>
</html>